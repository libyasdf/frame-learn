<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">

    <title>企业中心</title>
    <!-- Bootstrap -->
    <link href="../../static/core/bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- style.css -->
    <link href="../../static/css/common/style.css" rel="stylesheet">
    <link href="../../static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="modal-body selectjs">
    <div class="col-sm-6 ">
        <div class="selectjs_block">
            <div class="title_tab">
                <ul class="nav nav-tabs">
                    <li class="active" for="tree-obj">
                        <a href="#" data-toggle="tab" class="">
                            按部门选择
                        </a>
                    </li>
                    <li for="group-obj">
                        <a href="#" data-toggle="tab">
                            按群组选择
                        </a>
                    </li>
                </ul>
            </div>
            <div class="main">
                <div class="left_search_area">
                    <div class="input-group">
                        <input id="keyword" onkeydown="CommonUtil.keyDown(event);" type="text" class="form-control"
                               placeholder="快速搜索">
                        <span class="input-group-btn">
    						<button class="btn btn-default" type="button" id="search-bt">
    							<span class="glyphicon glyphicon-search" aria-hidden="true"></span>
    						</button>
					    </span>
                    </div>
                </div>
                <div class="left_tree_area">
                    <ul id="tree-obj" class="ztree"></ul>
                    <ul id="group-obj" class="ztree hidden"></ul>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6">
        <div class="selectjs_block">
            <div class="title">已选择</div>
            <div class="main">
                <ul class="right_del_list" style="height: 100%;overflow-y: auto;">

                </ul>
            </div>

        </div>
    </div>
    <div class="clearfix"></div>
</div>
<div class="modal-footer" style="text-align: center">
    <button type="button" class="btn btn-primary  btn-blue  bigbtn" id="close">
        确&nbsp;&nbsp;定
    </button>
</div>
<input name="id" type="hidden" id="id" />
<input name="name" type="hidden" id="name" />
<input name="idContext" type="hidden" id="idContext" />
<input name="nameContext" type="hidden" id="nameContext" />
<input name="mark" type="hidden" id="mark" />
<script src="../../static/core/jquery/jquery-1.11.2.min.js"></script>
<script src="../../static/core/zTree_v3/js/jquery.ztree.core.js"></script>
<script src="../../static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="../../static/core/zTree_v3/js/jquery.ztree.exhide.js"></script>
<script type="text/javascript">

    /**
     * 注意这是zTree3.5版本，API必须在3.0版本以上，以下的版本API不对
     * @type {Array}
     */
    var deptZtree = function(){
        var hiddenNodes = [];
        var zTreeObj = null;
        var zNodes = null;

        //ztree配置选项
        var setting = {     
            callback: {
                onDblClick: function(){
                    // CommonUtil.zTreeOnDblclick();
                },
                onCheck : function(event, treeId, treeNode){
                    CommonUtil.zTreeOnCheck(event, treeId, treeNode);
                }
            },
            data: {
                key: {
                    name: "name",
                    title: "name"
                },
                simpleData: {
                    idKey: "id",
                }
            },
            check: {
                enable: true,
                autoCheckTrigger: true,
                chkStyle: "checkbox"
            }
        };

        // 加载数据
        var loadData = function(){
            // 这行可以获取当前用户的父部门及父部门中的人员，
            // 和本部门、子部门和本部门和子部门的人员，但不会显示同级部门
//            $.getJSON("/tree/getTreeOnlyParentAndChild", function(data){
            $.getJSON("/mock/ztree.json", function(data){
                zTreeObj = $.fn.zTree.init($("#tree-obj"), setting, data);
                CommonUtil.echoData(zTreeObj);
            })

        }

        /**
         * 过滤
         * @return {[type]} [description]
         */
        var filter = function() {
            //显示上次搜索后背隐藏的结点
            zTreeObj.showNodes(hiddenNodes);

            //查找不符合条件的叶子节点
            function filterFunc(node) {
                var _keywords = $("#keyword").val();
                if (node.isParent || node.name.indexOf(_keywords) != -1) return false;
                return true;
            };

            //获取不符合条件的叶子结点
            hiddenNodes = zTreeObj.getNodesByFilter(filterFunc);

            //隐藏不符合条件的叶子结点
            zTreeObj.hideNodes(hiddenNodes);
        };

        return {
            init:function(){
                loadData();
            },
            filter:function(){
                filter();
            },
            getZTreeObj:function(){
                return zTreeObj;
            }
        }
    }();

    var groupZtree = function(){
        var hiddenNodes = [];
        var zTreeObj = null;
        var zNodes = null;

        //ztree配置选项
        var setting = {     
            callback: {
                onDblClick: function(){
                    // CommonUtil.zTreeOnDblclick();
                },
                onCheck : function(event, treeId, treeNode){
                    CommonUtil.zTreeOnCheck(event, treeId, treeNode);
                }
            },
            data: {
                key: {
                    name: "name",
                    title: "name"
                },
                simpleData: {
                    idKey: "id",
                }
            },
            check: {
                enable: true,
                autoCheckTrigger: true,
                chkStyle: "checkbox"
            }
        };

        // 加载数据
        var loadData = function(){
            $.getJSON("/mock/ztree1.json", function(data){
                zTreeObj = $.fn.zTree.init($("#group-obj"), setting, data);
                CommonUtil.echoData(zTreeObj);
            })

        }

        /**
         * 过滤
         * @return {[type]} [description]
         */
        var filter = function() {
            //显示上次搜索后背隐藏的结点
            zTreeObj.showNodes(hiddenNodes);

            //查找不符合条件的叶子节点
            function filterFunc(node) {
                var _keywords = $("#keyword").val();
                if (node.isParent || node.name.indexOf(_keywords) != -1) return false;
                return true;
            };

            //获取不符合条件的叶子结点
            hiddenNodes = zTreeObj.getNodesByFilter(filterFunc);

            //隐藏不符合条件的叶子结点
            zTreeObj.hideNodes(hiddenNodes);
        };

        return {
            init:function(){
                loadData();
            },
            filter:function(){
                filter();
            },
            getZTreeObj:function(){
                return zTreeObj;
            }
        }
    }();


    var CommonUtil = {
        /**
         * 回显数据
         * @return {[type]} [description]
         */
        echoData:function(zTreeObj){
            var ids = $("#idContext").val();
            var treeNodes = zTreeObj.getNodes();
            var nodes = zTreeObj.transformToArray(treeNodes);
            if(ids){
                var idArr = ids.split(",");
                for(var i=0;i<nodes.length;i++){
                    for(var j=0;j<idArr.length;j++){
                        if(idArr[j] == nodes[i].id){
                            var node = zTreeObj.getNodeByTId(nodes[i].tId);
                            zTreeObj.checkNode(node,true,true);
                        }
                    }
                }
            }
        },
        zTreeOnCheck:function(event, treeId, treeNode){
            var id ="" , node = null , node_g =null;
            /**** 如果在部门树中改变勾选状态同时也在群组树修改勾选状态  ****/
            //如果是取消
            if(treeNode && !treeNode.isParent && !treeNode.checked){
                id = treeNode.id;
                node = deptZtree.getZTreeObj().getNodeByParam("id",id,null);
                if(node){
                    deptZtree.getZTreeObj().checkNode(node,false,true);
                }
                node_g = groupZtree.getZTreeObj().getNodeByParam("id",id,null);
                if(node_g){
                	groupZtree.getZTreeObj().checkNode(node_g,false,true);
                }
            }
			//选中
            if(treeNode && !treeNode.isParent && treeNode.checked){
                id = treeNode.id;
                node = deptZtree.getZTreeObj().getNodeByParam("id",id,null);
                if(node){
                    deptZtree.getZTreeObj().checkNode(node,true,true);
                }
                node_g = groupZtree.getZTreeObj().getNodeByParam("id",id,null);
                if(node_g){
                     groupZtree.getZTreeObj().checkNode(node_g,true,true);
                }
            }


            var deptNodes = [], groupNodes = [], nodes = {}, nodeHtml = [];
            if(deptZtree.getZTreeObj()){
                deptNodes = deptZtree.getZTreeObj().getCheckedNodes(true);
            }
            if(groupZtree.getZTreeObj()){
                groupNodes = groupZtree.getZTreeObj().getCheckedNodes(true);
            }
            for(var i=0;i< deptNodes.length;i++){
                if(!deptNodes[i].isParent){
                    nodes[deptNodes[i].id] = {
                        "id": deptNodes[i].id,
                        "name": deptNodes[i].name
                    }
                }
            }
            for(var j=0;j< groupNodes.length;j++){
                if(!groupNodes[j].isParent){
                    nodes[groupNodes[j].id] = {
                        "id":groupNodes[j].id,
                        "name": groupNodes[j].name
                    }
                }
            }
            for(var item in nodes){
                nodeHtml.push(CommonUtil.joinHtml(item,nodes[item].name)) 
            }
            if(nodeHtml.length > 0){
                $('.right_del_list').empty().append(nodeHtml.join(''));
                 $('.right_del_list li').find('img').unbind('click').bind('click',function(){
                    var obj = $(this).parents('li');
                    var id = $(obj).attr('id')
                    $(obj).remove();
                    if(deptZtree.getZTreeObj){
                        var node = deptZtree.getZTreeObj().getNodeByParam("id",id,null);
                        deptZtree.getZTreeObj().checkNode(node,false,true)
                    }
                    if(groupZtree.getZTreeObj){
                        var node = groupZtree.getZTreeObj().getNodeByParam("id",id,null);
                        groupZtree.getZTreeObj().checkNode(node,false,true)
                    }
                 })
            }else{
                $('.right_del_list').empty();
            }

        },
        zTreeOnDblclick:function(event, treeId, treeNode){
            if (treeNode != null && !treeNode.isParent) {
                var html = joinHtml(treeNode.id, treeNode.name);
                if($('.right_del_list').find('li#'+treeNode.id).length == 0){
                     $('.right_del_list').append(html);
                }else{
                    console.log('节点以添加,不可重复添加');
                }
               
                CommontUtil.deleteElement();
            }
        },
        /**
         * 回显右侧用户选择的数据
         * @return {[type]} [description]
         */
        eachSelectData:function(){
            var idsStr = $("#idContext").val();
            var namesStr = $("#nameContext").val();
            var ids = [], names = [], html = [];
            if(idsStr){
                ids = idsStr.split(",");
                names = namesStr.split(",");
                for(var i=0; i<ids.length;i++){
                    html.push(CommonUtil.joinHtml(ids[i],names[i]));
                }
                $('.right_del_list').append(html.join(''));

                // 添加删除
                CommonUtil.deleteElement();
            }
        },
        bindFun:function(){
            /**
             * tab 切换
             */
            $('.nav-tabs > li').unbind('click').bind('click', function () {
                var id = $(this).attr('for');
                $(this).addClass('active').siblings('li').removeClass('active');
                $('.left_tree_area').children().addClass('hidden');
                $('#' + id).removeClass('hidden');

                if (id == "tree-obj") {
                    $("#search-bt").unbind('click').bind('click', function () {
                        deptZtree.filter();
                    });
                } else {
                    $("#search-bt").unbind('click').bind('click', function () {
                        groupZtree.filter();
                    });
                }
            });

            /**
             *
             * 确定按钮事件
             */
             $("#close").unbind('click').bind('click', function () {
                var ids = [], names = [], id = "", name = "", mark="";
                //先得到当前iframe层的索引
                var index = parent.layer.getFrameIndex(window.name);
                var parentBody = $("body",parent.document);

                // 回显数据
                $('.right_del_list li').each(function(i,item){
                    ids.push($(this).attr('id'))
                    names.push($(this).text())
                })

                mark = $('#mark').val();
                id = $('#id').val();
                name = $('#name').val();

                if($('#mark').val() != ""){
                    var html = CommonUtil.joinBorderHtml(ids,names,id,name);
                    parentBody.find('#'+mark).empty().append(html);
                    parentBody.find('#'+id).val(ids.join(','))
                    parentBody.find('#'+name).val(names.join(','));
                }else{
                     parentBody.find('#'+id).val(ids.join(','))
                     parentBody.find('#'+name).val(names.join(','))
                }

                //关闭窗口
                parent.layer.close(index);            

            })

        },
        keyDown:function(){
             var ev = window.event || e;
            //13是键盘上面固定的回车键
            if (ev.keyCode == 13) {
                //你要执行的方法
                if($(".nav-tabs").find('.active').attr('for') == "tree-obj"){
                    deptZtree.filter();
                }else{
                    groupZtree.filter();
                }
                
            }
        },
        /**
         * 拼接字符串
         * @return {[type]} [description]
         */
        joinHtml:function(id,name){
            var html = [];
            html.push('<li id="' + id + '">');
            html.push('<span class="pull-right">');
            html.push('');
            html.push('<img src="../../static/images/ico_del2.png" width="24" height="24" alt=""/>');
            html.push('');
            html.push('</span>' + name + '');
            html.push('</li>');
            return html.join('');
        },
        joinBorderHtml:function(ids,names,id,name){
            var html = [];
            html.push('<ol>');
            for(var i=0; i<ids.length; i++){
                html.push('<li class="item" id="'+ids[i]+'" > ');
                html.push(names[i]+'<span forId="'+id+'" forName="'+name+'" onclick="deleteThisNode(this)" class="glyphicon glyphicon-remove"></span>');
                html.push('</li>');
            }
            html.push('</ol>');
            return html.join('');
        },
        deleteElement:function(){
             $('.right_del_list li img').unbind('click').bind('click', function () {
                $(this).parents('li').remove();
            })
        }
    }

</script>
</body>
</html>