<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">

    <title>企业中心</title>
    <!-- Bootstrap -->
    <link href="/static/core/bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- style.css -->
    <link href="/static/css/common/style.css" rel="stylesheet">
    <link href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/core/mCustomScrollbar/jquery.mCustomScrollbar.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        .list-group-item .pull-right {
            cursor: pointer;
        }
    </style>
</head>

<body>
<div class="modal-body selectjs">
    <div class="col-sm-6 ">
        <div class="selectjs_block">
            <div class="title_tab">
                <ul class="nav nav-tabs">
                    <li class="active" for="tree-obj">
                        <a href="#" data-toggle="tab" class="">
                            按人员组选择
                        </a>
                    </li>
                </ul>
            </div>
            <div class="main">
                <!--<div class="left_search_area">
                    <div class="input-group">
                        <input id="keyword" name="deptName" onkeydown="CommonUtil.keyDown(event);" type="text"
                               class="form-control" placeholder="快速搜索">
                        <span class="input-group-btn">
                                <button class="btn btn-default" type="button" id="search-bt">
                                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                                </button>
                            </span>
                    </div>
                </div>-->
                <div class="left_tree_area">
                    <ul id="tree-obj" class="ztree"></ul>
                    <!-- <ul id="group-obj" class="ztree hidden"></ul> -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6">
        <div class="selectjs_block">
            <div class="title">已选择</div>
            <div class="main" id="selectedDeptUser">
                <ul class="right_del_list" style="height: 100%;overflow-y: auto;">

                </ul>
            </div>

        </div>
    </div>
    <div class="clearfix"></div>
</div>
<div class="modal-footer" style="text-align: center">
    <button type="button" class="btn btn-primary  btn-blue  bigbtn" id="close">
        确&nbsp;&nbsp;定
    </button>
</div>
<input name="id" type="hidden" id="id" />
<input name="name" type="hidden" id="name" />
<input name="idContext" type="hidden" id="idContext" />
<input name="nameContext" type="hidden" id="nameContext" />
<input name="groupid" type="hidden" id="groupid" />
<input name="groupname" type="hidden" id="groupname" />
<input name="typeCode" type="hidden" id="typeCode" />
<input name="grupidContext" type="hidden" id="grupidContext" />
<input name="grupnameContext" type="hidden" id="grupnameContext" />
<input name="treeidContext" type="hidden" id="treeidContext" />
<input name="mark" type="hidden" id="mark" />
<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.core.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="/static/core/zTree_v3/js/jquery.ztree.exhide.js"></script>
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
<script src="/static/core/layer/layer.js"></script>
<script src="/static/core/mCustomScrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
<script type="text/javascript">

    // 左右侧滚动条修改
    $('.left_tree_area').mCustomScrollbar({
        theme: 'dark-3',
        mouseWheelPixels: 300,
        scrollButtons: {
            enable: true
        }
    });
    $('#selectedDeptUser')
        .find('.right_del_list').css('overflow-y', 'visible').end()
        .css('overflow-y', 'auto')
        .mCustomScrollbar({
            theme: 'minimal-dark',
            mouseWheelPixels: 300
        });
    $('.mCSB_scrollTools .mCSB_dragger .mCSB_dragger_bar').css('width', '6px');

    var theRequest = GetRequest();
    var resId = theRequest.resId;
    var url = theRequest.url;
    var subId = theRequest.subId;
    var check = theRequest.check;
    var cancle = theRequest.cancle;

    /**
     * 注意这是zTree3.5版本，API必须在3.0版本以上，以下的版本API不对
     * @type {Array}
     */
    var groupZtree = function () {
        var hiddenNodes = [];
        var zTreeObj = null;
        var zNodes = null;
        //ztree配置选项
        var setting = {
            data: {
                simpleData: {
                    enable: true,
                    idKey: "id",
                    pIdKey: "pid",
                    rootPId: 0
                }
            },
            callback: {
                onCheck: function (event, treeId, treeNode) {
                    CommonUtil.zTreeOnCheck(event, treeId, treeNode);
                },
                onDblClick: function (event, treeId, treeNode) {
                    CommonUtil.zTreeOnDblclick(event, treeId, treeNode);
                },
            },
            check: {
                enable: true,
                autoCheckTrigger: true,
                chkStyle: "checkbox",
                chkboxType: { "Y": check, "N": cancle }
            }
        };

        // 加载数据
        var loadData = function () {
            debugger;
            console.log("groupUrl" + JSON.stringify(url));
            //获取部门
            $.ajax({
                async: false,
                cache: false,
                type: "get",//请求方式为get
                url: url,
                dataType: "json", //返回数据格式为json
                data: {"subId": subId,"typeCode":$("#typeCode").val() },
                success: function (datas) {
                    console.log("datas" + JSON.stringify(datas));
                    var zNodes = datas;
                    treeNodes = datas;
                    for (var i = 0; i < zNodes.length; i++) {
                        zNodes[i].open = true;
                        zNodes[i].id = zNodes[i].uuid;
                        zNodes[i].pid = zNodes[i].uupid;
                        zNodes[i].nodeType = zNodes[i].type;
                        if (zNodes[i].type == "value") {
                            zNodes[i].icon = "/static/images/user.png";
                        } else if (zNodes[i].type == "key") {
                            zNodes[i].isParent = true;
                            zNodes[i].nocheck = false;
                        }
                    }
                    zTreeObj = $.fn.zTree.init($("#tree-obj"), setting, zNodes);
                    CommonUtil.echoData(zTreeObj);
                },
                error: function (request) {
                    layer.msg("数据加载失败！请刷新重试！", { icon: 2 });
                }
            });

        }
        return {
            init: function () {
                loadData();
            },
            filter: function () {
                filter();
            },
            getZTreeObj: function () {
                return zTreeObj;
            }
        }
    }();

    var CommonUtil = {
        /**
         * 回显数据
         * @return {[type]} [description]
         */
        echoData: function (zTreeObj) {
            debugger;
            var ids = $("#grupidContext").val();
            var treeNodes = zTreeObj.getNodes();
            var nodes = zTreeObj.transformToArray(treeNodes);
            if (ids) {
                var idArr = ids.split(",");
                for (var i = 0; i < nodes.length; i++) {
                    for (var j = 0; j < idArr.length; j++) {
                        if (idArr[j] == nodes[i].id) {
                            var node = zTreeObj.getNodeByTId(nodes[i].tId);
                            zTreeObj.checkNode(node, true, true);
                        }
                    }
                }
            }
        },
        //勾选复选框
        zTreeOnCheck: function (event, treeId, treeNode) {
            debugger;
            var id = "", node = null, node_g = null, nodeHtml = [];
            //如果是取消
            if (treeNode && !treeNode.isParent && !treeNode.checked) {
                id = treeNode.id;
                node = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                if (node) {
                    groupZtree.getZTreeObj().checkNode(node, false, true);
                    $('.right_del_list').find('li').each(function () {
                        if ($(this).attr('id') == node.id) {
                            $(this).remove();
                        }
                    });
                }
            }
            //选中
            if (treeNode && !treeNode.isParent && treeNode.checked) {
                id = treeNode.id;
                node = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                if ($("#" + id).text() == "") {
                    if (node) {
                        groupZtree.getZTreeObj().checkNode(node, true, true);
                        nodeHtml.push(CommonUtil.joinHtml(node.treeid,"", node.name,node.id));
                    }
                }
            }

            var deptNodes = [], nodes = {};
            if (groupZtree.getZTreeObj()) {
                deptNodes = groupZtree.getZTreeObj().getCheckedNodes(true);
            }
            if (nodeHtml.length > 0) {
                $('.right_del_list').append(nodeHtml.join(''));

            }
            $('.right_del_list li').find('img').unbind('click').bind('click', function () {
                var obj = $(this).parents('li');
                var id = $(obj).attr('id')
                $(obj).remove();
                if (groupZtree.getZTreeObj) {
                    var node = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                    groupZtree.getZTreeObj().checkNode(node, false, true)
                }
            })

        },
        //双击节点
        zTreeOnDblclick: function (event, treeId, treeNode) {
            if (treeNode && !treeNode.isParent) {
                if (treeNode.checked) {//如果已经是选中状态了，则取消选中，并在右侧移除
                    id = treeNode.id;
                    node = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                    if (node) {
                        groupZtree.getZTreeObj().checkNode(node, false, true);
                        $('.right_del_list').find('li').each(function () {
                            if ($(this).attr('id') == node.id) {
                                $(this).remove();
                            }
                        });
                    }
                } else {//如果没有选中
                    groupZtree.getZTreeObj().checkNode(treeNode, true, false);
                    var deptNode1 = groupZtree.getZTreeObj().getNodeByParam("id", treeNode.id, null).getParentNode();
                    var html = CommonUtil.joinHtml(treeNode.id,"", treeNode.name, deptNode1.id, deptNode1.name);
                    if ($('.right_del_list').find('li#' + treeNode.id).length == 0) {
                        $('.right_del_list').append(html);
                    } else {
                        console.log('节点已添加,不可重复添加！');
                    }
                }
            }
            $('.right_del_list li').find('img').unbind('click').bind('click', function () {
                var obj = $(this).parents('li');
                var id = $(obj).attr('id')
                $(obj).remove();
                if (groupZtree.getZTreeObj) {
                    var node = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                    groupZtree.getZTreeObj().checkNode(node, false, true)
                }
            })
        },
        /**
         * 回显右侧用户选择的数据
         * @return {[type]} [description]
         */
        eachSelectData: function () {
            debugger;
            var idArray = "";
            var idsStr = $("#idContext").val();
            var namesStr = $("#nameContext").val();
            var grupidsStr = $("#grupidContext").val();
            var ids = [], names = [], html = [], grupids = [];
            if(idsStr.length>0){
                var idstring =idsStr.split(",");
                for(var i=0;i<idstring.length;i++){
                    if(idArray.indexOf(idstring[i])<0){
                        if(i==0){
                            idArray =  idstring[i];
                        }else{
                            idArray = idArray+","+idstring[i];
                        }
                    }
                }

            }
            if (idArray) {
                ids = idArray.split(",");
                names = namesStr.split(",");
                grupids = grupidsStr.split(",");
                for (var i = 0; i < ids.length; i++) {
                    html.push(CommonUtil.joinHtml("",ids[i], names[i], grupids[i]));
                }
                $('.right_del_list').append(html.join(''));

                // 添加删除
                CommonUtil.deleteElement();
            }
        },
        bindFun: function () {
            /**
             *
             * 确定按钮事件
             */
            $("#close").unbind('click').bind('click', function () {
                parent.putBackData2();
            })

        },

        saveSelectedData: function () {
            debugger;
            var ids = [], names = [], res = {}, treeids = [],groupIds="",grupnames=[],grupidstr=[],idstr ="",sysDeptIds =[];
            $('.right_del_list li').each(function (i, item) {
             /*   var id = $(this).attr('id');
                if(groupIds.indexOf(id)<0){
                    groupIds += id+",";
                    var node = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                    ids.push(node.id);
                    names.push(node.name);
                }*/
                var id = $(this).attr('userid');
                var grupids1 = $(this).attr('id');
                if(idstr.indexOf(id)<0){
                    idstr += id+","
                    ids.push($(this).attr('userid'));
                    names.push($(this).attr('userName'));
                    var node = groupZtree.getZTreeObj().getNodeByParam("id", grupids1, null);
                    grupidstr.push(node.id);
                    grupnames.push(node.name);
                }
                sysDeptIds.push($(this).attr('sysDeptId'));
            })
         /*   $('.right_del_list li').each(function (i, item) {
                ids.push($(this).attr('id'));
                names.push($(this).text());
                treeids.push($(this).attr('treeid'));
            })*/
            res.ids = ids.join(",");
            res.names = names.join(",");
            res.grupids = grupidstr.join(",");
            res.grupnames = grupnames.join(",");
            res.treeids = sysDeptIds.join(",");
            if ($('#mark').val() != "") {
                var id = $('#id').val();
                var name = $('#name').val();
                var html = CommonUtil.joinBorderHtml(ids, names, id, name);
                res.mark = html;
            }
            return res;
        },

        keyDown: function () {
            var ev = window.event || arguments[0];
            //13是键盘上面固定的回车键
            if (ev.keyCode == 13) {
                //你要执行的方法
                if ($(".nav-tabs").find('.active').attr('for') == "tree-obj") {
                    groupZtree.filter();
                }
            }
        },
        /**
         * 拼接字符串
         * @return {[type]} [description]
         */
        joinHtml: function (id,userid, name, grupid) {
            var html = [];
            $.ajax({
                async: false,
                cache: false,
                type: "get",//请求方式为get
                url: "/system/noticeGrup/getGroupUser",
                dataType: "json", //返回数据格式为json
                data: {"groupId": grupid ,"userid":userid},
                success: function (datas) {
                    debugger;
                    console.log("datas=" + JSON.stringify(datas));
                    var array = datas.data;
                    if(array.length > 0){
                        for(var i = 0;i<array.length;i++){
                            var userName = array[i].username;
                            var userid = array[i].userid;
                            var noticeid = array[i].id;
                            var sysDeptId = array[i].sysDeptId;
                            var grup_id =array[i].grup_id;
                            html.push('<li id="' + grup_id + '" treeid="' + grupid + '" class="list-group-item" data-id="' + id + '" data-name="' + name + '" userid = "' + userid + '" userName = "' + userName + '" noticeid = "' + noticeid + '"+ sysDeptId = "' + sysDeptId + '">');
                            html.push('<span class="pull-right">');
                            html.push('<img src="/static/images/ico_del2.png"  width="24" height="24" alt=""/>');
                            html.push('</span>' + userName + '');
                            html.push('</li>');
                        }
                    }else{
                        html.push('<li id="' + id + '" treeid="' + grupid + '" class="list-group-item" data-id="' + id + '" data-name="' + name + '">');
                        html.push('<span class="pull-right">');
                        html.push('<img src="/static/images/ico_del2.png"  width="24" height="24" alt=""/>');
                        html.push('</li>');
                    }
                },
                error: function (request) {
                    layer.msg("数据加载失败！请刷新重试！", { icon: 2 });
                }
            })
            return html.join('');
        },
        joinBorderHtml: function (ids, names, id, name) {
            var html = [];
            html.push('<ol>');
            for (var i = 0; i < ids.length; i++) {
                html.push('<li class="item" id="' + ids[i] + '" > ');
                html.push(names[i] + '<span forId="' + id + '" forName="' + name + '" onclick="deleteThisNode(this)" class="glyphicon glyphicon-remove"></span>');
                html.push('</li>');
            }
            html.push('</ol>');
            return html.join('');
        },
        deleteElement: function () {
            $('.right_del_list li img').unbind('click').bind('click', function () {
                $(this).parents('li').remove();
            })
        }
    }
    //@ sourceURL=select.html
</script>
</body>

</html>