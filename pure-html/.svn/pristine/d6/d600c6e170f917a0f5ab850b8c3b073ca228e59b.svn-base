<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">

    <title></title>
    <link rel="stylesheet" href="/static/core/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/core/bootstrapvalidator/dist/css/bootstrapValidator.min.css"/>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="/static/core/html5/html5shiv.min.js"></script>
    <script src="/static/core/html5/respond.js"></script>
    <![endif]-->
    <link href="/static/css/common/style.css" rel="stylesheet"/>
    <link href="/static/css/common/form-public.css" rel="stylesheet"/>
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="/static/core/jquery-fileupload/css/jquery.fileupload.css">
    <link rel="stylesheet" href="/static/font/iconfont.css">
    <link rel="stylesheet" type="text/css"
          href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css">
    <!--<link type="text/css" rel="stylesheet" href="/modules/dagl/xtpz/contrastingrelations/css/metroStyle/metroStyle.css">-->

</head>

<body style="padding-bottom: 5px;">
<div class="container-fluid" >
    <form id="form" class="form-horizontal">
        <!-- resId -->
        <input type="text" id="resId" name="resId" value="" hidden="true">
        <div class="row m-t-15">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="" class="col-md-2 control-label" style="vertical-align: top;padding-top: 3px;"> 序号调整至：</label>
                    <div class="col-md-9" style="display: inline-block">
                        <input type="text" oninput="value=value.replace(/[^\d]/g,'');" class="form-control" placeholder="请录入新的序号" id="newXuHao" name="addCount" autocomplete="off" value="" onblur=buZero()>
                    </div>
                    <div class="col-md-9" style="display: inline-block">
                    	<span style="color:red;font-weight:bold;">注：</span></br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.这里的序号指档号的最后一位档号项。譬如档号为“全宗号-类别号-年度.保管期限-案卷号”，此处应该录入新的案卷号。</br>
                    	<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.调整规则：譬如把案卷号为003的档案的案卷号调整至005，那么同时也会把案卷号为004的档案的案卷号调整至003，把案卷号为005的档案的案卷号调整至004，同时也会调整案卷内的卷内数据。</span>
                    </div>
                </div>
                <!--查询重置等按钮-->
                <div class="form-group">
                    <div class="col-sm-12" style="text-align: center">
                        <button type="button" class="btn btn-primary" onclick="saveData()">
                           	 确&nbsp;&nbsp;定
                        </button>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <button type="button" class="btn btn-primary" onclick="cancel();">
                           	 取&nbsp;&nbsp;消
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!--查询重置等按钮 end-->
    </form>
</div>
<!-- 按钮区结束 -->
<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
<script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
<script src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
<script src="/static/core/layer/layer.js"></script>
<script src="/static/js/common/mylayer.js"></script>
<script type="text/javascript" src="/static/js/common/assistUtil.js"></script>

<script src="/static/core/laydate/laydate.js"></script>
<!-- 流程相关 -->
<script type="text/javascript" src="/common/js/config.js"></script>
<script type="text/javascript" src="/product/workflow/js/storages.js"></script>
<script type="text/javascript" src="/common/js/commonFunction.js"></script>
<!-- <script type="text/javascript" src="/common/js/overlay.js"></script> -->
<!-- 获取cookie值 -->
<script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
<!-- 页面获取参数 -->
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<!-- 自定义意见(最后进行加载) -->
<script type="text/javascript" src="/common/html/notion/notion.js"></script>
<!-- 数据回显 -->
<script type="text/javascript" src="/static/js/common/displayData.js"></script>

<script type="text/javascript" src="/modules/dagl/bmgl/js/common.js"></script>


<script type="text/javascript">

    var fileNumberRule = null; // 档号规则

    $("#form").bootstrapValidator("addField", "addCount", {
        validators: {
            notEmpty : {
                message : '请录入新的序号！'
            }
        }
    });

    var theRequest = GetRequest();
    var tableName = theRequest.tableName;
    var recid = theRequest.recid;
    var categoryCode = theRequest.categoryCode;
    var all = theRequest.all;
    var ranking = theRequest.ranking;

    $(function () {
        // 获取档号规则
        getfileNumberRule();
    });

    // 提交
    function saveData() {
        var bootstrapValidator = $("#form").data('bootstrapValidator');
        //手动触发验证
        bootstrapValidator.validate();
        if(bootstrapValidator.isValid()){
        	layer.confirm("确定要进行调整吗？",{icon:3},function(){
        		var index;
            	index=layer.load(1,{shade: [0.5, '#393D49'],content: '处理中，请稍候~',success: function(layero){
    				layero.find('.layui-layer-content').css({'padding-top':'50px','font-size':'16px','width':'200px','color':'#000000'});
    			}});
            	setTimeout(function(){
            		$.ajax({
                        type: "POST",
                        url: "/dagl/bmgl/adjustFirstLevel",
                        data: {
                        	tableName:tableName,
                        	newXuHao:$("#newXuHao").val(),
                        	recid:recid
                        },
                        async: false,
                        dataType: "json",
                        success: function (data) {
                        	if(data.flag=="1"){
                        		//操作成功后刷新父页面和整理编目列表页面
                        		parent.TableInit.refTable('right_table');
    	                        parent.parent.initPanel();
                                parent.parent.layer.msg('操作成功！',{icon:1,time:2000});
                                closeIfram();
                        	}else{
                        		var index1 = layer.confirm(data.msg, 
                    					{
                    						icon:0
                    						,title:'信息'
                    						,btn: ['确定'] //按钮
                    						,btn1:function(){
                    							layer.close(index1);
                    						},end:function(){
                    							layer.close(index);
                    						}
                    				});
                        	}
                        },
                        error: function (data) {
                        	layer.msg("操作失败，请稍后再试或联系管理员！", { icon: 0, time: 2000 });
                        	layer.close(index);
                        	//关闭当前窗口
                            closeIfram();
                        }
                    });
            	},1000);
        	});
        }
    }

    function cancel(){
        closeIfram();
    }

    //关闭当前窗口
    function closeIfram(){
        var index=parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }
    function buZero() {
        var newXuHao = $("#newXuHao").val();
        if("" != newXuHao){
            //不为空的时候查询档号的长度，补0
            var lastColumnLength = fileNumberRule[fileNumberRule.length-1].NUMB_LENGTH;
            //补0后回填
            $("#newXuHao").val(PrefixInteger(newXuHao,lastColumnLength));
        }
    }
    //num传入的数字，n需要的字符长度
    function PrefixInteger(num, length) {
        for(var len = (num + "").length; len < length; len = num.length) {
            num = "0" + num;
        }
        return num;
    }

    /**
     * 获取档号规则
     */
    function getfileNumberRule() {
        $.ajax({
            url: '/dagl/bmgl/findDHGZ',
            data: {
                categoryCode: categoryCode, // 门类
                tName: tableName, // 表名
                all: all, // 标签页总数
                ranking: ranking // 当前标签页层级
            },
            type: 'post',
            dataType: 'json',
            success: function (data) {

                // 获取 data
                var data = data.data;
                fileNumberRule = data.rows.sort(sortByNumber('ORDER_NUM'));
            },
            error: function (err) {
                layer.msg('加载失败，请刷新页面',{icon: 2,time:1000});
                console.log("加载档号规则失败，错误信息：\n", err);
            }
        });
    }

</script>
</body>
</html>