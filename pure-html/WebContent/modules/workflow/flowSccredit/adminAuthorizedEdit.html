<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/static/css/common/Loading.css">
    <link rel="stylesheet" href="/static/core/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/core/bootstrapvalidator/dist/css/bootstrapValidator.min.css"/>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="/static/core/html5/html5shiv.min.js"></script>
    <script src="/static/core/html5/respond.js"></script>
    <![endif]-->
    <link href="/static/css/common/style.css" rel="stylesheet"/>
    <link href="/static/css/common/form-public.css" rel="stylesheet"/>
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="/static/core/jquery-fileupload/css/jquery.fileupload.css">
    <link rel="stylesheet" href="/static/font/iconfont.css">

    <link href="/static/css/common/project.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/manage/font-awesome-4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="/manage/font-awesome-4.7.0/css/font-awesome.min.css">

    <script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
    <script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
    <script src="/static/core/laydate/laydate.js"></script>
    <script src="/static/core/layer/layer.js"></script>
    <script src="/static/js/common/mylayer.js"></script>
    <script type="text/javascript" src="/static/js/common/assistUtil.js"></script>


    <!-- 流程相关 -->
    <script type="text/javascript" src="/modules/system/component/tree/js/deptUserTree.js"></script>
    <script type="text/javascript" src="/common/js/config.js"></script>
    <script type="text/javascript" src="/product/workflow/js/storages.js"></script>
    <script type="text/javascript" src="/common/js/commonFunction.js"></script>
    <!-- 获取cookie值 -->
    <script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
    <!-- 页面获取参数 -->
    <script type="text/javascript" src="/common/js/getrequest.js"></script>
    <!-- 数据回显 -->
    <script type="text/javascript" src="/static/js/common/displayData.js"></script>

</head>
<body class="formpage_bj">
<div class="container-fluid formpage_area row m-t-15">
    <form name="addedit" id="addedit" target="_self" class="form-horizontal pdLR60" style="margin-bottom: 100px;">
        <input type="hidden" name="sortId" value="" id="sortId">
        <input type="hidden" name="sccreditid" value="" id="sccreditid">
        <input type="hidden" name="cre_user" value="" id="cre_user">
        <input type="hidden" name="sysId" id ="sysId" value=""/>
        <input type="hidden" name="orgId" id ="orgId" value=""/>
        <table  class="table topsearch" >
            <tr>
                <td class="tl" ><label  style="padding-top: 7px;"><b style="color: red;">*</b>授权人: </label></td>
                <td class="tr" >
                    <input TYPE="hidden" NAME="userid" id="userid" value=""/>
                    <input TYPE="hidden" NAME="deptid" id="deptid" value=""/>
                    <input TYPE="hidden" NAME="deptname" id="deptname" value=""/>
                    <input TYPE="text" NAME="username" id="username" class="form-control" unselectable="on" value="" style="float: left;width: 85%;vertical-align:center;"
                           onclick="openTree();"/>
                    <img src="/static/images/tjxm/selectUserOrDept.png" title="选择授权人" style="cursor:pointer;float: left;margin:10px;"
                         onclick="openTree();"/>
                </td>
                <td class="tl" ><label  style="padding-top: 7px;"><b style="color: red;">*</b>被授权人: </label></td>
                <td class="tr" >
                    <input type="text" name="authedPeople" id="authedPeople" class="form-control" value="" unselectable="on" style="float: left;width: 85%;vertical-align:center;"
                           onclick="openTree1();"/>
                    <img src="/static/images/tjxm/selectUserOrDept.png" title="选择被授权人" style="cursor:pointer;float: left;margin:10px;"
                         onclick="openTree1();"/>
                    <input type="hidden" name="sccredituserid" value="" id="sccredituserid">
                    <input type="hidden" name="sccreditdeptid" value="" id="sccreditdeptid">
                </td>
            </tr>
            <!--<tr>
                <td colspan="4" style="color: red;text-align: center;">*******生效时间,失效时间请填写时间,精确到小时*******</td>
            </tr>-->
            <tr>
                <td class="tl"><label  style="padding-top: 7px;"><b style="color: red;">*</b>生效时间: </label></td>
                <td class="tr">
                    <input type="text" class="form-control" id="sccbegindate" name="sccbegindate" style="width:200px;">
                </td>
                <td class="tl"><label  style="padding-top: 7px;"><b style="color: red;">*</b>失效时间: </label></td>
                <td class="tr">
                    <input type="text" class="form-control" id="sccenddate" name="sccenddate" style="width:200px;">
                </td>
            </tr>
            <tr>
                <td  class="tl" ><label  style="padding-top: 7px;">授权范围: </label></td>
                <td  class="tr" >
                    <input type="radio" id="scopeone" name="scope" value="1" checked onClick="changeShow();">
                    <label for='scopeone'>全部授权</label> &nbsp; &nbsp;
                    <input type="radio" id="scope" name="scope" value="0" onClick="changeShow();">
                    <label for='scope'>部分授权</label>
                </td>
                <td class="tl" ><label  style="padding-top: 7px;"><b style="color: red;">*</b>办理类型: </label></td>
                <td class="tr">
                    <select name="sccredittype" class="form-control" style="width: 300px;">
                        <option value="1" selected>独立办理</option>
                        <option value="2">共同办理</option>
                    </select>
                </td>
            </tr>
            <tr id="typeShow" style="display:none;">
                <td class="tl"><label style="padding-top: 7px;"><b style="color: red;">*</b>授权事项: </label></td>
                <td class="tr">
                    <span class="form-control" style="height: 250px;width: 250px;overflow-x:hidden;">
                        <ul id="fileType">
                        </ul>
                    </span>
                </td>
            </tr>
            <tr style="display: none;">
                <td class="tl"><label  style="padding-top: 7px;"><b style="color: red;">*</b>是否允许再授权: </label></td>
                <td colspan="3">
                    <input TYPE="radio" id="issccreditone" NAME="issccredit" value="1" style="margin-left:10px;"><label for='issccreditone'>是 </label>
                    &nbsp; &nbsp;
                    <input TYPE="radio" id="issccredittwo" NAME="issccredit" value="0" checked ><label for='issccredittwo'>否 </label>
                </td>
            </tr>
        </table>
    </form>
</div>
<div class="form_btn_area" style="text-align: center;">
    <button id="save" class="btn btn-primary form_btn_area_btn2" onclick="formsubmit();" ><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> 保存</button>
</div>
<script type="text/javascript">

    var request = new GetRequest();
    var role = request.role;

    /**
     * 生效时间
     */
    laydate.render({
        elem: '#sccbegindate',
        format:'yyyy-MM-dd HH:mm:ss',
        type:'datetime'
    });
    /**
     * 失效时间
     */
    laydate.render({
        elem: '#sccenddate',
        format:'yyyy-MM-dd HH:mm:ss',
        type:'datetime'
    });

    $(function(){
        //加载流程事项
        getLicenseFlowType();
        //编辑页面回显
        showData();
    });

    /**
     * 修改编辑页面数据回显
     */
    function showData(){
        var id = request.id;
        if(id){
            //设置scope的值为0
            $("#scope").prop("checked", true);
            changeShow();
            var data={"id":id};
            getDataByAjax('/sccredit/view',data,function(data) {
                if (data["result"] == "0") {
                    result = data["msg"];
                    layer.alert(result,{icon:0,title:'警告'});
                } else {
                    //将获取到的值写入到form中
                    $("select[name=sccredittype]").val(data.sccredittype);
                    $("#sortId").val(data.sortId);
                    $("#sccreditid").val(data.sccreditid);
                    $("#username").val(data.username);
                    $("#userid").val(data.userid);
                    $("#deptname").val(data.deptname);
                    $("#deptid").val(data.deptid);
                    $("#authedPeople").val(data.sccreditusername);
                    $("#sccredituserid").val(data.sccredituserid);
                    $("#sccreditdeptid").val(data.sccreditdeptid);
                    $("#sccbegindate").val(data.sccbegindate);
                    $("#sccenddate").val(data.sccenddate);
                    $("input[type=radio][name=issccredit][value="+data.issccredit+"]").attr("checked",true);
                    var types = data.filetype.split(",");
                    $.each(types,function (i,type) {
                        $("#"+type).prop("checked","checked");
                        $("#"+type).siblings("[name=fileTypeItem]").prop("checked","checked");
                    });
                }
            });
        }
    }

    /**
     * 获取事项类型
     */
    function getLicenseFlowType(){
        $.ajax({
            type: "post",
            //url: "/workflow/getworkflow",	//获取该用户可启动的流程
            url: "/sccredit/getAllFlowTypes",
            data:{
                userId:getcookie('userid'),
                deptId:getcookie('deptid')
            },
            dataType: "json",
            async:false,
            cache:false, //清除缓存
            success: function(data) {
                for ( var i in data.flows) {
                    var flows = data.flows[i];
                    var li = [];
                    li.push("<li id='"+i+"'>");
                    li.push("<input type='checkbox' name='fileType' id='"+flows.flowTypeId+"' value=''/>&nbsp;&nbsp;");
                    li.push("<label for='"+flows.flowTypeId+"'>"+flows.name+"</label>");
                    li.push("</li>");
                    $("#fileType").append(li.join(''));
                    for(var j in flows.flowList){
                        var flow = flows.flowList[j];
                        var value = flows.name+";"+flows.flowTypeId+";"+flow.workflowid+";"+flow.workflowname;
                        var option = "<input type='checkbox' name='fileTypeItem' style='display: none;' value='"+value+"'>";
                        $("#"+i).append(option);
                    }
                }
                //绑定点击事件
                $("input[name=fileType]").on("click",function () {
                    var check = $(this).prop("checked");
                    $(this).siblings("[name=fileTypeItem]").prop("checked",check);
                });
            },
            error: function() {
                layer.alert("请重新登入系统！",{icon:0,title:'警告'}, function(index){
                    window.location.href = path + "/main.html";
                    layer.close(index);
                });
            }
        });
    }

    /**
     * 显示/隐藏“事项类型”
     */
    function changeShow(){
        var scope = document.forms["addedit"].elements["scope"];
        if(scope[1].checked){//显示
            document.getElementById("typeShow").style.display="";
            //取消全选
            $("input:checkbox").removeProp("checked");
        }else if(scope[0].checked){//隐藏
            document.getElementById("typeShow").style.display="none";
            //全选
            $("input:checkbox").prop("checked","checked");
        }
    }

    /**
     * 确定，保存授权方法
     */
    function formsubmit(){
        if(!checkForm()){
            return;
        }
        var xx = $('#addedit').serialize();
        debugger
        getDataByAjax('/sccredit/save',$('#addedit').serialize(),function(data) {
            if (data["result"] == "0") {
                layer.msg(data["msg"], {icon: 2});
            } else {
                layer.msg(data["msg"], {icon: 1});
                parent.TableInit.refTable('right_table');
                MyLayer.closeOpen(2000);
            }
        });
    }

    function checkForm() {
        if($("input:checkbox:checked").size() < 1){
            layer.msg('请选择事项类型！', {icon: 0});
            return false;
        }
        if(!$("#userid").val()){
            layer.msg("请选择授权人！", {icon: 0});
            return false;
        }
        if(!$("#sccredituserid").val()){
            layer.msg("请选择被授权人！", {icon: 0});
            return false;
        }
        if($("#userid").val() == $("#sccredituserid").val()){
            layer.msg('不能授权给自己！', {icon: 0});
            return false;
        }
        if(!$("#sccbegindate").val()){
            layer.msg("生效日期不能为空！", {icon: 0});
            return false;
        }
        if(!$("#sccenddate").val()){
            layer.msg("失效日期不能为空 ！", {icon: 0});
            return false;
        }
        if (!$("#sccbegindate").val() && !$("#sccenddate").val()){
            if (!opinionDate($("#sccbegindate").val(),$("#sccenddate").val())){
                layer.msg("生效日期必须小于或者等于失效日期！", {icon: 0});
                return false;
            }
        }
        return true;
    }

    /*
     * 一个判断日期大小，sDate代表起始时间，eDate代表结束时间，如果eDate大于sDate，返回true
     */
    function opinionDate(sDate, eDate) {
        startDate = sDate;
        endDate = eDate;
        startMark1 = startDate.indexOf("-");
        startYear = startDate.substring(0, startMark1);
        startDate = startDate.substring(startMark1 + 1, startDate.length);
        startMark2 = startDate.indexOf("-");
        startMonth = startDate.substring(0, startMark2);
        startDate = startDate.substring(startMark2 + 1, startDate.length);
        startDay = startDate;

        endMark1 = endDate.indexOf("-");
        endYear = endDate.substring(0, endMark1);
        endDate = endDate.substring(endMark1 + 1, endDate.length);
        endMark2 = endDate.indexOf("-");
        endMonth = endDate.substring(0, endMark2);
        endDate = endDate.substring(endMark2 + 1, endDate.length);
        endDay = endDate;

        if (startMonth.substring(0, 1) == 0) {
            startMonth = startMonth.substring(1, 2);
        }
        if (endMonth.substring(0, 1) == 0) {
            endMonth = endMonth.substring(1, 2);
        }
        if (startDay.substring(0, 1) == 0) {
            startDay = startDay.substring(1, 2);
        }
        if (endDay.substring(0, 1) == 0) {
            endDay = endDay.substring(1, 2);
        }
        if (parseInt(endYear) < parseInt(startYear)) {
            return false;
        } else if ((parseInt(endYear) == parseInt(startYear))) {
            if (parseInt(startMonth) < parseInt(endMonth)) {
                return true;
            } else if (parseInt(startMonth) > parseInt(endMonth)) {
                return false;
            } else if (parseInt(startMonth) == parseInt(endMonth)) {
                if (parseInt(startDay) > parseInt(endDay)) {
                    return false;
                }
            }
        }
        return true;
    }

    function openTree() {
        var deptId = "";
        if(role == "1"){
            //总收发（查看本单位）
            deptId = getcookie('juId');
        }else if(role == "2"){
            //部门综合（查看本部门）
            deptId = getcookie('deptid');
        }
        openSelectZtree({'id':'userid','name':'username','parentId':'deptid','parentName':'deptname',
            'deptId':deptId,'isMulti':'1','type':'1','asyn':true,'check':'','cancle':'',
            'url':'/system/component/tree/getDeptOrUserTree'})
    }

    function openTree1() {
        var deptId = "";
        if(role == "1"){
            //如果是总收发（查看本单位），需要对被授权人的人员树做控制，查询授权人所在单位
            control();
            return;
        }else if(role == "2"){
            //部门综合（查看本部门）
            deptId = getcookie('deptid');
        }
        openSelectZtree({'id':'sccredituserid','name':'authedPeople','parentId':'sccreditdeptid',
            'deptId':deptId,'isMulti':'1','type':'1','asyn':true,'check':'','cancle':'',
            'url':'/system/component/tree/getDeptOrUserTree'})
    }

    function control() {
        var userId = $("#userid").val();
        var deptId = $("#deptid").val();
        if(!userId){
            layer.msg("请先选择授权人",{icon:0});
            return;
        }
        //查询授权人所在单位
        $.ajax({
            type: "get",
            url: "/dept/getUserBankId",
            data:{ deptId:deptId },
            dataType: "json",
            success: function(data) {
                if(data && data.flag == "1"){
                    //不展示该单位下的子单位，只展示部室
                    openSelectZtree({'id':'sccredituserid','name':'authedPeople','parentId':'sccreditdeptid',
                        'deptId':data.unitId,'isMulti':'1','type':'1','asyn':false,'check':'','cancle':'',
                        'level':'5','showUnit':'2','url':'/system/component/tree/deptUserTree'})
                }else{
                    layer.msg("查询授权人所在单位失败",{icon:2});
                }
            },
            error: function() {
                layer.msg("查询授权人所在单位失败",{icon:2});
            }
        });
    }

</script>
</body>
</html>