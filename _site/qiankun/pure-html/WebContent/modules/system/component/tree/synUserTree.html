<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">

    <title>企业中心</title>
    <!-- Bootstrap -->
    <link href="/static/core/bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- style.css -->
    <link href="/static/css/common/style.css" rel="stylesheet">
    <link href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/core/mCustomScrollbar/jquery.mCustomScrollbar.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        .list-group-item .pull-right {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="modal-body selectjs">
        <div class="col-sm-6 ">
            <div class="selectjs_block">
                <div class="title_tab">
                    <ul class="nav nav-tabs">
                        <li class="active" for="tree-obj">
                            <a href="#" data-toggle="tab" class="">
                                按部门选择
                            </a>
                        </li>
                        <li for="group-obj">
                            <a href="#" data-toggle="tab">
                                按群组选择
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="main">
                    <div class="left_search_area">
                        <div class="input-group">
                            <input id="keyword" name="deptName" onkeydown="CommonUtil.keyDown(event);" type="text"
                                class="form-control" placeholder="快速搜索" data-deptname="" data-groupname="">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button" id="search-bt">
                                    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                                </button>
                            </span>
                        </div>
                    </div>
                    <div class="left_tree_area">
                        <ul id="tree-obj" class="ztree"></ul>
                        <ul id="group-obj" class="ztree hidden"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="selectjs_block">
                <div class="title" style="background-color:#0073aa;color: white">已选择</div>
                <div class="main" id="selectedDeptUser">
                    <ul class="right_del_list" style="height: 100%;overflow-y: auto;">

                    </ul>
                </div>

            </div>
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="modal-footer" style="text-align: center">
        <button type="button" class="btn btn-primary  btn-blue  bigbtn" id="close">
            确&nbsp;&nbsp;定
        </button>
    </div>
    <input name="id" type="hidden" id="id" />
    <input name="name" type="hidden" id="name" />
    <input name="idContext" type="hidden" id="idContext" />
    <input name="nameContext" type="hidden" id="nameContext" />
    <input name="deptIdContext" type="hidden" id="deptIdContext" />
    <input name="deptNameContext" type="hidden" id="deptNameContext" />
    <input name="mark" type="hidden" id="mark" />
    <script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
    <script src="/static/core/zTree_v3/js/jquery.ztree.core.js"></script>
    <script src="/static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="/static/core/zTree_v3/js/jquery.ztree.exhide.js"></script>
    <script type="text/javascript" src="/common/js/getrequest.js"></script>
    <script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
    <script src="/static/core/layer/layer.js"></script>
    <script src="/static/core/mCustomScrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
    <script type="text/javascript">

        // 左右侧滚动条修改
        $('.left_tree_area').mCustomScrollbar({
            theme: 'dark-3',
            mouseWheelPixels: 300,
            scrollButtons: {
                enable: true
            }
        });
        $('#selectedDeptUser')
            .find('.right_del_list').css('overflow-y', 'visible').end()
            .css('overflow-y', 'auto')
            .mCustomScrollbar({
                theme: 'minimal-dark',
                mouseWheelPixels: 300
            });
        $('.mCSB_scrollTools .mCSB_dragger .mCSB_dragger_bar').css('width', '6px');

        var theRequest = GetRequest();
        var deptUrl = theRequest.url;
        var type = theRequest.type;
        var isMulti = theRequest.isMulti;
        var deptId = theRequest.deptId;
        var level = theRequest.level;
        var check = theRequest.check;
        var cancle = theRequest.cancle;
        var positionName = theRequest.positionName;


        /**
         * 注意这是zTree3.5版本，API必须在3.0版本以上，以下的版本API不对
         * @type {Array}
         */
        var deptZtree = function () {
            var hiddenNodes = [];
            var zTreeObj = null;
            var zNodes = null;

            //ztree配置选项
            var setting = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "pid",
                        rootPId: 0
                    }
                },
                callback: {
                    onCheck: function (event, treeId, treeNode) {
                        CommonUtil.zTreeOnCheck(event, treeId, treeNode);
                    }
                },
                check: {
                    enable: true,
                    autoCheckTrigger: true,
                    chkStyle: "checkbox",
                    chkboxType: { "Y": check, "N": cancle }
                }
            };

            // 加载数据
            var loadData = function () {
                $.ajax({
                    async: false,
                    cache: false,
                    type: "get",//请求方式为get
                    url: deptUrl,
                    dataType: "json", //返回数据格式为json
                    data: { "deptId": deptId, "level": level, "positionName": positionName },
                    success: function (datas) {
                        var zNodes = datas;
                        treeNodes = datas;
                        if (zNodes.length > 0) {
                            zNodes[0].open = true;
                        }
                        for (var i = 0; i < zNodes.length; i++) {
                            zNodes[i].id = zNodes[i].uuid;
                            zNodes[i].pid = zNodes[i].uupid;
                            zNodes[i].nodeType = zNodes[i].type;
                            if (zNodes[i].type == "user") {
                                zNodes[i].icon = "/static/images/user.png";
                            } else if (zNodes[i].type == "dept") {
                                zNodes[i].isParent = true;
                                zNodes[i].nocheck = false;
                            }
                        }
                        zTreeObj = $.fn.zTree.init($("#tree-obj"), setting, zNodes);
                        CommonUtil.echoData(zTreeObj);
                    },
                    error: function (request) {
                        layer.msg("数据加载失败！请刷新重试！", { icon: 2 });
                    }
                });

            }

            /**
             * 过滤
             * @return {[type]} [description]
             */
            var filter = function () {
                //显示上次搜索后背隐藏的结点
                zTreeObj.showNodes(hiddenNodes);

                //查找不符合条件的叶子节点
                function filterFunc(node) {
                    var _keywords = $("#keyword").val();
                    if (node.isParent || node.name.indexOf(_keywords) != -1) {
                        if (node.isParent) {//如果是父节点，父节点下的子节点名称不包含模糊查询的名称隐藏，如果包含则不隐藏
                            var childrenNodes = zTreeObj.getNodesByParamFuzzy("name", _keywords, node);
                            if (childrenNodes.length == 0) {
                                return true;
                            } else {
                                zTreeObj.expandNode(node, true, false);
                                return false;
                            }
                        } else {
                            zTreeObj.expandNode(node, true, false);
                            return false;
                        }
                    } else {
                        return true;
                    }
                };

                //获取不符合条件的叶子结点
                hiddenNodes = zTreeObj.getNodesByFilter(filterFunc);

                //隐藏不符合条件的叶子结点
                zTreeObj.hideNodes(hiddenNodes);
            }

            return {
                init: function () {
                    loadData();
                },
                filter: function () {
                    filter();
                },
                getZTreeObj: function () {
                    return zTreeObj;
                }
            }
        }();

        var groupZtree = function () {
            var hiddenNodes = [];
            var zTreeObj = null;
            var zNodes = null;

            //ztree配置选项
            var setting = {
                callback: {
                    onDblClick: function (event, treeId, treeNode) {
                        CommonUtil.zTreeOnDblclick(event, treeId, treeNode);
                    },
                    onCheck: function (event, treeId, treeNode) {
                        CommonUtil.zTreeOnCheck(event, treeId, treeNode);
                    }
                },
                data: {
                    key: {
                        name: "name",
                        title: "name"
                    },
                    simpleData: {
                        idKey: "id",
                    }
                },
                check: {
                    enable: true,
                    autoCheckTrigger: true,
                    chkStyle: "checkbox"
                }
            };

            // 加载数据
            var loadData = function () {
                $.getJSON("/mock/ztree1.json", function (data) {
                    zTreeObj = $.fn.zTree.init($("#group-obj"), setting, data);
                    CommonUtil.echoData(zTreeObj);
                })

            }

            /**
             * 过滤
             * @return {[type]} [description]
             */
            var filter = function () {
                //显示上次搜索后背隐藏的结点
                zTreeObj.showNodes(hiddenNodes);

                //查找不符合条件的叶子节点
                function filterFunc(node) {
                    var _keywords = $("#keyword").val();
                    if (node.isParent || node.name.indexOf(_keywords) != -1) return false;
                    return true;
                };

                //获取不符合条件的叶子结点
                hiddenNodes = zTreeObj.getNodesByFilter(filterFunc);

                //隐藏不符合条件的叶子结点
                zTreeObj.hideNodes(hiddenNodes);
            };

            return {
                init: function () {
                    loadData();
                },
                filter: function () {
                    filter();
                },
                getZTreeObj: function () {
                    return zTreeObj;
                }
            }
        }();


        var CommonUtil = {
            /**
             * 回显数据
             * @return {[type]} [description]
             */
            echoData: function (zTreeObj) {
                var ids = $("#idContext").val();
                var deptIds = $("#deptIdContext").val();
                if (ids) {
                    var idArr = ids.split(",");
                    var deptIddArr = deptIds.split(",");
                    for(var j = 0; j < idArr.length; j++){
                        var deptNode = zTreeObj.getNodeByParam("id",deptIddArr[j]);
                        var userNode = zTreeObj.getNodeByParam("id",idArr[j],deptNode);
                        zTreeObj.checkNode(userNode, true, true);
                    }
                }
            },

            zTreeOnCheck: function (event, treeId, treeNode) {
                var id = "", node = null, node_g = null, nodeHtml = [];
                /**** 如果在部门树中改变勾选状态同时也在群组树修改勾选状态  ****/
                //如果是取消
                if (treeNode && !treeNode.isParent && !treeNode.checked) {
                    id = treeNode.id;
                    node = deptZtree.getZTreeObj().getNodeByParam("id", id, null);
                    if (node) {
                        deptZtree.getZTreeObj().checkNode(node, false, true);
                    }
                    node_g = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
                    if (node_g) {
                        groupZtree.getZTreeObj().checkNode(node_g, false, true);
                        $('.right_del_list').find('li').each(function () {
                            if ($(this).attr('id') == node.id) {
                                $(this).remove();
                            }
                        });
                    }
                }
                //选中
                if (treeNode && !treeNode.isParent && treeNode.checked) {
                    id = treeNode.id;
                    node = deptZtree.getZTreeObj().getNodeByParam("id", id, null);
                    if ($("#" + id).text() == "") {
	                    if (node) {
	                        deptZtree.getZTreeObj().checkNode(node, true, true);
	                        nodeHtml.push(CommonUtil.joinHtml(node.id, node.name));
	                    }
	                    node_g = groupZtree.getZTreeObj().getNodeByParam("id", id, null);
	                    if (node_g) {
	                        groupZtree.getZTreeObj().checkNode(node_g, true, true);
	                        nodeHtml.push(CommonUtil.joinHtml(node.id, node.name));
	                    }
                    }
                }


                var deptNodes = [], groupNodes = [], nodes = {};
                if (deptZtree.getZTreeObj()) {
                    deptNodes = deptZtree.getZTreeObj().getCheckedNodes(true);
                }
                if (groupZtree.getZTreeObj()) {
                    groupNodes = groupZtree.getZTreeObj().getCheckedNodes(true);
                }
                /* for(var i=0;i< deptNodes.length;i++){
                    if(!deptNodes[i].isParent){
                        nodes[i] = {
                            "id": deptNodes[i].id,
                            "name": deptNodes[i].name
                        }
                    }
                }
                for(var j=0;j< groupNodes.length;j++){
                    if(!groupNodes[j].isParent){
                        nodes[groupNodes[j].id] = {
                            "id":groupNodes[j].id,
                            "name": groupNodes[j].name
                        }
                    }
                }
                for(var item in nodes){
                    nodeHtml.push(CommonUtil.joinHtml(nodes[item].id,nodes[item].name)) 
                } */
                if (nodeHtml.length > 0) {
                    $('.right_del_list').append(nodeHtml.join(''));

                }/* else{
                $('.right_del_list').empty();
            } */
                $('.right_del_list li').find('img').unbind('click').bind('click', function () {
                    var obj = $(this).parents('li');
                    var id = $(obj).attr('id')
                    $(obj).remove();
                    if (deptZtree.getZTreeObj) {
                        var deleteNodes = deptZtree.getZTreeObj().getNodesByParam("id", id, null);
                        for (var j in deleteNodes) {
                            deptZtree.getZTreeObj().checkNode(deleteNodes[j], false, true);
                        }
                    }
                    if (groupZtree.getZTreeObj) {
                        var deleteNodes = deptZtree.getZTreeObj().getNodesByParam("id", id, null);
                        for (var j in deleteNodes) {
                            deptZtree.getZTreeObj().checkNode(deleteNodes[j], false, true);
                        }
                    }
                })

            },

            zTreeOnDblclick: function (event, treeId, treeNode) {
                if (treeNode && !treeNode.isParent) {
                    if (treeNode.checked) {//如果选中了
                        id = treeNode.id;
                        node = deptZtree.getZTreeObj().getNodeByParam("id", id, null);
                        if (node) {
                            deptZtree.getZTreeObj().checkNode(node, false, true);
                            $('.right_del_list').find('li').each(function () {
                                if ($(this).attr('id') == node.id) {
                                    $(this).remove();
                                }
                            });
                        }
                    } else {//如果没有选中
                        deptZtree.getZTreeObj().checkNode(treeNode, true, false);
                        var deptNode1 = deptZtree.getZTreeObj().getNodeByParam("id", treeNode.id, null).getParentNode();
                        var html = CommonUtil.joinHtml(treeNode.id, treeNode.name, deptNode1.id, deptNode1.name);
                        if ($('.right_del_list').find('li#' + treeNode.id).length == 0) {
                            $('.right_del_list').append(html);
                        } else {
                            console.log('节点已添加,不可重复添加！');
                        }
                    }
                }
                $('.right_del_list li').find('img').unbind('click').bind('click', function () {
                    var obj = $(this).parents('li');
                    var id = $(obj).attr('id')
                    $(obj).remove();
                    if (deptZtree.getZTreeObj) {
                        var deleteNodes = deptZtree.getZTreeObj().getNodesByParam("id", id, null);
                        for (var j in deleteNodes) {
                            deptZtree.getZTreeObj().checkNode(deleteNodes[j], false, true);
                        }
                    }
                })
            },

            /**
             * 回显右侧用户选择的数据
             * @return {[type]} [description]
             */
            eachSelectData: function () {
                var idsStr = $("#idContext").val();
                var namesStr = $("#nameContext").val();
                var ids = [], names = [], html = [];
                if (idsStr) {
                    ids = idsStr.split(",");
                    names = namesStr.split(",");
                    for (var i = 0; i < ids.length; i++) {
                        html.push(CommonUtil.joinHtml(ids[i], names[i]));
                    }
                    $('.right_del_list').append(html.join(''));

                    // 添加删除
                    CommonUtil.deleteElement();
                }
            },

            bindFun: function () {
                /**
                 * tab 切换
                 */
                $('.nav-tabs > li').unbind('click').bind('click', function () {
                    var id = $(this).attr('for');
                    $(this).addClass('active').siblings('li').removeClass('active');
                    $('.left_tree_area').children().addClass('hidden');
                    $('#' + id).removeClass('hidden');
                    //绑定搜索按钮事件
                    if (id == "tree-obj") {
                        //如果切换部门页，将群组查询条件赋值给data-groupname属性
                        $("#keyword").attr("data-groupname", $("#keyword").val());
                        $("#keyword").val($("#keyword").attr("data-deptname"));
                        $("#search-bt").unbind('click').bind('click', function () {
                            deptZtree.filter();
                        });
                    } else {
                        //如果切换群组页，将部门查询条件赋值给data-deptname属性
                        $("#keyword").attr("data-deptname", $("#keyword").val());
                        $("#keyword").val($("#keyword").attr("data-groupname"));
                        $("#search-bt").unbind('click').bind('click', function () {
                            groupZtree.filter();
                        });
                    }
                });

                /**
                 * 绑定搜索按钮事件
                 */
                var id = $('.nav-tabs > li').attr('for');
                if (id == "tree-obj") {
                    $("#search-bt").unbind('click').bind('click', function () {
                        deptZtree.filter();
                    });
                }

                /**
                 *
                 * 确定按钮事件
                 */
                $("#close").unbind('click').bind('click', function () {
                    parent.putBackData();
                })

            },

            saveSelectedData: function () {
                var ids = [], names = [], parentIds = [], parentNames = [], res = {};
                //判断是否可多选
                var $selectedLi = $('#selectedDeptUser .list-group-item[data-id][data-name]');
                /*if($selectedLi.length < 1){
                    layer.alert("至少选择一个");
                    return;
                }*/
                if (isMulti == '1' && $selectedLi.length > 1) {
                    layer.alert("只能选择一个");
                    return;
                }
                // 回显数据
                $('.right_del_list li').each(function (i, item) {
                    ids.push($(this).attr('id'));
                    names.push($(this).text());
                })
                //获取选择人原所在部门
                $.each(ids, function (i, id) {
                    var deptNode = deptZtree.getZTreeObj().getNodeByParam("id", id, null).getParentNode();
                    parentIds.push(deptNode.id);
                    parentNames.push(deptNode.name);
                })

                res.parentIds = parentIds.join(",");
                res.parentNames = parentNames.join(",");
                res.ids = ids.join(",");
                res.names = names.join(",");

                if ($('#mark').val() != "") {
                    var id = $('#id').val();
                    var name = $('#name').val();
                    var html = CommonUtil.joinBorderHtml(ids, names, id, name);
                    res.mark = html;
                }
                return res;
            },

            keyDown: function () {
                var ev = window.event || arguments[0];
                //13是键盘上面固定的回车键
                if (ev.keyCode == 13) {
                    //你要执行的方法
                    if ($(".nav-tabs").find('.active').attr('for') == "tree-obj") {
                        deptZtree.filter();
                    } else {
                        groupZtree.filter();
                    }

                }
            },
            /**
             * 拼接字符串
             * @return {[type]} [description]
             */
            joinHtml: function (id, name) {
                var html = [];
                html.push('<li id="' + id + '" class="list-group-item" data-id="' + id + '" data-name="' + name + '">');
                html.push('<span class="pull-right">');
                html.push('');
                html.push('<img src="/static/images/ico_del2.png" width="24" height="24" alt=""/>');
                html.push('');
                html.push('</span>' + name + '');
                html.push('</li>');
                return html.join('');
            },
            joinBorderHtml: function (ids, names, id, name) {
                var html = [];
                html.push('<ol>');
                for (var i = 0; i < ids.length; i++) {
                    html.push('<li class="item" id="' + ids[i] + '" > ');
                    html.push(names[i] + '<span forId="' + id + '" forName="' + name + '" onclick="deleteThisNode(this)" class="glyphicon glyphicon-remove"></span>');
                    html.push('</li>');
                }
                html.push('</ol>');
                return html.join('');
            },
            deleteElement: function () {
                $('.right_del_list li img').unbind('click').bind('click', function () {

                    var deleteNodes = deptZtree.getZTreeObj().getNodesByParam("id", $(this).parents('li').attr('id'), null);
                    for (var j in deleteNodes) {
                        deptZtree.getZTreeObj().checkNode(deleteNodes[j], false, true);
                    }
                    $(this).parents('li').remove();
                })
            }
        }

    </script>
</body>

</html>