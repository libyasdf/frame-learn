<style type="text/css">
    .panel-controls{
        position: absolute;
        right: 40px;
        top: 10px;
    }
    .panel-controls > i.showSelect{
        font-size: 16px;
        color: #acb1b8;
        cursor: pointer;
    }
    label{
        font-weight: normal;
    }
    body{
    padding-bottom: 0px}
</style>
<link rel="stylesheet" type="text/css" href="/modules/system/config/dictionary/css/vertify.css">
<link rel="stylesheet" type="text/css"
      href="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.css">
<link rel="stylesheet" type="text/css" href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css">
<div class="container-fluid">
    <div class="row" style="height:100%;">
        <!--查询--><div class="vertify-panel vertify-tree x-unselectable" role="presentation">
            <div class="inner">
                <div class="folderBar">
                    <i class="glyphicon glyphicon-plus-sign" onclick="addType('0');" style="font-size:18px;cursor: pointer;" title="新增试卷类型"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <i class="glyphicon glyphicon-edit" onclick="editType();" style="font-size:18px;cursor: pointer;" title="修改试卷类型"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <i class="glyphicon glyphicon-trash" onclick="deletType();" style="font-size:18px;cursor: pointer;" title="删除试卷类型"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <i class="glyphicon glyphicon-search" onclick="showSearchFrame()" style="font-size:18px;cursor: pointer;" title="查询试卷类型"></i>
                </div>
                <div id="searchDiv" class="input-group input-group-sm"
                     style="display:none;padding-left:5px; margin-top: 5px; padding-right: 5px;">
                    <input type="text" id="typeName" class="form-control">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" onclick="searchType();" >查询</button>
                    </span>
                </div>
                <ul id="treeDemo" class="ztree" style="margin-top: 10px; height:606px; overflow:auto;">
                </ul>
            </div>
        </div>
        <div class="vertify-panel vertify-details" >
        <form class="form-horizontal" >
            <div class="col-md-12">
                <div class="panel panel-default toggle">
                    <div class="panel-heading" style="cursor: pointer;">
                       <h3 class="panel-title">查询项</h3>
                       <div class="panel-controls " >
                           <i class="glyphicon glyphicon-plus showSelect"></i>
                        </div>
                    </div>
                    <div class="panel-body" style="display: none;">
                        <div class="form-group">
                            <label class="col-md-2 control-label"> 试卷名称：</label>
                            <div class="col-md-3">
                                <input class="form-control" type="text" name="name" id="name" value=""/>
                            </div>
                            <label class="col-md-2 control-label"> 难易程度：</label>
                            <div class="col-md-3">
                                <select class="form-control" name="difficultyLevel" id="difficultyLevel">
                                    <option value="">---请选择---</option>
                                    <option value="1">简单</option>
                                    <option value="2">一般</option>
                                    <option value="3">困难</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="col-md-2" style="width:100%;text-align: center">
                                <button type="button" class="btn btn-primary" onclick="TableInit.refTable('right_table')" > 查&nbsp;&nbsp;询 </button> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <button type="button" class="btn btn-primary" onclick="list.chongzhi()" > 重&nbsp;&nbsp;置 </button> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <!--查询结束-->
       
        <div class="col-md-12">
            <div class="list_button_area">
                <button class="list_table_btn2"
                        onclick="add()">
                    <span class="glyphicon glyphicon-plus-sign"></span> 新增
                </button>
            </div>
            <!--bootstrap-table表格-->
            <table id="right_table"></table>
        </div>
         </div>
    </div>
</div>
    <script src="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.js"></script>
    <script src="/static/js/common/jquery.tablednd.js"></script>
    <script src="/static/core/zTree_v3/js/jquery.ztree.core.js"></script>
    <script src="/static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
    <script src="/static/core/zTree_v3/js/jquery.ztree.exedit.js"></script>
   <script src="/modules/zhbg/xxkh/tree/js/dictionaryTypeTree.js"></script>
    	<script src="/static/js/common/mylayer.js"></script>
    <!-- 页面获取参数 -->
	<script type="text/javascript" src="/common/js/getrequest.js"></script>
<script type="text/javascript">
var parameter;
var nodeId = "";
function add(){
	var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
	if(nodes.length<=0){
		layer.msg('请添加/选择试卷类型', {icon: 0});
		return;
	}
	nodeId=nodes[0].id;
	MyLayer.layerOpenUrl({url:'/modules/zhbg/xxkh/paperManage/sjglEditForm.html?type='+parameter.treeType+'&nodeId='+nodeId+"&resId="+resId,title:'新增试卷信息',width:'90%',height:'98%'})
}
//增加试卷类型
function addType(type) {
	$("#typeName").val("");
	// 判断是否已经选择了某个节点
	var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
	var ztree = $.fn.zTree.getZTreeObj("treeDemo");
	if (nodes.length == 0) {
		if($.fn.zTree.getZTreeObj("treeDemo").getNodes().length > 0){
    		layer.msg('请选择试卷类型', {icon: 0});
    		return false;
    	}
		var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?fid=1234567890123&treeType="+parameter.treeType+"&type=0"+"&resId="+resId;
		var title = "新增试卷类型";

		layer.open({
			type : 2,
			shadeClose : true,
			content : url,
			area : [ '770px', '250px' ],
			title : [ title, 'font-size:16px;font-weight:bold;' ]
		})
		if (nodes.length > 0) {
					ztree.selectNode(nodes[0]);
		}
	} else if (type) {
		$("#typeName").val("");
		var pid = nodes[0].id;
		var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?treeType="+parameter.treeType+"&type=";
		var title = "";
		if ("0" == type) {
			url = url + "0&pId=" + pid+"&resId="+resId;
			title = "新增试卷类型";
		}/*  else if ("1" == type) {
		            url = url + "1&mark=" + mark;
		            title = "新增资料项";
		        } */
		layer.open({
			type : 2,
			shadeClose : true,
			content : url,
			area : [ '770px', '250px' ],
			title : [ title, 'font-size:16px;font-weight:bold;' ]
		})
		if (nodes.length > 0) {
					ztree.selectNode(nodes[0]);
		}
	}
}

//修改试卷类型
function editType() {
	$("#typeName").val("");
	// 判断是否已经选择了某个节点
	var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
	if (nodes.length == 0) {
		layer.msg('请选择试卷类型', {
			icon : 0
		});
	} else {
		var id = nodes[0].id;
		var mark = nodes[0].mark;
		var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?id="
				+ id+"&resId="+resId;
		layer.open({
			type : 2,
			shadeClose : true,
			content : url,
			area : [ '770px', '250px' ],
			title : [ '修改试卷类型', 'font-size:16px;font-weight:bold;' ]
		})
	}
}

//删除试卷类型
function deletType() {
	$("#typeName").val("");
	// 判断是否已经选择了某个节点
	var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
	if (nodes.length == 0) {
	/* 	var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?treeType=fz&type=0";
		var title = "";

		layer.open({
			type : 2,
			shadeClose : true,
			content : url,
			area : [ '770px', '450px' ],
			title : [ title, 'font-size:16px;font-weight:bold;' ]
		}) */
		 layer.msg('请选择试卷类型', {icon: 0});
	} else {
		layer.confirm("确定要删除该类型吗？", function() {
			$.ajax({
				type : "POST",
				url : "/zhbg/xxkh/tree/deleteType",
				data : {
					id : nodes[0].id,resId:resId
				},
				dataType : "json",
				success : function(data) {
					if ('1' == data.flag) {
						layer.msg("删除成功！", {
							icon : 1,
							time : 1000
						}, function(index) {
							typeTree.delNode(nodes[0].id);
						});
					} else {
						layer.msg("该类型下有试卷项，不可删除！", {
							icon : 5
						});
					}
				},
				error : function(data) {
				}
			});
		});
	}
}

//查询资料类型
function searchType() {
	typeTree.searchNodes($("#typeName").val());
}

// 查询窗口
function showSearchFrame() {
	$("#typeName").val("");
	var search = $("#searchDiv");
	if (search.is(":hidden")) {
		search.show();
		$("#typeName").focus();
	} else {
		search.hide();
	}
}

    //参考：http://www.layui.com/laydate/
    //绑定日期输入input
    laydate.render({
        elem: '#time' //指定元素
    });
    //日期范围
    laydate.render({
        elem: '#timeRange'
        , range: true
    });


  //定义bootatrap-table数据列
    //    sortable：开启列排序，其他参考API
    //order：排序方式，可选
    var right_table_col = [{
        field: 'id'
        , title: '序号'
        , width: '5%'
        , align: "center"
        ,	formatter : function(value, row, index) {
        	
			var pageSize = $('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
			var pageNumber = $('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
			var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
			return "<span recordId='"+row.id+"'>" +orderNum  + "</span>";//计算序号
		}
	}, {
		field : 'name',
		title : '试卷名称',
		width : '22%',
		align : "center",
		formatter : function(value, row, index) {
			var name = value;
			if (value.length > 12) {
				value = value.substring(0, 12) + "...";
			}
			return "<span title='"+name+"'>" + value + "</span>";
		}
	}, {
		field : 'difficultyLevel',
		title : '难易程度',
		width : '10%',
		align : "center",
		formatter : function(value, row, index) {
			var data = "";
			if (value == 1) {
				data = "简单";
			} else if (value == 2) {
				data = "一般";
			} else {
				data = "困难";
			}
			return "<span>" + data + "</span>";//计算序号

		}
	}, {
		field : 'createType',
		title : '组卷方式',
		width : '10%',
		align : "center",
		formatter : function(value, row, index) {
			var data = "";
			if (value == 1) {
				data = "自动组卷";
			} else {
				data = "人工组卷";
			}
			return "<span zujuanfangshi='"+value+"'>" + data + "</span>";//计算序号

		}
	}, {
		field : 'fullScore',
		title : '试卷总分',
		width : '10%',
		align : "center"
	}, {
		field : 'creUserName',
		title : '创建人',
		width : '7%',
		align : "center"
	}, {
		field : 'creTime',
		title : '创建时间',
		sortable : true,
		width : '15%',
		align : "center"
	}, {
		field : 'state',
		title : '可用状态',
		sortable : true,
		width : '8%',
		align : "center",
		formatter : function(value, row, index) {
			if (value == 1) {
				value = "是 ";
			} else {
				value = "否";
			}
			return value;
		}
	}, {
		field : 'cz',
		title : '操作',
		width : '10%',
		align : "center",
		formatter : function(value, row, index) { //直接定义function,return就是html代码
			var opt = value.split(",");
			var html = "";
			for (var i = 0; i < opt.length; i++) {
				if (opt[i] == "add") {

				} else if (opt[i] == "update") {
					html += "<i class='glyphicon glyphicon-edit' title='编辑试卷' onclick='list.editFun(\"" + row.id + "\",\"" + row.createType + "\")'></i>"
				} else if (opt[i] == "delete") {
					html += "&nbsp;&nbsp;<i class='glyphicon glyphicon-trash' title='删除试卷' onclick='list.deleteFun(\"" + row.id + "\")'></i>"
				} else if (opt[i] == "view") {
					html += "&nbsp;&nbsp;<i class='glyphicon glyphicon-search' title='查看试卷' onclick='list.viewFun(\"" + row.id + "\")'></i>"
				}
			}
			return html;
		}
	} ];
	var resId;
	$(document).ready(function(e) {

		//搜索按钮
		$(document).keyup(function(e) {
			var key = e.which;
			if (key == 13) {
				searchType();
			}
		});

		//获取url中的参数
		var url = $("#left_ul").find("a.active").attr("url");
		resId = $("#left_ul").find("a.active").attr("id");
		parameter = new GetParameter(url);
		typeTree.init({
			treeType : parameter.treeType
		});

		var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
		if (nodes.length > 0) {
			nodeId = nodes[0].id;
		}
		//初始化表格
		TableInit.init({
			domId : "right_table",
			url : "/zhbg/xxkh/xxkhPaperInfo/list?type=" + parameter.treeType + "&nodeId=" + nodeId + "&resId=" + resId,
			pagination : true,
			columns : right_table_col,
			queryParams : function(params) {
				params.name = $("#name").val(), params.difficultyLevel = $("#difficultyLevel").val();

				//这里将各个查询项添加到要传递的参数中
				//                可以做一些校验
				//params.xname = $('#queryDiv input[name=\'textfield2\']').val();
				// params.xage = $('#queryDiv input[name=\'textfield2\']').val();
				return params;
			},
			readOnlyFn : function() {
				$('tr.readOnly').find('td:not(:last)').attr("title", "点击查看详情");
				$('tr.readOnly').find('td:not(:last)').unbind('click').bind('click', function(e) {
					//                    取消事件冒泡
					var evt = e ? e : window.event;
					if (evt.stopPropagation) {
						evt.stopPropagation();
					} else {
						evt.cancelBubble = true;
					}
					//                    取消事件冒泡 end
					var id = $(this).parent().find("span[recordid]").attr("recordid");
					var zujuanfangshi = $(this).parent().find("span[zujuanfangshi]").attr("zujuanfangshi");

					MyLayer.layerOpenUrl({
						url : '/modules/zhbg/xxkh/paperManage/sjglReadOnlyForm.html?id=' + id + "&createType=" + zujuanfangshi,
						title : '试卷基本信息',
						width : '90%',
						height : '90%'
					});
				});
			}
		});
	});

	//    表格数据项的操作
	var list = {
		editFun : function(id, createType) {
			$.get("/zhbg/xxkh/xxkhPaperInfo/isCanUpdate", {
				id : id
			}, function(data) {
				if (data.flag == 2) {
					layer.msg("该试卷已被某场考试选用并提交或发布，无法编辑该试卷", {
						icon : 0
					});
				} else if (data.flag == 1) {
					layer.confirm("该试卷已被某场考试选用但未发布，确定要修改吗？", {
						btn : [ '确定', '取消' ]
					//按钮
					}, function() {
						layer.msg("可用状态\是否共享，如果修改为否，考试管理试卷会被删除", {
							icon : 0
						});
						MyLayer.layerOpenUrl({
							url : '/modules/zhbg/xxkh/paperManage/sjglEditForm.html?id=' + id + "&type=" + parameter.treeType + "&createType=" + createType+"&resId="+resId,
							title : "修改试卷信息",
							width : "90%",
							height : "95%"
						})
					})
				} else {
					MyLayer.layerOpenUrl({
						url : '/modules/zhbg/xxkh/paperManage/sjglEditForm.html?id=' + id + "&type=" + parameter.treeType + "&createType=" + createType+"&resId="+resId,
						title : "修改试卷信息",
						width : "90%",
						height : "95%"
					})
				}
			}, "json")

		},
		viewFun : function(id) {
			MyLayer.layerOpenUrl({
				url : '/modules/zhbg/xxkh/paperManage/paperReadonly.html?id=' + id+"&resId="+resId,
				title : "试卷预览",
				width : "95%",
				height : "95%"
			})
		},
		deleteFun : function(id) {
			/*  MyLayer.deleteOpt({
			 	url : '/zhbg/xxkh/xxkhPaperInfo/delete?id=' + id+"&redId="+resId,
				tableId : 'right_table'
			 }) */
			$.get("/zhbg/xxkh/xxkhPaperInfo/isCanDelete", {
				id : id,
				resId : resId
			}, function(data) {
				if (data.flag == "1") {
					layer.msg("删除失败，该试卷已被某次考试使用，无法删除", {
						icon : 0
					});
				} else {
					layer.confirm("确定要删除吗？", {
						btn : [ '确定', '取消' ]
					//按钮
					}, function() {
						$.get("/zhbg/xxkh/xxkhPaperInfo/delete", {
							id : id,
							resId : resId
						}, function(data) {
							if (data.flag == "1") {
								layer.msg("删除成功！", {
									icon : 1
								});
								TableInit.refTable('right_table');
							} else {
								layer.msg("删除失败", {
									icon : 0
								});
							}
						})
					});
				}
			})

		},
		select : function() {
			var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
			var nodeId = "";
			if (nodes.length > 0) {
				nodeId = nodes[0].id
			}
			var opt = {
				url : "/zhbg/xxkh/xxkhPaperInfo/list?type=" + parameter.treeType + "&name=" + $("#name").val() + "&difficultyLevel=" + $("#difficultyLevel").val() + "&nodeId="
						+ nodeId + "&zz=" + Math.random()
			};
			$('#right_table').bootstrapTable('refresh', opt);
		},
		chongzhi : function() {
			$("#name").val("");
			$("#difficultyLevel").val("");
			//var opt = {
			//        url:"/zhbg/xxkh/xxkhPaperInfo/list?type="+parameter.treeType+"&name="+$("#name").val()+"&difficultyLevel="+$("#difficultyLevel").val()
			//    };
			// $('#right_table').bootstrapTable('refresh',opt);

		}
	}
</script>
