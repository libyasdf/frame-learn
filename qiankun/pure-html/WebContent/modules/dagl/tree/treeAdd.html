<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="/static/core/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" href="/static/core/bootstrapvalidator/dist/css/bootstrapValidator.min.css"/>
	<link rel="stylesheet" href="/manage/bootstrap/css/bootstrap-select.min.css"/>
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	<title></title>
	<style>
		.glyphicon-ok:before {
			content: "\e013";
			color: green;
		}
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-12">
				<form id="form" class="form-horizontal" style="margin-top: 15px;">

					<div class="form-group">
						<label class="col-sm-offset-1 col-sm-2 control-label">
							<b style="color: red;">*</b> 分类名称：</label>
						<div class="col-sm-7">
							<select class="form-control" id="select" onchange="getValue()">
								<option value="">--请选择--</option>

							</select>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-offset-1 col-sm-2 control-label">
							<b style="color: red;">*</b> 分类值：</label>
						<div class="col-sm-7">
							<!--<select class="form-control" id="select1"  >
								<option value="">&#45;&#45;请选择&#45;&#45;</option>
								
							</select>-->
							<select class="selectpicker form-control" multiple id="select1" title="--请选择--">
								<!--<option value="1">广东省</option>
								<option value="2">广西省</option>
								<option value="3">福建省</option>
								<option value="4">湖南省</option>
								<option value="5">山东省</option>-->
							</select>

						</div>
					</div>
					<!--查询项输入框选择框等结束-->

					<!--查询重置等按钮-->
					<div class="form-group">
						<div class="col-sm-12" style="text-align: center">
							<button id="saveButton" type="button" class="btn btn-primary" onclick="saveDictionary()">
								保&nbsp;&nbsp;存
							</button>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
							<button type="button" class="btn btn-primary" onclick="closeIfram();">
								关&nbsp;&nbsp;闭
							</button>
						</div>
					</div>
					<!--查询重置等按钮 end-->
				</form>
			</div>
		</div>
	</div>
<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
<script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
<script src="/manage/bootstrap/js/bootstrap-select.js"></script>
<script src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
<script src="/static/core/layer/layer.js"></script>
<script type="text/javascript" src="/modules/dagl/tree/js/dictionaryTypeTree.js"></script>
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<script type="text/javascript" src="/common/js/commonFunction.js"></script>
<script type="text/javascript" src="/static/js/common/displayData.js"></script>
<script src="/static/js/common/assistUtil.js"></script>
<!-- 音视频系统ip -->
<script type="text/javascript" src="/common/js/config.js"></script>
<script type="text/javascript">
var theRequest;
	 $(function () {
		 theRequest = GetRequest();
	    // 初始化参数
		$.ajax({
    		type: "get",
    		url:"/dagl/bmgl/findAdd",
    		data:{tName:theRequest.tName},
    		async: false,
    		dataType:"json",
    		success:function(data){
    			console.log(data)
    			for(var i in data){
    			    //下拉框，且为表单项，并且不包含全宗号类别号的。（因为全宗号类别号本来就是树的一部分）
    				if(data[i].COLUMN_INPUT_TYPE=="S" && data[i].COLUMN_VISIBLE=="T" && data[i].COLUMN_NAME != "fonds_no" ){
    					if(data[i].COLUMN_NAME != "basefolder_unit"){
    						$("#select").append("<option value="+data[i].COLUMN_NAME+" data-value="+data[i].COLUMN_SELECT_NO+" >"+data[i].COLUMN_CHN_NAME+"</option>")
    					}
    				}
    			}
    			$("#select").append("<option value='filing_year'>归档年度</option>")
    		}
    	});
    }) 

	//关闭当前窗口
	function closeIfram(){
        var index=parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
	}
	
	function saveDictionary(){
		if($("#select").val()==""){
			layer.msg("请选择分类名称",{icon:0})
			return;
		}
		if($("#select1").val()==null){
			layer.msg("请选择分类值",{icon:0})
			return;
		}
		if(theRequest.columnName==$("select").val()){
			layer.msg("无法在此节点添加相同的分类名称",{icon:0})
			return;
		}
		//parent.typeTree.addNode({id:"1",pId:theRequest.pId,name:$("#select1").find("option:selected").html(),column_name:$("#select").val(),columnValue:$("#select1").val(),categoryCode:theRequest.categoryCode})

		var columnValue = $("#select1").val();
		var columnValues = "";
		for(var j =0;j<columnValue.length;j++){
            columnValues+= columnValue[j]+",";
		}
		if("" != columnValues){
            columnValues = columnValues.substring(0,columnValues.length-1);
		}
		$.ajax({
    		type: "get",
    		url:"/dagl/bmgl/addTree",
    		data:{pId:theRequest.pId,name:$("button[data-id=select1]").attr("title"),columnName:$("#select").val(),columnValue:columnValues,categoryCode:theRequest.categoryCode,isAdmin:theRequest.isAdmin},
    		async: false,
    		dataType:"json",
    		success:function(data){
    				if(data.flag==1){
    				    for(var i=0;i<data.data.length;i++){
                            parent.typeTree.addNode({id:data.data[i].id,pId:data.data[i].pId,name:data.data[i].name,columnName:data.data[i].columnName,columnValue:data.data[i].columnValue,categoryCode:data.data[i].categoryCode})
						}
    					layer.msg("保存成功！", {icon: 1,time:1000}, function (index){
							//关闭当前窗口
                            closeIfram();
                        });
    				}else{
    					layer.msg("保存失败", {icon: 0,time:1000}, function (index){
							//关闭当前窗口
                            //closeIfram();
                        });
    				}																																														
    		}
    	});
	}
	function getValue(){
        $("#select1").empty();
		if($("#select").val()=="filing_year"){
			var date = new Date();
			var year = date.getFullYear();
			for(var i=0;i<=year-1980;i++){
				$("#select1").append("<option value="+(date.getFullYear()-i)+">"+(date.getFullYear()-i)+"</option>")
			}

		}else if($("#select").val()!=""){
			var map=Dictionary.getNameAndCode({mark:$("#select").find("option:selected").attr("data-value"),type:"1"});
			for(key in map){
				$("#select1").append("<option value="+key+">"+map[key]+"</option>")
			}
		}

        $('#select1').selectpicker('refresh');//调用刷新实例后触发此事件。
        //$('#select1').selectpicker('render');//渲染实例被调用后触发此事件。
        //获取已经选中的做回显
        //$(".selectpicker").selectpicker ('val',['2019','2018']).trigger("change");
        $.ajax({
            type: "get",
            url:"/dagl/bmgl/findVirtualClass",
            data:{pId:theRequest.pId,columnName:$("#select").val(),categoryCode:theRequest.categoryCode,isAdmin:theRequest.isAdmin},
            async: false,
            dataType:"json",
            success:function(data){
                if(data.flag==1){
                    var selectData = [];
                    for(var i=0;i<data.data.length;i++){
                        if("" != data.data[i]){
                            selectData.push(data.data[i].columnValue) ;
						}
                    }
                    //获取已经选中的做回显
                    $(".selectpicker").selectpicker ('val',selectData).trigger("change");
                }else{
                    layer.msg("查询虚拟分类失败！", {icon: 0,time:1000}, function (index){
                        //关闭当前窗口
                        //closeIfram();
                    });
                }
            }
        });
	}
</script>
</body>
</html>