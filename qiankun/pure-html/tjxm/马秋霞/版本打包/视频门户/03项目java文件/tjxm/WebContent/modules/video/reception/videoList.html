<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>视频列表</title>
		<link rel="stylesheet" type="text/css" href="/modules/video/reception/css/bootstrap.css">
		<link href="/modules/video/reception/css/style.css" rel="stylesheet">
		<link href="/modules/video/reception/css/videoList.css" rel="stylesheet">
	</head>
	<body>
		<div class="ysp-header">
			<div class="logocon clearFloat">
				<img src="images/logo-ysp.png" class="fl" />
				<div class="fl searchBox">
					<input type="text" name="" id="searchText" value="" />
					<input type="button" id="search" onclick="search('1')" value="搜索" />
				</div>
				<div class="userBox fr">
					<img id="userImg" src="/static/images/login_user.png" width="40" height="40" alt="" style="border-radius:50%;"  />
					<span id="userInfo" class="userInfo"></span>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/main.html" >个人门户</a>&nbsp;&nbsp;|
					<a href="#" onclick="logout()">注销</a>&nbsp;&nbsp;
				</div>
				<button class="history fr" id="history"><img src="images/lishi.png" />&nbsp;&nbsp;观看历史</button>
			</div>
		</div>
		<div class="ysp-nav">
			<ul class="ysp-navList clearFloat" id="columns">
				<li class="fl" onclick="nav('1')">首页</li>
				
			</ul>
		</div>
		<div class="ysp-con">
			<p class="title" id="title"></p>
			<div class="yspList clearFloat" >
				<ul class="yspList-right clearFloat" id="uls">
					
					
					
					
				</ul>
			</div>
			<!-- 分页 -->
			<div id="pageBox" class="pageBox"></div>
		</div>
		<div class="ysp-footer">
			<p>
				<a href="#">关于本站</a>丨
				<a href="#">网站地图</a>丨
				<a href="#">网络运维</a>丨
				<a href="#">添加收藏</a>
			</p>
			<p>联系电话：0311-XXXXXXXX</p>
		</div>
		<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
		<script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
		<script src="/static/core/layer/layer.js"></script>
		<script src="/modules/video/reception/js/jquery.pagination.min.js"></script>
	<script src="/modules/video/reception/js/displayVideo.js"></script>
		<script type="text/javascript" src="/common/js/getrequest.js" ></script>
		<script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
		<script src="/common/js/config.js"></script>
		<script type="text/javascript">
	
			var columnId;
			var columnName;
			var flag;
			$(document).ready(function(){
				//获取用户头像
				$.ajax({
					type: 'get',
					url: '/user/getUserImg',
					dataType: "json",
					success: function(data) {
						if (data.flag) {
							$("#userImg").prop("src",data.path);
						} else {
							$("#userImg").prop("src","/static/images/login_user.png");
						}
					},
					error: function() {
						$("#userImg").prop("src","/static/images/login_user.png");
					}
				});
				$("#userInfo").text(getcookie("usernm"))
				//alert(getcookie("usernm"))
				var theRequest = GetRequest();
				columnId = theRequest.columnId;
				columnName = theRequest.columnName;
				flag = theRequest.flag
				if(flag=='1'){
					//点击搜索跳转过来
					$("#searchText").val(columnName)
				}
				loadHistory("0");
				$.post("/video/background/column/getHomePageColumns", {},function(data){
					//设置导航栏标题
					for(var i=0;i<data.length;i++){
						if(data[i].id==columnId){
							columnName=data[i].columnName;
							//$("#title").text(data[i].columnName)
							str = "<li class='fl checked' id='" + data[i].id + "'  onclick='nav(\""+data[i].id+"\")'>" + data[i].columnName + "</li>";
						}else{
							str = "<li class='fl' id='" + data[i].id + "'  onclick='nav(\""+data[i].id+"\")'>" + data[i].columnName + "</li>";
						}
						 
						$("#columns").append(str)
						str=""
					}
				})
				 loadData(columnId,flag,columnName)
				
			})
			
			//加载内容数据
			function loadData(columnId,flag,columnName){
				if(flag=="1"){
					//点击的是搜索
					$("#columns li").removeClass('checked')
				}
				//视频门户首页导航栏上的栏目
				var str;
				var columnName;
				 //历史记录
                //loadHistory("0");
				
					//设置页面显示数据
					var lis;
					var total;
					$.post("/video/content/getHomePageContent", { columnId: columnId, pageNumber: 1,pageSize:12,flag:flag,columnName:columnName },function(data){
						console.info(data)
						 $("#uls").empty();
						var data1 = data.data.pageData.data.rows;
						 total = data.data.pageData.data.total;
						 if(total!=0 && flag!='1'){
							 //$("#title").text(columnName)
						 }
						 var pageNumber = data.data.pageData.pageNumber;
						 var pageSize = data.data.pageData.pageSize;
						 var totalPage = data.data.totalPage
						 
						 
						for(var i=0;i<data1.length;i++){
							lis="<li class='fl' onclick='display(\""+data1[i].id+"\",\""+data1[i].uuid+"\",\""+data1[i].fileName+"\",\""+data1[i].title+"\",\""+data1[i].videoId+"\")' ><div class='imgBox'><img src='" + data1[i].imgPath + "' /></div><div class='articleTitle'><h4>" + data1[i].title + "</h4><div class='bofangliang'>播放量<span id='" + data1[i].id + "'>" + data1[i].playTimes + "</span></div></div></li>"
							//alert(lis)
							$("#uls").append(lis)
						}
						 //alert(totalPage)
						$("#pageBox").pagination({
							currentPage: pageNumber,
							totalPage: totalPage,
							isShow: true,
							count: pageSize,
							homePageText: "首页",
							endPageText: "尾页",
							prevPageText: "上一页",
							nextPageText: "下一页",
							callback: function(current,a,b,c,d) {
								$.post("/video/content/getHomePageContent", { columnId: columnId, pageNumber: current,pageSize:12,flag:flag,columnName:columnName },function(data){
									var data1 = data.data.pageData.data.rows;
									 $("#uls").empty();
									for(var i=0;i<data1.length;i++){
										lis="<li class='fl' onclick='display(\""+data1[i].id+"\",\""+data1[i].uuid+"\",\""+data1[i].fileName+"\",\""+data1[i].title+"\",\""+data1[i].videoId+"\")' ><div class='imgBox'><img src='" + data1[i].imgPath + "' /></div><div class='articleTitle'><h4>" + data1[i].title + "</h4><div class='bofangliang'>播放量<span id='" + data1[i].id + "'>" + data1[i].playTimes + "</span></div></div></li>"
										$("#uls").append(lis)
									}
								} );
								
							}
						});
					} );
				
			}
			//导航栏点击切换效果
			function nav(columnId){
				$("#columns li").removeClass('checked')
				$("#columns li[id='"+columnId+"']").addClass('checked')
				//$(this).addClass('checked');
				//$(this).siblings('li').removeClass('checked');
				//alert($(this).siblings('li').length)
				if(columnId!='1'){
					loadData(columnId,"","")
					//window.location="/modules/video/reception/videoList.html?columnId="+columnId
				}else{
					window.location="/modules/video/reception/videoHomePage.html"
				}
				
			}
			
			//添加历史查看记录
			function addHistory(id){
				$.post("/video/background/historyRecord/save", { contentId: id},function(){
					
				} );
			}
			//注销
			function logout(){
				document.location.href = Config.sso_logout_url+"?gotoURL="+path;
			}
			//搜索
			function search(flag){
				if($("#searchText").val()){
					 loadData("",flag,$("#searchText").val())
					//window.location="/modules/video/reception/videoList.html?columnName="+$("#searchText").val()+"&flag="+flag
				}else{
					//alert("2")
					layer.msg("请输入搜索内容！", {icon: 0});
				}
				
			}
			// 加载历史记录
            function loadHistory(flag) {
                //console.info("历史记录")
                var historyStrs;
                $.post("/video/background/historyRecord/getLastestHistoryRecord", {}, function (data) {
                    //console.info(data)

                    var data = data.data
                    if (data.length > 0) {
                        $("#historyList").empty();
                        if (flag == "0") {
                            $("#history").append("<ul class='history-list' id='historyList'></ul>")
                        }
                        for (var i = 0; i < data.length; i++) {
                            historyStrs = "<li onclick='intoIndex(\"" + data[i].contentId + "\",\"" + data[i].videoId + "\",\"" + data[i].fileName + "\",\"" + data[i].contentTitle + "\",\"" + data[i].uuid + "\")'><p>" + data[i].contentTitle + ":" + data[i].fileName + "</p></li>"
                            $("#historyList").append(historyStrs)
                        }
                        $("#history").append("<span class='history-triangle glyphicon glyphicon-triangle-top'></span>")
                    }



                });
            }
        	//播放
			function display(id,uuid,fileName,title,videoId){
				
				displayFile(id,uuid,fileName,title,videoId);
			}
			function displayFile(id,fileUuid,fileFullName,title,videoId){
				//alert(videoId)
				//判断当前用户是否可以再打开一个页面结束
					var getVideoUrl = Config.hBServerIp+"/api/v1/load_balancer/vod_play_url?AccessToken="+Config.AccessToken
						+"&OriginalFileUuid="+fileUuid+"&ServiceType=vod_http&FileExtName=.mp4";
				
					$.ajax({
						type:"GET",
						url:getVideoUrl,
						async: true,
						//dataType:"json",
						contentType: "application/x-www-form-urlencoded; charset=UTF-8",
						success:function(data){
							/* //当前电脑不存在学习页面
							if(isRecord == "1"){
								setCookie("isLearning","isLearning");
							} */
							
							
							
							//获取播放地址并转码
							var videoUrl = encodeURIComponent(data[0].Url);
							//window.open("/modules/video/reception/displayVideoAndPdf/playVideo.html?videoUrl="+videoUrl+"&infoId="+id+"&infoName="+encodeURIComponent(title)+"&fileFullName="+encodeURIComponent(fileFullName));
							window.open("/modules/video/playVideo/index.html?videoUrl="+videoUrl+"&infoId="+id+"&infoName="+encodeURIComponent(title)+"&videoId="+videoId+"&fileFullName="+encodeURIComponent(fileFullName));
							//window.location="/modules/video/playVideo/index.html?videoUrl="+videoUrl+"&infoId="+id+"&infoName="+encodeURIComponent(title)+"&videoId="+videoId+"&fileFullName="+encodeURIComponent(fileFullName)
						},
						error:function(data){
							layer.msg("视频还未转码成功，稍后再试！", {icon: 0});
						}
					});

			}
			
			function intoIndex(contentId,videoId,fileName,contentTitle,uuid){
				//判断当前用户是否可以再打开一个页面结束
				var getVideoUrl = Config.hBServerIp+"/api/v1/load_balancer/vod_play_url?AccessToken="+Config.AccessToken
					+"&OriginalFileUuid="+uuid+"&ServiceType=vod_http&FileExtName=.mp4";

				$.ajax({
					type:"GET",
					url:getVideoUrl,
					async: true,
					//dataType:"json",
					contentType: "application/x-www-form-urlencoded; charset=UTF-8",
					success:function(data){
						//获取播放地址并转码
						var videoUrl = encodeURIComponent(data[0].Url);
						//window.open("/modules/video/playVideo/index.html?videoUrl="+videoUrl+"&infoId="+id+"&infoName="+encodeURIComponent(title)+"&videoId="+videoId+"&fileFullName="+encodeURIComponent(fileFullName));
						window.location="/modules/video/playVideo/index.html?videoUrl="+videoUrl+"&infoId="+contentId+"&infoName="+encodeURIComponent(contentTitle)+"&videoId="+videoId+"&fileFullName="+encodeURIComponent(fileName);
					},
					error:function(data){
						layer.msg("视频还未转码成功，稍后再试！", {icon: 0});
					}
				});
			}
		</script>
	</body>
</html>