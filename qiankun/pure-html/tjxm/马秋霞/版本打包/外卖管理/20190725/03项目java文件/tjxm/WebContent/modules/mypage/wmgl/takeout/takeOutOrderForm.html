<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    
    <title></title>
    <link rel="stylesheet" type="text/css" href="/static/css/common/Loading.css">
    <link rel="stylesheet" href="/static/core/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/core/bootstrapvalidator/dist/css/bootstrapValidator.min.css"/>
    <link rel="stylesheet" href="/static/core/jquery-fileupload/css/jquery.fileupload.css">
     <link href="/static/core/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="/static/core/bootstrap-table/bootstrap-table.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/static/font/iconfont.css">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link href="/static/core/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/core/layer/theme/default/layer.css">
    <link rel="stylesheet" href="/static/css/gateway/reset.css">
    <link rel="stylesheet" href="/static/font/iconfont-gateway/iconfont.css">

    <!-- style.css -->
    <link href="/static/css/common/style.css" rel="stylesheet">
    <link href="/static/css/common/form-public.css" rel="stylesheet">
    <link href="/static/css/common/index.css" rel="stylesheet">

    <!-- 滚动条 -->
    <link rel="stylesheet" href="/static/core/mCustomScrollbar/jquery.mCustomScrollbar.css">

    <!-- 获取url -->
    <script src="/static/js/common/url.js" type="text/javascript"></script>

    <!-- 开关配置 -->
    <link rel="stylesheet" type="text/css" href="/modules/system/config/toggle/css/toggleStyle.css">
    <link href="/static/core/font-awesome-4.7.0/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <link href="/static/core/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
		.line-span{ white-space:pre-wrap;word-wrap : break-word ;overflow: hidden ;text-align:left}
		.hidden{
			display:none !important;
			visibility:hidden !important
		}
		/* #table_list tr {
	 		text-align:center
		} */
		.horizontal .control-label{
			    padding-top: 7px;
    			margin-bottom: 0;
    			text-align: right;
		}
		.horizontal .radio-inline{
				padding-top: 7px;
    			margin-bottom: 0;
    			text-align: right;
		}
	</style>
</head>
<body class="formpage_bj">
<div class="container-fluid formpage_area">
    <form class="form-horizontal" id="form">
        <!-- 流程字段-->
		<input name="id" id="id" type="hidden" value=""/><!-- 工作项ID -->
		<input name="categoryId" id="categoryId" type="hidden" value=""/>
		
		
		<!-- 流程字段结束 -->
        <!-- 基本信息 -->
        <div class="row">
            <div class="col-md-12 ">
                <div class="block_title">
                    <span class="name">外卖信息</span>
                </div>
            </div>
        </div>
        <div class="row m-t-15">
            <div class="col-md-12">
                <div class="form-group">
                	<div class="rowGroup">
	                    <label class="col-md-2 control-label"> 外卖名称：</label>
	                    <div class="col-md-4 form-view">
	                        <span id="name" name="name"></span>
	                    </div>
                    </div>
                	<div class="rowGroup">
	                    <label class="col-md-2 control-label"> 主题：</label>
	                    <div class="col-md-4 form-view">
	                        <span id="title" name="title"></span>
	                    </div>
                    </div>
                </div>
                <div class="form-group">
                    	<div class="rowGroup">
                            <label for="" class="col-md-2 control-label"> 最晚下单时间：</label>
                            <div class="col-md-4 form-view"  >
                               <span id="deadlineTime" name="deadlineTime"></span>
                            </div>
                        </div>
                        <div class="rowGroup">
                            <label for="" class="col-md-2 control-label" > 取餐时间：</label>
                            <div class="col-md-4 form-view" >
                                 <span id="takeFoodTime" name="takeFoodTime"></span>
                            </div>
                        </div>
                 </div>              
                <div class="form-group">
                    <label class="col-md-2 control-label">注意事项：</label>
                    <div class="col-md-10 form-view">
                    	<span id="attentionItem" name="attentionItem" class="line-span"></span>
                    </div>
                </div>
           
                <div class="form-group">
                    <label class="col-md-2 control-label">备注：</label>
                    <div class="col-md-10 form-view">
                    	<span id="mark" name="mark" class="line-span"></span>
                    </div>
                </div>
                </div>
                </div>
         </form>       
               
                
                <!--文件上传end-->
                
	               <div class="modal-body selectjs" style="padding-left:0px;padding-top:30px;padding-bottom:0px">
	               		<div class="block_title">
							<div class="selectjs_block" style="height: 100%;">
									<div class="title_tab">
										<ul class="nav nav-tabs" id="nav">
											<li class="active" for="formpage1"><a href="#"
												data-toggle="tab"> 订单确认</a></li>
											<li for="formpage2"><a href="#" data-toggle="tab"> 商品汇总 </a>
											</li>
										</ul>
									</div>
						  	</div>
					  </div>
					</div>
				
            <div class="modal-body selectjs" style="padding-left:0px;padding-bottom:0px">
				<div class="selectjs_block" style="height: auto;">
					
					
					<div class="container-fluid main" style="height:auto">
						<div class="row"  id="formpage1">
							<!--查询-->
								<form  id="domForm" class="horizontal">
									<input id="takeOutId1" name="takeOutId" type="hidden">
									<input name="resId"  type="hidden"/> 
									<div class="col-md-12">
										<div class="panel panel-default toggle">
											<div class="panel-heading" style="cursor: pointer;">
												<h3 class="panel-title" style="display: inline-block;">查询项</h3>
												<div class="panel-controls " style="display: inline-block;position: absolute; right: 30px;">
													<i class="glyphicon glyphicon-plus showSelect"></i>
												</div>
											</div>
											<div class="panel-body" style="display: none;">
											<input id="takeId" name="takeId" type="hidden">
												<div class="form-group">
													<label class="col-md-2 control-label" > 门禁卡号：</label>
													<div class="col-md-4">
													<input class="form-control" type="text" id="cardNo" name="cardNo" />
													</div>
													<label class="col-md-2 control-label" > 订单号：</label>
													<div class="col-md-4">
														<input class="form-control" type="text" id="orderNum" name="orderNum" />
													</div>
													
												</div>
												<div class="form-group">
													<label class="col-md-2 control-label" > 订单状态：</label>
													<div class="col-md-5">
														<label class="radio-inline">
															<input type="radio" id="inlineRadio1" name="status1" value="" checked="checked"> 全部
														</label>
														<label class="radio-inline">
															<input type="radio" id="inlineRadio2" name="status1" value="1"> 已下单
														</label>
														<label class="radio-inline">
															<input type="radio" id="inlineRadio3" name="status1" value="3"> 已领取
														</label>
														<label class="radio-inline">
															<input type="radio" id="inlineRadio4" name="status1" value="4"> 未领取
														</label>
														<label class="radio-inline">
															<input type="radio" id="inlineRadio5" name="status1" value="2"> 已取消
														</label>
													</div>
												</div>
												<!--查询重置等按钮-->
												<div class="form-group">
													<div class="col-md-12" style="text-align: center;padding-top: 20px;">
														<button type="button" class="btn btn-primary"
																onclick="TableInit.refTable('right_table')"> 查&nbsp;&nbsp;询
														</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
														<button type="reset" class="btn btn-primary"> 重&nbsp;&nbsp;置
														</button>
													</div>
												</div>
											</div>
										</div>
									</div>
								</form>
								<!--查询结束-->
						
								<div class="col-md-12">
									<div class="list_button_area">
										
										<button class="list_table_btn2"
												onclick="updateOrdersState('4');">
											<span class="glyphicon glyphicon-remove"></span> 未领取 
										</button>
										<button class="list_table_btn2"
												onclick="updateOrdersState('2');">
											<span class="glyphicon glyphicon-trash"></span> 取消
										</button>
										<button class="list_table_btn2"
												onclick="exportDate();">
											<span class="glyphicon glyphicon-chevron-right"></span> 导出
										</button>
										
										
									</div>
									<!--bootstrap-table表格-->
									<table id="right_table"></table>
								</div>
							</div>
							
							<div class="row hidden"  id="formpage2"  >
								
								<!--查询结束-->
								<div class="title_tab" style="margin-left: 15px;">
					                	<ul class="nav nav-tabs" id="category" style="display:inline-block;margin-right:0;">
										 	 
										</ul>
										<button class="list_table_btn2" onclick="exportCollectData();" style="vertical-align:top;height:40px;box-sizing:border-box;margin-left:-4px">
											<span class="glyphicon glyphicon-chevron-right"></span> 导出
										</button>
										
								</div>
								<div class="col-md-12">
									<form  id="form2">
										<input id="takeOutId" name="takeOutId" type="hidden">
										
									</form>
									<div class="list_button_area"></div>
									<div id="table2">
										<table id="right_table2"></table>
									</div>
									
								</div>
							</div>
				</div>
				</div>
		</div>
            
                
                
                
            </div>
        <!-- </div> -->
        <!-- 基本信息结束 -->
   <!--  </form> -->
    
<!-- </div> -->

<!-- 按钮区 -->

<!-- 按钮区结束 -->
<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
<script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
<script src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
<script src="/static/core/layer/layer.js"></script>
<script src="/static/js/common/mylayer.js"></script>
<script type="text/javascript" src="/static/js/common/assistUtil.js"></script>

<script src="/static/core/laydate/laydate.js"></script>
<!-- 流程相关 -->
<script type="text/javascript" src="/common/js/config.js"></script>
<script type="text/javascript" src="/product/workflow/js/storages.js"></script>
<script type="text/javascript" src="/common/js/commonFunction.js"></script>
<script type="text/javascript" src="/common/html/notion/notion.js"></script>
<!-- 获取cookie值 -->
<script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
<!-- 页面获取参数 -->
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<!-- 引入自己模块功能的js -->
<script type="text/javascript" src="/modules/mypage/wmgl/takeout/js/takeOutOrderForm.js"></script>
<!-- 数据渲染 -->
<script src="/static/js/common/displayData.js"></script>

<!--文件上传js-->
<script src="/static/core/jquery-fileupload/js/vendor/jquery.ui.widget.js"></script>
<script src="/static/core/jquery-fileupload/js/jquery.iframe-transport.js"></script>
<script src="/static/core/jquery-fileupload/js/jquery.fileupload.js"></script>
<script src="/static/js/common/tablelist.js"></script>
<script src="/static/js/common/myfilupload.js"></script>
<!--文件上传js end-->
<script type="text/javascript">
var right_table_col2 = [
	
	{
    field: 'id'
    , title: '序号'
    , width: '15%'
     , align:"center"
    , formatter: function (value, row, index) {
        //计算序号，并存放业务ID，及已办事项ID
        var pageSize=$('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
        var pageNumber=$('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
        var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
        return "<span data-id='"+row.goodsId+"' data-workitemid='"+row.yibanid+"'>"+orderNum+"</span>";    //返回每条的序号： 每页条数 * （当前页 - 1 ）+ 序号
    }
},

    {
        field: 'goodsName' 
       , title: '商品'
       , width: '35%'
       , align:"center"
    },
    {
        field: 'goodsNum' 
       , title: '数量'
       , width: '50%'
       , align:"center"
    	, formatter: function (value, row, index) {
   	    	return value + "" + row.bugUnit
            	
         }
    }];
    
    
var right_table_col = [
	{
		title : "",
		width : '4%',
		align : "center",
		checkbox : "true",
		formatter : function(value, row, index) {
			 if (row.status == "2" || row.status == "4" )
		         return {
		             disabled : true,//设置是否可用
		     };
		}
	},
	{
    field: 'id'
    , title: '序号'
    , width: '5%'
    , align:"center"
    , formatter: function (value, row, index) {
        //计算序号，并存放业务ID，及已办事项ID
        var pageSize=$('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
        var pageNumber=$('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
        var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
        return "<span data-id='"+row.id+"' data-workitemid='"+row.yibanid+"'>"+orderNum+"</span>";    //返回每条的序号： 每页条数 * （当前页 - 1 ）+ 序号
    }
},{
    field: 'orderNum'
    , title: '订单号'
    , width: '13%'
    ,sortable: true
    , align:"center"
},

    {
        field: 'cardNo' 
       , title: '门禁卡号'
       , width: '12%'
    	,sortable: true
       , align:"center"
    },
    {
        field: 'goodsName' 
       , title: '购买商品'
       , width: '33%'
       , align:"center"
    	, formatter: function (value, row, index) {
           	if(value!=null){
           		var length = value.length
   	  	   	      var val = '';
   	  	   	      if(length>25){
   	  	   	    	  val = value.substring(0,24)+"...";//
   	  	   	      }else{
   	  	   	    	  val = value;
   	  	   	      }
     	   	   		return  "<span >"+val+"</span>";
           	}else{
           		return "-";
           	}
         }
    },
    {
        field: 'phone' 
       , title: '联系电话'
       , width: '14%'
       , align:"center"
    },
   /*  {
        field: 'jine' 
       , title: '金额/元'
       , width: '10%'
       , align:"center"
    }, */
{
    field: 'status'
    , title: '订单状态'
    , width: '10%'
    , align:"center"
    , formatter: function (value, row, index) {
	    	if(value=='1') return '已下单'
	     	else if(value=='2')return '已取消'
	     	else if(value=='3')return '已领取'
	     	else return '未领取'
         	
      }
},
{
    field: 'cz'
    , title: '操作'
    , width: '15%'
    , align: "center"
    , formatter: function (value, row, index) {  //直接定义function,return就是html代码
    	var html = "";
        if(row.status=='1' || row.status=='3'){//已下单或已领取
        	if(row.status=='1'){
            	html += "<i class='glyphicon glyphicon-ok' data-cz='qx' onclick=\'list.updateState(\""	+ row.id + "\",\"3\")\' title='已领取'></i>&nbsp;&nbsp;";
        	}
        	html += "<i class='glyphicon glyphicon-remove' data-cz='wlq' onclick=\'list.updateState(\""	+ row.id + "\",\"4\",\""	+ row.creUserId + "\")\' title='未领取'></i>&nbsp;&nbsp;";
        	html += "<i class='glyphicon glyphicon-trash' data-cz='lx' title='已取消' onclick=\'list.updateState(\""	+ row.id + "\",\"2\")\'></i>&nbsp;&nbsp;";
        }
        return html;
    }
}];
//状态(1:已下单；2：已取消；3：已领取；4：未领取)
var list = {
		updateState : function(id,status,creUserId) {
			 var resId = $('#left_ul').find('a.active').attr("id");
			 var msg="未领取";
			 if(status=='3'){
				 msg="已领取";
			 }else if(status=='2'){
				 msg="已取消";
			 }
			 layer.confirm("确定设置为"+msg+"吗？", {
			        btn: ['确定', '取消']
			        // 按钮
			    }, function () {
			    	$.ajax({
			    		url:"/mypage/wmgl/index/order/updateState",
			    		data:{"ids":id,"resId":resId,"orderUserId":creUserId,"status":status},
			    		success:function(json){
			    			if(status=='3') layer.msg("已领取！", {icon: 1});
			    			if(status=='4') layer.msg("未领取！", {icon: 1});
			    			if(status=='2') layer.msg("已取消！", {icon: 1});
			    			TableInit.refTable('right_table')
			    		},
			    		error:function(){
			    			if(status=='3') layer.msg("已领取异常！", {icon: 1});
			    			if(status=='4') layer.msg("未领取异常！", {icon: 1});
			    			if(status=='2') layer.msg("已取消异常！", {icon: 1});
			    			
			    		}
		    		});
			    }, function () {

			    });
		}
		
  }
var total=0;
$(document).ready(function (e) {
    //初始化表格
    TableInit.init({
        domId:"right_table",
        url:"/mypage/wmgl/index/order/getOrderList",
        sortable: true,    
        columns:right_table_col,
        queryParams:function(params){
        	params.takeOutId = $("#id").val();
        	params.cardNo = $("#cardNo").val();
        	params.orderNum = $("#orderNum").val();
        	params.status = $("input[name='status1']:checked").val();
        	  return params;
        },
        readOnlyFn:function(){
        	var resId = $('#left_ul').find('a.active').attr("id");
        	$('#right_table tr.readOnly').find('td:last').css('cursor','default');
        	$('#right_table tr.readOnly').find('td:last').find('i').css('cursor','pointer');
        	$('#right_table input[name="btSelectItem"]:not(:disabled)').css('cursor','pointer');
        	$('#right_table input[name="btSelectAll"]').css('cursor','pointer');
        	$('#right_table tr.readOnly').find('td:not(:first)').unbind('click').bind('click',function(e){
        		  var index = $(this).index(); 
        		  
        		  if(index==7){
        			  return;
        		  }
                   var id = $(this).parent().find("span[data-id]").attr("data-id");
					MyLayer.layerOpenUrl({
						url : '/modules/mypage/wmgl/takeout/orderReadOnlyForm.html?id=' + id + '&oper=EDIT&resId=' + resId,
						title : "查看订单信息"
					})
            });
	         $('#right_table tr.readOnly').find('td:not(:last,:first)').bind('mouseover', function (e) {
	                 $(this).attr("title","点击查看详情") 
	          });
        }
    });

    TableInit.init({
        domId:"right_table2",
        url:"/mypage/wmgl/index/OrderDetil/getCollectInfo",
        columns:right_table_col2,
        queryParams:function(params){
        	params.takeOutId = $("#id").val();
        	params.categoryId = $("#categoryId").val();
            return params;
        },
        rowStyle: function (row, index) {	
            return {
                classes: 'readOnly'
                ,css: {"text-align":"center","cursor":"default"}
            };
        },
        readOnlyFn:function(data){
        	total = data.total;
        	if(total>0){
        		$.post("/mypage/wmgl/index/order/getGoodsNum", { takeOutId:$("#id").val(),categoryId:$("#categoryId").val() },function(data){
        			if(data.flg=='1'){
        				$('#table2 .pull-left').append('，<span><b>共计：' + data.goodsNum + '份</b></span>');
        			}
        		} );
        	}
        }
    });
    $('#nav > li').unbind('click').bind('click', function () {
    	
        var id = $(this).attr('for');
        $(this).addClass('active').siblings('li').removeClass('active');
        $('.main').children().addClass('hidden');
        $('#' + id).removeClass('hidden');
    })
    $('#category > li:not(".export")').unbind('click').bind('click', function () {
    
        $(this).addClass('active').siblings('li').removeClass('active');
        
    })
});

	/**
	 *订单导出按钮的事件
	 */
	function exportDate() {
    	var data = $("#right_table").bootstrapTable("getData");
		if(data.length>0) { 
			layer.confirm("是否导出查询的所有信息？", function(e) {
				layer.closeAll();
				$('#domForm').attr('action','/mypage/wmgl/index/order/export');
				$('#domForm').attr('method','get');
				$("#domForm").submit(); 
			})
		} else {
			layer.msg('暂无可导出信息！', {
				icon : 0
			}); 
		}
	}
	
	//导出商品汇总数据
	function exportCollectData(){
		if(total>0){
			layer.confirm("是否导出查询的所有信息？", function(e) {
				layer.closeAll();
				 $('#form2').attr('action','/mypage/wmgl/index/OrderDetil/export');
				$('#form2').attr('method','get');
				$("#form2").submit(); 
				
			})
		}else{
			layer.msg('暂无可导出信息！', {
				icon : 0
			}); 
		}
		
	}
	
	//批量更新订单状态
	function updateOrdersState(status){
		var selectRows = $('#right_table').bootstrapTable('getSelections');
		var orderIds = [];
		var orderUserIdArry = [];
		if(selectRows.length<=0){
			layer.msg("请选择要更改状态的订单！", {icon : 0});
		}else{
			for(var i=0;i<selectRows.length;i++){
				var orderId = selectRows[i].id;
				orderUserIdArry.push(selectRows[i].creUserId)
				orderIds.push(orderId);
			}
			var orderIdsStr = orderIds.join(",");
			var orderUserIdStr = orderUserIdArry.join(",");
			var resId = $('#left_ul').find('a.active').attr("id");
			 $.ajax({
		    		url:"/mypage/wmgl/index/order/updateState",
		    		data:{"ids":orderIdsStr,"orderUserId":orderUserIdStr,"resId":resId,"status":status},
		    		success:function(json){
		    			if(status=='3') layer.msg("已领取！", {icon: 1});
		    			if(status=='4') layer.msg("未领取！", {icon: 1});
		    			if(status=='2') layer.msg("已取消！", {icon: 1});
		    			TableInit.refTable('right_table')
		    		},
		    		error:function(){
		    			if(status=='3') layer.msg("已领取异常！", {icon: 1});
		    			if(status=='4') layer.msg("未领取异常！", {icon: 1});
		    			if(status=='2') layer.msg("已取消异常！", {icon: 1});
		    			
		    		}
	    	});
		}
	}
</script>
</body>
</html>
