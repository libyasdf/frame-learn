<style type="text/css">
.panel-controls {
	position: absolute;
	right: 40px;
	top: 10px;
}

.panel-controls>i.showSelect {
	font-size: 16px;
	color: #acb1b8;
	cursor: pointer;
}

label {
	font-weight: normal;
}
</style>
<link rel="stylesheet" type="text/css"
	href="/modules/system/config/dictionary/css/vertify.css">
<link rel="stylesheet" type="text/css"
	href="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.css">
<link rel="stylesheet" type="text/css"
	href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css">
<div class="container-fluid">
	<div class="row" style="height: 100%;">
		<!--查询-->
		<div class="vertify-panel vertify-tree x-unselectable"
			role="presentation">
			<div class="inner">
				<!--                 <div class="folderBar">
                    <i class="glyphicon glyphicon-search" onclick="showSearchFrame()" style="font-size:18px;cursor: pointer;" title="查询字典类型"></i>
                </div>
                <div id="searchDiv" class="input-group input-group-sm"
                     style="display:none;padding-left:5px; margin-top: 5px; padding-right: 5px;">
                    <input type="text" id="typeName" class="form-control">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" onclick="searchType();" >查询</button>
                    </span>
                </div>
 -->
				<ul id="treeDemo" class="ztree" style="margin-top: 10px; height: 640px; overflow: auto;">
				</ul>
				<input type="hidden" id="type"/>
			</div>
		</div>
		<div class="vertify-panel vertify-details">
			<form class="form-horizontal">
				<div class="col-md-12">
					<div class="panel panel-default toggle">
						<div class="panel-heading" style="cursor: pointer;">
							<h3 class="panel-title">查询项</h3>
							<div class="panel-controls ">
								<i class="glyphicon glyphicon-plus showSelect"></i>
							</div>
						</div>
						<div class="panel-body" style="display: none;">
							<div class="form-group">
								<label class="col-md-2 control-label"> 部门：</label>
								<div class="col-md-4">
									<input type="text" id="creDeptName" unselectable="on"
											onclick=openSelectZtree({'id':'creDeptId','name':'creDeptName','type':'2','asyn':false,'level':1,'deptId':441,'url':'/system/component/tree/deptTree'}) name="creDeptName"
											class="form-control" placeholder="部门选择"> 
									<input type="hidden" id="creDeptId" name="creDeptId" />
								</div>
								<label class="col-md-2 control-label"> 处室：</label>
								<div class="col-md-4">
				                    <input type="text" id="unitName" name="unitName" unselectable="on" onclick="selectChushi();" class="form-control" placeholder="处室选择">
				                    <input type="hidden" id="unitId" name="unitId" /><!-- 单位ID隐藏域 -->
				               </div>
								
								<!-- <div class="col-md-4">
								   <div class="input-group">
										<input type="text" id="creChushiName" unselectable="on"
											onclick=openSelectZtree({'id':'creChushiId','name':'creChushiName','deptId':$("#creChushiId").val(),'isMulti':'1','type':'2','asyn':true,'cascade':'2','url':'/system/component/tree/getDeptOrUserTree'}) name="creDeptName"
											class="form-control"> 
										<input type="hidden" id="creChushiId" name="creChushiId" />
										单位ID隐藏域
										<span class="input-group-addon" onclick=openSelectZtree({'id':'creChushiId','name':'creChushiName','isMulti':'1','deptId':$("#creChushiId").val(),'type':'2','asyn':true,'cascade':'2','url':'/system/component/tree/getDeptOrUserTree'})>
											<span class="glyphicon glyphicon-user"></span>
										</span>
									</div>
								   <input type="hidden" id="creChushiId" name="creChushiId" />
								   <input class="form-control" type="text" id="creChushiName" name="creChushiName" />
								</div> -->
							</div>

							<div class="form-group">
								<label class="col-md-2 control-label"> 学习日期：</label>
								<div class="col-md-4">
									<input class="form-control" type="text" id="timeRange" name="timeRange" placeholder="学习日期"/>
								</div>
							</div>
							
							<div class="form-group">
							   <!-- <div class="form-group">
			                        <label for="" class="col-md-2 control-label">职务权限选择：</label>
			                        <div class="col-md-8" style="vertical-align: middle;" id="position"></div>
			                    </div> -->
								<!-- <label for="" class="col-md-2 control-label">职务权限：</label>
								<div class="col-md-8" style="vertical-align: middle;">
									<label class="radio-inline"><input type="checkbox" onclick="checkAll()" id="all" name="all" value="全选">全选</label>
									<label class="radio-inline"><input type="checkbox" name="dutyAuthority[]" value="正处长">正处长</label>
									<label class="radio-inline"><input type="checkbox" name="dutyAuthority[]" value="副处长">副处长</label>
									<label class="radio-inline"><input type="checkbox" name="dutyAuthority[]" value="正科长">正科长</label>
									<label class="radio-inline"><input type="checkbox" name="dutyAuthority[]" value="副科长">副科长</label>
									<label class="radio-inline"><input type="checkbox" name="dutyAuthority[]" value="科员">科员</label>
								</div> -->
							</div>
							<div class="form-group">
								<div class="col-md-2" style="width: 100%; text-align: center">
									<button type="button" class="btn btn-primary"
										onclick="searchLearnTime()">
										查&nbsp;&nbsp;询</button>
									&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									<button type="button" class="btn btn-primary"
										onclick="cleanAll()">
										重&nbsp;&nbsp;置</button>
									&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
								</div>
							</div>
						</div>
					</div>
				</div>
			</form>
			<!--查询结束-->

			<div class="col-md-12">
				<!--bootstrap-table表格-->
				<table id="right_table"></table>
			</div>
		</div>
	</div>
</div>
<script
	src="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.js"></script>
<script src="/static/js/common/jquery.tablednd.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.core.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
<!-- <script src="/static/js/common/dictionaryTypeTree.js"></script> -->
<script src="/modules/zhbg/xxkh/tree/js/learningTimeTypeTree.js"></script>
<script src="/modules/zhbg/xxkh/learningTimeCount/js/learningTime.js"></script>
<script type="text/javascript" src="/modules/system/component/tree/js/deptUserTree.js"></script>
<!-- 页面获取参数 -->
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<script type="text/javascript">
//$("#creChushiId").val(getcookie("chuShiId"));
//职务权限全选
function checkAll() {
    var all=document.getElementById('all');
    var one=document.getElementsByName('dutyAuthority[]');
    if(all.checked==true){
        for(var i=0;i<one.length;i++){
            one[i].checked=true;
        }
    }else{
        for(var j=0;j<one.length;j++){
            one[j].checked=false;
        }
    }
}
	//增加字典类型
	function addType(type) {
		// 判断是否已经选择了某个节点
		var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();

		if (nodes.length == 0) {
			layer.msg('请选择字典类型', {
				icon : 0
			});
		} else if (type) {
			var pid = nodes[0].id;
			var mark = nodes[0].mark;
			var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?treeType=fz&type=";
			var title = "";
			if ("0" == type) {
				url = url + "0&pId=" + pid;
				title = "新增字典类型";
			}/*  else if ("1" == type) {
			            url = url + "1&mark=" + mark;
			            title = "新增字典项";
			        } */
			layer.open({
				type : 2,
				shadeClose : true,
				content : url,
				area : [ '770px', '450px' ],
				title : [ title, 'font-size:16px;font-weight:bold;' ]
			})
		}
	}

	//修改字典类型
	function editType() {
		// 判断是否已经选择了某个节点
		var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
		if (nodes.length == 0) {
			layer.msg('请选择字典类型', {
				icon : 0
			});
		} else {
			var id = nodes[0].id;
			var mark = nodes[0].mark;
			var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?id=" + id;
			layer.open({
				type : 2,
				shadeClose : true,
				content : url,
				area : [ '770px', '450px' ],
				title : [ '修改字典类型', 'font-size:16px;font-weight:bold;' ]
			})
		}
	}

	//删除字典类型
	function deletType() {
		// 判断是否已经选择了某个节点
		var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
		if (nodes.length == 0) {
			var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?treeType=fz&type=0";
			var title = "";

			layer.open({
				type : 2,
				shadeClose : true,
				content : url,
				area : [ '770px', '450px' ],
				title : [ title, 'font-size:16px;font-weight:bold;' ]
			})
			// layer.msg('请选择字典类型', {icon: 0});
		} else {
			layer.confirm("确定要删除该类型吗？", function() {
				$.ajax({
					type : "POST",
					url : "/zhbg/xxkh/tree/deleteType",
					data : {
						id : nodes[0].id,
						mark : nodes[0].mark
					},
					dataType : "json",
					success : function(data) {
						if ('1' == data.flag) {
							layer.msg("删除成功！", {
								icon : 1,
								time : 1000
							}, function(index) {
								typeTree.delNode(nodes[0].id);
							});
						} else {
							layer.msg("该类型下有字典项，不可删除！", {
								icon : 5
							});
						}
					},
					error : function(data) {
					}
				});
			});
		}
	}

	//查询字典类型
	function searchType() {
		typeTree.searchNodes($("#typeName").val());
	}
	
	function searchLearnTime(){
		var checkedNodes = $.fn.zTree.getZTreeObj("treeDemo").getCheckedNodes();
		if(checkedNodes.length==0){
			layer.msg('请先选择左侧资料类型', {icon : 0});
			return false;
		  }
		
		TableInit.refTable('right_table');
	}

	// 查询窗口
	function showSearchFrame() {
		var search = $("#searchDiv");
		if (search.is(":hidden")) {
			search.show();
			$("#typeName").focus();
		} else {
			search.hide();
		}
	}

	//参考：http://www.layui.com/laydate/
	//绑定日期输入input
	laydate.render({
		elem : '#time' //指定元素
	});
	//日期范围
	laydate.render({
		elem : '#timeRange',
		range : true
	});

	//定义bootatrap-table数据列
	//    sortable：开启列排序，其他参考API
	var right_table_col = [{
		field : 'id',
		title : '序号',
		width : '5%',
		align : "center",
		formatter : function(value, row, index) {
			//计算序号，并存放业务ID，及已办事项ID
			var pageSize = $('#right_table').bootstrapTable(
					'getOptions').pageSize;//通过表的#id 可以得到每页多少条
			var pageNumber = $('#right_table').bootstrapTable(
					'getOptions').pageNumber;//通过表的#id 可以得到当前第几页
			var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
			return "<span recordId='"+row.id+"'>" + orderNum + "</span>"; //返回每条的序号： 每页条数 * （当前页 - 1 ）+ 序号
		}
	},{
		field : 'creJuName',
		title : '部门',
		width : '10%',
		align : "center"
	}, {
		field : 'creChushiName',
		title : '处室',
		width : '10%',
		align : "center"
	}, {
		field : 'creUserName',
		title : '姓名',
		width : '10%',
		align : "center",
		formatter : function(value, row, index) {
			return "<span data-id='"+row.creUserId+"'>"+value+"</span>";
		}
	},{
		field : 'learnTimeH',
		title : '学习时长（小时）',
		width : '10%',
		align : "center"
	} ];

	$(document).ready(function(e) {
		//搜索按钮
		$(document).keyup(function(e) {
			var key = e.which;
			if (key == 13) {
				searchType();
			}
		});

		//获取url中的参数
		var url = $("#left_ul").find("a.active").attr("url");
		var resId = $("#left_ul").find("a.active").attr("id");
		var parameter = new GetParameter(url);
		typeTree.init({
			from:'dept',
			mark : parameter.mark,
			treeType : parameter.treeType
		});

		var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
		var mark = "";
		if (nodes.length > 0) {
			mark = nodes[0].mark;
		}
		//初始化表格
		TableInit.init({
			domId : "right_table",
			url : "/zhbg/xxkh/learntime/deptLearningTimeList",
			columns : right_table_col,
			queryParams : function(params) {
				//这里将各个查询项添加到要传递的参数中
				params.deptIds=$("#creDeptId").val();
				params.chushiIds=$("#unitId").val();
				params.timeRange=$("#timeRange").val();
				//params.positions=getPara();
				params.nodeIds=getCheckedNodes();
				return params;
			},
			readOnlyFn : function() {
				$('tr.readOnly').attr("title","点击查看详情");
				$('tr.readOnly').find('td').unbind('click').bind('click', function(e) {
					//                    取消事件冒泡
					var evt = e ? e : window.event;
					if (evt.stopPropagation) {
						evt.stopPropagation();
					} else {
						evt.cancelBubble = true;
					}
					//                    取消事件冒泡 end
					var nodeIds=getCheckedNodes();
					var userId = $(this).parent().find("span[data-id]").attr("data-id");
					MyLayer.layerOpenUrl({
						url : '/modules/zhbg/xxkh/learningTimeCount/deptLearningTimeDetail.html?resId='+resId+"&userId="+userId+"&nodeIds="+nodeIds+"&from=dept&timeRange="+$("#timeRange").val(),
						title : '资料学习明细',
						width : '90%',
						height : '90%'
					});
				});
			}
		});
	});
	function getPara(){
		var positions = "";
	    var zw = $('#position input[name="dutyIds"]');
	    $.each(zw,function(index,value){
	    	if($(this).is(":checked")){
	    		positions += $(this).val();
	    		positions += ",";
	    	}
	    });
	    positions = positions.substr(0,positions.length-1);
	    return positions;
	}
	
	function getCheckedNodes(){
		var checkedNodes = $.fn.zTree.getZTreeObj("treeDemo").getCheckedNodes();
		var nodeIds="";
		if(checkedNodes.length>0 && checkedNodes!=""){
			for(var i=0;i<checkedNodes.length;i++){
				//节点类型时资料
				if(checkedNodes[i].type=='1'){
					nodeIds+=checkedNodes[i].id;
					nodeIds+=",";
				}
			}
		}
		if(nodeIds!=""){
			nodeIds=nodeIds.substring(0,nodeIds.length-1);
		}
		return nodeIds;
	}

	//    表格数据项的操作
	var list = {
		editFun : function(id) {
			MyLayer.layerOpenUrl({
				url : '/modules/zhbg/xxkh/lawData/lawDataEditForm.html?id=' + id,
				title : "修改",
				width : "90%",
				height : "90%"
			})
		},
		deleteFun : function(id) {
			MyLayer.deleteOpt({
				url : '/index.html?id=' + id,
				tableId : 'right_table'
			})
		}
	}
	function cleanAll(){
		$("#creDeptId").val("");
		$("#creDeptName").val("");
		$("#unitId").val("");
		$("#unitName").val("");
		$("#timeRange").val("");
	    var one=document.getElementsByName('dutyAuthority[]');
		for(var j=0;j<one.length;j++){
            one[j].checked=false;
        }
	}
</script>
