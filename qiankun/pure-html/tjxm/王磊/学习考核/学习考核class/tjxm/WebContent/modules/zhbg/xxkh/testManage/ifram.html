<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<meta http-equiv="Expires" content="0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-control" content="no-cache">
<meta http-equiv="Cache" content="no-cache">

<link rel="stylesheet" type="text/css"
	href="/static/core/bootstrap/css/bootstrap.css">
<link rel="stylesheet"
	href="/static/core/bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet"
	href="/static/core/bootstrap-table/bootstrap-table.min.css" />
<link rel="stylesheet"
	href="/static/core/bootstrapvalidator/dist/css/bootstrapValidator.min.css" />
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="/static/core/html5/html5shiv.min.js"></script>
    <script src="/static/core/html5/respond.js"></script>
    <![endif]-->
<link href="/static/css/common/style.css" rel="stylesheet" />
<link href="/static/css/common/form-public.css" rel="stylesheet" />
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet"
	href="/static/core/jquery-fileupload/css/jquery.fileupload.css">
<link rel="stylesheet" href="/static/font/iconfont.css">
<link rel="stylesheet" type="text/css"
	href="/modules/system/config/dictionary/css/vertify.css">
<link rel="stylesheet" type="text/css"
	href="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.css">
<link rel="stylesheet" type="text/css"
	href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css">
<title></title>
<style type="text/css">
body {
	box-sizing: border-box;
}

#tree {
	width: 30%;
	height: 580px;
}

#ziliao {
	width: 68%;
}

.main {
	width: 100%;
	height: 100%;
	font-size: 0;
	box-sizing: border-box;
	overflow-y: hidden;
}

.left {
	display: inline-block;
	box-sizing: border-box;
	width: 55%;
	height: 580px;
	font-size: 12px;
	overflow-y:scroll;
}

.right {
	display: inline-block;
	width: 43%;
	height: 580px;
	box-sizing: border-box;
	font-size: 12px;
	overflow-x:hidden;
	overflow-y:scroll;
	
}

iframe {
	width: 100%;
	height: 100%;
	border: 2px solid #eee;
	border-bottom: 0px;
	box-sizing: border-box;
}

.panel-controls {
	position: absolute;
	right: 40px;
	top: 10px;
}

.panel-controls>i.showSelect {
	font-size: 16px;
	color: #acb1b8;
	cursor: pointer;
}

label {
	font-weight: normal;
}
</style>
</head>
<body>
<input type="hidden" id="testId" value="">
<input type="hidden" id="treeType" value="">
<input type="hidden" id="state" value="1"><!-- 试卷的可读状态 1为可读-->
<input type="hidden" id="isShare" value=""><!-- 试卷的共享状态（针对于部门考试）1：共享 -->
	<div class="main"  >
		<div class="left left-js">
			<div class="vertify-panel vertify-tree x-unselectable"
				role="presentation" id="tree">
				<div class="inner" style=" height: 100%;overflow-y: hidden;">
					<ul id="treeDemo" class="ztree"
						style="margin-top: 10px; height: 98%; overflow-x: auto;">
					</ul>
				</div>
			</div>
			<div class="vertify-panel vertify-details" id="ziliao">
				<form class="form-horizontal" onsubmit="return false">
					<div class="col-md-12">
						<div class="panel panel-default toggle">
							<div class="panel-heading" style="cursor: pointer;">
								<h3 class="panel-title">查询项</h3>
								<div class="panel-controls ">
									<i class="glyphicon glyphicon-plus showSelect"></i>
								</div>
							</div>
							<div class="panel-body" style="display: none;">
								<div class="form-group">
									<label class="col-md-2 control-label" style="width:100px"> 试卷名称：</label>
									<div class="col-md-3" style="width:50%">
										<input class="form-control" type="text" name="name"
											id="name" />
									</div>
								</div>
								<div class="form-group">
									<label class="col-md-2 control-label" style="width:100px"> 难易程度：</label>
									<div class="col-md-3" style="width:50%">
										<select class="form-control" name="difficultyLevel"
											id="difficultyLevel">
											<option value="">---请选择---</option>
											<option value="1">简单</option>
											<option value="2">一般</option>
											<option value="3">困难</option>
										</select>
									</div>
								</div>

								<div class="form-group">
									<div class="col-md-2" style="width: 100%; text-align: center">
										<button type="button" class="btn btn-primary"
											onclick="TableInit.refTable('right_table')">
											查&nbsp;&nbsp;询</button>
										&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
										<button type="reset" class="btn btn-primary"
											onclick="">
											重&nbsp;&nbsp;置</button>
										&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
				<!--查询结束-->

				<div class="col-md-12">
					<!--bootstrap-table表格-->
					<table id="right_table" data-use-row-attr-func="true" data-reorderable-rows="true"></table>
				</div>
			</div>
			<!-- 按钮区结束 -->
			<!-- <iframe id="left" src="/modules/zhbg/xxkh/paperManage/treeAndZiliao.html?treeType=fz"></iframe> -->
		</div>
		<div class="right right-js">
			<div id="wai">
				<div class="row">
					<div class="col-md-12 ">
						<div class="block_title">
							<span class="name">已选试卷</span>
							<span style="color: red;">只允许选择一套试卷！</span>
						</div>
					</div>
				</div>
				<div class="col-md-12"  unselectable="on" onselectstart="return false;" style="-moz-user-select:none;">
					<!--bootstrap-table表格-->
					<table id="right_tables" data-use-row-attr-func="true" data-reorderable-rows="true"></table>
				</div>
				
			</div>
			<!--         <iframe id="right" src="/modules/zhbg/xxkh/paperManage/question.html"></iframe>
 -->
		</div>
		<div class="form_btn_area" style="text-align: center;">
			<!-- <button id="preserveBtn" class="btn btn-primary form_btn_area_btn2" onclick="closeOp();" > 确定 </button> -->
		</div>
	</div>

	<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
	<script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
	<script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
	<script
		src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
	<script src="/static/js/common/tablelist.js"></script>
	<script src="/static/core/layer/layer.js"></script>
	<script src="/static/js/common/url.js" type="text/javascript"></script>
	<script src="/static/js/common/mylayer.js"></script>
	<!-- <script
		src="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.js"></script> -->
	<script src="/static/js/common/jquery.tablednd.js"></script>
	<script src="/static/core/zTree_v3/js/jquery.ztree.core.js"></script>
	<script src="/static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
	<script src="/static/core/zTree_v3/js/jquery.ztree.exedit.js"></script>
	<script src="/modules/zhbg/xxkh/tree/js/dictionaryTypeTree.js"></script>
	<!-- 页面获取参数 -->
	<script src="/common/js/index.js"></script>
	<!-- 页面常量配置config.js -->
	<script type="text/javascript" src="/common/js/config.js"></script>
	<!-- 获取cookie值 -->
	<script type="text/javascript"
		src="/product/workflow/js/common/getCook.js"></script>
	<script type="text/javascript" src="/common/js/getrequest.js"></script>
	<script src="/modules/zhbg/xxkh/testManage/js/ksglValidator.js"></script>
	<script type="text/javascript">
		var  nodeId = "4028948265136cb301651381ddfb0003";
		var parameter;
		var testid = [];
		var questionGroupId = "";
		var da = [];
		function add() {
			MyLayer.layerOpenUrl({
				url : '/modules/zhbg/xxkh/paperManage/sjglEditForm.html',
				title : '新增试卷信息',
				width : '90%',
				height : '90%'
			})
		}

		//增加字典类型
		function addType(type) {
			// 判断是否已经选择了某个节点
			var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();

			if (nodes.length == 0) {
				layer.msg('请选择考试类型', {
					icon : 0
				});
			} else if (type) {
				var pid = nodes[0].id;
				mark = nodes[0].mark;
				var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?treeType="+$("#treeType").val()+"&type=0";
				var title = "";
				if ("0" == type) {
					url = url + "0&pId=" + pid;
					title = "新增考试类型";
				}/*  else if ("1" == type) {
								            url = url + "1&mark=" + mark;
								            title = "新增字典项";
								        } */
				layer.open({
					type : 2,
					shadeClose : true,
					content : url,
					area : [ '770px', '450px' ],
					title : [ title, 'font-size:16px;font-weight:bold;' ]
				})
			}
		}

		//修改字典类型
		function editType() {
			// 判断是否已经选择了某个节点
			var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
			if (nodes.length == 0) {
				layer.msg('请选择考试类型', {
					icon : 0
				});
			} else {
				var id = nodes[0].id;
				var mark = nodes[0].mark;
				var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?id=" + id;
				layer.open({
					type : 2,
					shadeClose : true,
					content : url,
					area : [ '770px', '450px' ],
					title : [ '修改考试类型', 'font-size:16px;font-weight:bold;' ]
				})
			}
		}

		//删除字典类型
		function deletType() {
			// 判断是否已经选择了某个节点
			var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
			if (nodes.length == 0) {
				var url = "/modules/zhbg/xxkh/tree/dictionaryEditForm.html?treeType="+$("#treeType").val()+"&type=0";
				var title = "";

				layer.open({
					type : 2,
					shadeClose : true,
					content : url,
					area : [ '770px', '450px' ],
					title : [ title, 'font-size:16px;font-weight:bold;' ]
				})
				// layer.msg('请选择字典类型', {icon: 0});
			} else {
				layer.confirm("确定要删除该类型吗？", function() {
					$.ajax({
						type : "POST",
						url : "/zhbg/xxkh/tree/deleteType",
						data : {
							id : nodes[0].id,
							mark : nodes[0].mark
						},
						dataType : "json",
						success : function(data) {
							if ('1' == data.flag) {
								layer.msg("删除成功！", {
									icon : 1,
									time : 1000
								}, function(index) {
									typeTree.delNode(nodes[0].id);
								});
							} else {
								layer.msg("该类型下有考试项，不可删除！", {
									icon : 5
								});
							}
						},
						error : function(data) {
						}
					});
				});
			}
		}

		//查询字典类型
		function searchType() {
			typeTree.searchNodes($("#typeName").val());
		}

		// 查询窗口
		function showSearchFrame() {
			var search = $("#searchDiv");
			if (search.is(":hidden")) {
				search.show();
				$("#typeName").focus();
			} else {
				search.hide();
			}
		}

		//参考：http://www.layui.com/laydate/
		/*  //绑定日期输入input
		 laydate.render({
		     elem: '#time' //指定元素
		 });
		 //日期范围
		 laydate.render({
		     elem: '#timeRange'
		     , range: true
		 }); */
		var right_table_ti = [ {
			field : 'id',
			title : '序号',
			width : '5%',
			order : "desc",
			align : "center",
			formatter : function(value, row, index) {
	            return "<span data-id='"+row.id+"' >"+(index+1)+"</span>"; 
			}
		}, {
			field : 'nodeId',
			title : '所属类别',
			width : '30%',
			align : "center",
			formatter : function(value, row, index) {
				if (value != null) {
					var length = value.length
					var val = '';
					if (length > 12) {
						val = value.substring(0, 12) + "...";
					} else {
						val = value;
					}
					return "<span title= "+value+" data-content='"+value+"'>" + val + "</span>";
				} else {
					return "";
				}
			}
		}, {
			field : 'name',
			title : '试卷名称',
			width : '40%',
			align : "center",
			formatter : function(value, row, index) {
				var data = value
				if (value != null) {
					var length = value.length
					var val = '';
					if (length > 12) {
						val = value.substring(0, 12) + "...";
					} else {
						val = value;
					}
					return "<span title="+data+" data-content='"+value+"'>" + val + "</span>";
				} else {
					return "";
				}
			}
		},{
			field : 'fullScore',
			title : '满分',
			width : '10%',
			sortable : false,
			align : "center",
		},{
			field : 'difficultyLevel',
			title : '难易程度',
			width : '10%',
			sortable : false,
			align : "center",
			formatter : function(value, row, index) {
				if (Config.jianDan == value) {
					value = "简单";
				} else if (Config.yiBan == value) {
					value = "一般";
				} else if (Config.kunNan == value) {
					value = "困难";
				}
				return "<span data-id='"+row.id+"'>" + value + "</span>";
			}
		}, 
		{
			field : 'cz',
			title : '操作',
			width : '20%',
			align : "center",
			formatter : function(value, row, index) { //直接定义function,return就是html代码
				var html = "";
				html += "<i title='删除' style='cursor:pointer;' class='glyphicon glyphicon-trash' onclick='list.deleteFun(\"" + row.id + "\")'></i>";
				return html;
			}
		} ];

		//定义bootatrap-table数据列
		//    sortable：开启列排序，其他参考API
		//order：排序方式，可选
		var right_table_col = [ {
			field : 'isCheck',
			title : "操作",
			width : '3%',
			align : "center",
			//checkbox : true,//设置多选
			radio: true,//设置单选
			formatter : function(value, row, index) {
				if($.inArray(row.id,testid)!= -1){     
                    return {
                        checked : true               // 存在则选中
                    }
                }
			}
		}, {
			field : 'id',
			title : '序号',
			width : '5%',
			order : "desc",
			align : "center",
			formatter : function(value, row, index) {
			 	var pageSize=$('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
	            var pageNumber=$('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
	            var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
	            return "<span data-id='"+row.id+"' >"+orderNum+"</span>"; 
			}
		}, {
			field : 'name',
			title : '试卷名称',
			width : '40%',
			align : "center",
			formatter : function(value, row, index) {
				if (value != null) {
					var length = value.length
					var val = '';
					if (length > 21) {
						val = value.substring(0, 20) + "...";
					} else {
						val = value;
					}
					return "<span title = "+value+" data-content='"+value+"'>" + val + "</span>";
				} else {
					return "";
				}
			}
		}, {
			field : 'fullScore',
			title : '满分',
			width : '10%',
			sortable : false,
			align : "center",
		}, {
			field : 'difficultyLevel',
			title : '难易程度',
			width : '10%',
			sortable : true,
			align : "center",
			formatter : function(value, row, index) {
				if (Config.jianDan == value) {
					value = "简单";
				} else if (Config.yiBan == value) {
					value = "一般";
				} else if (Config.kunNan == value) {
					value = "困难";
				}
				return "<span data-id='"+row.id+"'>" + value + "</span>";
			}
		} ];

		$('#right_table').on('check-all.bs.table', function (rows) {
			//全选按钮
			var rowsId = ""
			$(rows.currentTarget).find("tbody").find("tr").each(function() {
				//console.log($(this).find("span[recordid]").attr("recordid"));
				rowsId += $(this).find("span[recordid]").attr("recordid")+",";
			})
			rowsId = rowsId.substring(0, rowsId.length - 1);
			$.get("/zhbg/xxkh/testmanage/savePaper", {
				testId : $("#testId").val(),
				paperId : rowsId
			}, function(data) {
				if (data.flag == 1) {
					console.log("saveOK");
					TableInit.refTable('right_tables');
				} else {
					layer.msg("添加失败，请尝试刷新页面或联系管理员！", {
						icon : 2
					});
				}
			}, "json")
		   
		});
		$('#right_table').on('uncheck-all.bs.table', function (rows) {
			//全取消按钮
			var rowsId = ""
			$(rows.currentTarget).find("tbody").find("tr").each(function() {
				//console.log($(this).find("span[recordid]").attr("recordid"));
				rowsId += $(this).find("span[recordid]").attr("recordid")+",";
			})
			rowsId = rowsId.substring(0, rowsId.length - 1);
			alert(rowsId);
			$.get("/zhbg/xxkh/testmanage/deleteBatchPaper", {
				testId : $("#testId").val(),
				paperIds : rowsId
			}, function(data) {
				if (data.flag == 1) {
					console.log("deleteOK");
					TableInit.refTable('right_tables');
				} else {
					layer.msg("删除失败，请尝试刷新页面或联系管理员！", {
						icon : 2
					});
				}
			}, "json")
		});
		
		$(document).ready(function(e) {

			//搜索按钮
			$(document).keyup(function(e) {
				var key = e.which;
				if (key == 13) {
					TableInit.refTable('right_table');
				}
			});

			//获取url中的参数
			var treeType = "";
			var type = "";//初始化试卷表格使用的参数（设置默认第一个）
			var theRequest = GetRequest();
			$("#testId").val(theRequest.id);
			//parameter = new GetParameter(url);//左导航框的参数传到右侧
			if(theRequest.treeType.indexOf("dept")!=-1){//(针对于deptks)
				treeType = "dept";//初始化时区分是部门考试，显示4个试卷树
				$("#isShare").val("1");//是部门考试，则需要过滤共享数据，1：需要共享
				type = "juj";
			}else{
				treeType = theRequest.treeType.replace("ks","sj");//把考试换成试卷，用于初始化试卷类型（针对于fzks/bmks/zzllks）
				type = treeType;
			}
			$("#treeType").val(treeType);
			console.log("试卷类型："+treeType+"考试类型："+theRequest.treeType);
			//初始化试卷类别树
			typeTree.init({
				treeType : treeType
			});
			var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
			if (nodes.length > 0) {
				nodeId = nodes[0].id;
				type= nodes[0].treeType;
				if(type.indexOf("juj")!=-1){
					type="juj";
				}
			} 
			
			//初始化已选表格
			 $.ajax({
	    		url:"/zhbg/xxkh/testmanage/getPapersList?rdm="+Math.random(),
	    		data:{testId:$("#testId").val()},
	    		async:false,
	    		success:function(json){
	    			if (json.flag == '1') {
	    				$("#right_tables").bootstrapTable({
	    					cache:false,
	    					height:null,
	    					responseHandler:function(res){
	    						return responseHandler(res);
	    					},
	    					pagination:true,//设置分页
	    					columns:right_table_ti,
	    					rowStyle: function (row, index) {	//默认样式：居中
	    		            	
	    		                return {
	    		                    classes: 'readOnly'
	    		                    ,css: {"text-align":"center","cursor":"default"}
	    		                };
	    		            },
	    		            onLoadSuccess:function(data){
	    		            	
	    		            }
	    				});
	    				$("#right_tables").bootstrapTable("removeAll");
	    				$("#right_tables").bootstrapTable("load",json.data);
	    				for(var i in json.data){
		    				testid.push(json.data[i].id);
	    				}
	    			}else {
	    				
	    			}
	    		}
	    	});  
		
			//初始化试卷类别下的试卷列表
			TableInit.init({
				domId : "right_table",
				url : "/zhbg/xxkh/xxkhPaperInfo/list?nodeId="+nodeId+"&type="+type+"&state=1",
				columns : right_table_col,
				singleSelect: true,
				checkboxHeader:false,//设置 false 将在列头隐藏全选复选框
				queryParams : function(params) {
					params.name = $("#name").val();
					params.difficultyLevel = $("#difficultyLevel").val();
					return params;
				},
				rowStyle: function (row, index) {	//默认样式：居中
	            	
	                return {
	                    classes: 'readOnly'
	                    ,css: {"text-align":"center","cursor":"default"}
	                };
	            },
				readOnlyFn : function(rows) {
					$('#right_table tr.readOnly').find('td:eq(0)').find('input').css("cursor","pointer");
					 $('tr.readOnly').find('td:eq(2)').bind('mouseover', function (e) {
		           		 	var txt = $(this).find("span[data-content]").attr("data-content");
			                     $(this).attr("title",txt) 
		                 });
					 
				},  
				onCheckAll : function(rows) {
					alert('sf');
				},
				onCheck : function(row, tr, flied) {
					 /* var d = $("#right_table").bootstrapTable("getData");
					alert(JSON.stringify(d)); */ 
					//选中保存考试与试卷关联表
					 $.ajax({
		                    url: "/zhbg/xxkh/testmanage/savePaper?rdm="+Math.random()
		                    , data:{testId:$("#testId").val(),paperId:row.id}
		                    , dataType: "json"
		                    , success: function (result) {
		                    	if(result.flag=="1"){
									 //layer.msg('保存成功！', {icon: 1});
									var selData = row;
									var json = [];
									console.log("选中的数据");
									console.log(row);
									var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes(); 
									row.nodeId = getFilePath(nodes[0]);
									json.push(row);
									console.log("加载的数据");
									console.log(json);
									$("#right_tables").bootstrapTable("load",json);
								}
	                    	}
                    	});
					//刷新显示在右侧列表中
				},
				onUncheck : function(row, tr, flied) {
					$.get("/zhbg/xxkh/testmanage/deletePaper",{testId:$("#testId").val(),paperId:row.id},function(data){
						console.log("deleteOK");
						TableInit.refTable('right_tables');
					},"json")
				},
				onUncheckAll : function(rows) {
					alert('sf');
				}

			});
			
			 
			
		});

		//    表格数据项的操作
		var list = {
			 editFun : function(id) {
				MyLayer.layerOpenUrl({
					url : '/modules/zhbg/xxkh/paperManage/sjglEditForm.html?id=' + id,
					title : "修改试卷信息",
					width : "90%",
					height : "90%"
				})
			}, 
			deleteFun : function(id) {
				//删除试卷
				MyLayer.deleteOpt({
					url : '/zhbg/xxkh/testmanage/deletePaper?paperId='+id+'&testId='+$("#testId").val(),
					tableId : 'right_tables',
					confirmBtn:function (json) { //确定按钮的事件
		                $.ajax({
		                    url: json.url
		                    , type: "GET"
		                    , dataType: "json"
		                    , success: function (result) {
		                        var msg = "";
		                        if (result.flag === "1") {
									$("#right_tables").bootstrapTable("removeAll"); 
		                            msg = '删除成功！';
		                            if ($.trim(result.msg)) {
		                                msg = result.msg;
		                            }
		                            layer.msg(msg, {icon: 1});
		                            TableInit.refTable(json.tableId);
		                            window.parent.getPapers();
		                        } else {
		                            msg = '删除失败，请重试！';
		                            if ($.trim(result.msg)) {
		                                msg = result.msg;
		                            }
		                            layer.msg(msg, {icon: 2});
		                        }
		                    }
		                    , error: function () {
		                        layer.msg('删除失败，请重试！', {icon: 2});
		                    }
		                })
		            }
				});
			}
		}
		//选择试卷后点击确定
		function closeOp(){
			//父页面渲染试卷列表
			window.parent.getPapers();
			//关闭本页面
			MyLayer.closeOpen();
		}
		
		//递归获得类型的全路径
		function getFilePath(treeObj){
			if(treeObj==null){
				return "";
			}
			var filename = treeObj.name;
			var pNode = treeObj.getParentNode();
			if(pNode!=null){
				filename = getFilePath(pNode) +"-"+ filename;
			}
			return filename;
		}

	</script>
</body>
</html>