<style type="text/css">
    .panel-controls {
        position: absolute;
        right: 40px;
        top: 10px;
    }
    .panel-controls > i.showSelect {
        font-size: 16px;
        color: #acb1b8;
        cursor: pointer;
    }
    label {
        font-weight: normal;
    }
</style>
<link rel="stylesheet" type="text/css" href="/modules/system/config/dictionary/css/vertify.css">
<link rel="stylesheet" type="text/css"
      href="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.css">
<link rel="stylesheet" type="text/css" href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css">
<div class="container-fluid" style="height:100%;">
    <div class="row" style="height:100%;">
        <div class="vertify-panel vertify-tree x-unselectable" style="width:18%;overflow:hidden"role="presentation">
            <div class="inner">
                <div class="folderBar">
                     <i id = "addCategory" class="glyphicon glyphicon-plus-sign" onclick="addCategory();" style="font-size:18px;cursor: pointer;" title="新增门类"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <i id = "updateCategory" class="glyphicon glyphicon-edit" onclick="editCategory();" style="font-size:18px;cursor: pointer;" title="修改门类"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <i id = "deleteCategory" class="glyphicon glyphicon-trash" onclick="deleCategory();" style="font-size:18px;cursor: pointer;" title="删除门类"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
                    <!-- <i class="glyphicon glyphicon-search" onclick="showSearchFrame()" style="font-size:18px;cursor: pointer;" title="查询栏目"></i> -->
                </div>
                <div id="searchDiv" class="input-group input-group-sm" style="display:none;padding-left:5px; margin-top: 5px; padding-right: 5px;">
                    <input type="text" id="typeName" class="form-control">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" onclick="searchType();" >查询</button>
                    </span>
                </div>
                <ul id="treeDemo" class="ztree" style="margin-top: 10px;height:500px;overflow:auto;">
                </ul>
            </div>
        </div>
        <!--<div class="vertify-panel vertify-centerButton"></div>-->
        <div class="vertify-panel vertify-details" style="width:82%">
           
            <form class="form-horizontal">
                <div class="modal-body selectjs">
                    <div class="selectjs_block" style="height: auto;">
                        
                        <div class="main" style="height: auto;">
                            <div id="formpage1" class="active">
                                <form class="form-horizontal" id="form1">
                                    <!-- 维护页面 -->
                                    <div class="row">
                                        <div class="col-md-12 ">
                                            <div class="panel panel-default toggle">
                                                <div class="panel-heading" style="cursor: pointer;">
                                                    <h3 class="panel-title">查询项</h3>
                                                    <div class="panel-controls ">
                                                        <i class="glyphicon glyphicon-plus showSelect"></i>
                                                    </div>
                                                </div>
                                                <div class="panel-body" style="display: none;">
                                                    <!--查询项输入框选择框等开始-->
                                                     <div class="form-group">
                                                     	<input type="hidden" id="superId" name="" value="">
                                						<label class="col-md-2 control-label"> 商品名称：</label>
						                                <div class="col-md-3">
						                                    <input class="form-control" type="text" name="categoryName" id="categoryName"/>
						                                </div>
						                                <label class="col-md-4 control-label"> 是否可用：</label>
						                                <div class="col-md-3">
						                                    <label class="radio-inline">
							                                    <input type="radio" id="isUse1" name="isUse" value="" checked="checked"> 全部
							                                </label>
							                                <label class="radio-inline">
							                                    <input type="radio" id="isUse2" name="isUse" value="1"> 是
							                                </label>
							                                <label class="radio-inline">
							                                    <input type="radio" id="isUse2" name="isUse" value="0"> 否
							                                </label>
						                                </div>
                            						</div>
                                                    <!--查询项输入框选择框等结束-->
                                                    <!--查询重置等按钮-->
							                            <div class="form-group">
							                                <div class="col-md-12" style="text-align: center">
							                                    <button type="button" class="btn btn-primary"
							                                            onclick="TableInit.refTable('right_table');"> 查&nbsp;&nbsp;询
							                                    </button>
							                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
							                                    <button type="button" class="btn btn-primary" onclick="clearAll();">
							                                        		重&nbsp;&nbsp;置
							                                    </button>
							                                </div>
							                            </div>
                            						<!--查询重置等按钮 end-->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row m-t-15">
                                       
                                        <div class="col-md-12">
                                        	<div class="list_button_area">
												<button class="list_table_btn2" 
													onclick="draft()">
													<span class="glyphicon glyphicon-plus-sign"></span> 新增
												</button>
												
											</div>
                                            <!--bootstrap-table表格-->
                                            <table id="right_table"></table>
                                        </div>
                                    </div>
                                    <!-- 维护页面 -->
                                </form>
                            </div>
                            
                          
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
 <script src="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.js"></script>
<script src="/static/js/common/jquery.tablednd.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.core.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.excheck.js"></script>
<script src="/static/core/zTree_v3/js/jquery.ztree.exedit.js"></script>
<script src="/modules/mypage/wmgl/categorygoods/js/categoryTree.js"></script>
<script src="/product/workflow/js/common/getCook.js"></script> 
<script src="/static/js/common/mylayer.js"></script>
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<script type="text/javascript" src="/common/js/commonFunction.js"></script>
<script type="text/javascript" src="/static/js/common/assistUtil.js"></script>
 <script src="/common/js/config.js"></script>
<script type="text/javascript" src="/common/js/getrequest.js"></script>

<script type="text/javascript">
    scrollTop.init();
    var resId = $('#left_ul').find('a.active').attr("id");
    // 增加栏目类型
    function addCategory() {
    	
        // 判断是否已经选择了某个节点
        var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
        var ztree = $.fn.zTree.getZTreeObj("treeDemo");
        var nodesLength = ztree.getNodes().length;
        if (nodes.length == 0) {
        	if(nodesLength > 0){
	    		layer.msg('请选择门类', {icon: 0});
	    		return false;
	    	}
			var url = "/modules/mypage/wmgl/categorygoods/categoryEditForm.html?superId="+0+"&nodeLevel="+0+"&isFirst=1&oper=NEW&resId="+resId;
			var title = "";
			title = "新增门类";
			layer.open({
				type : 2,
				shadeClose : true,
				content : url,
				area: ['770px', '295px'],
                title: [title, 'font-size:16px;font-weight:bold;']
			})
			if (nodes.length > 0) {
				ztree.selectNode(nodes[0]);
	        }
        } else {
            var superId = nodes[0].id;//父节点id
            var nodeLevel = nodes[0].nodeLevel;//父节点级别
            var url = "/modules/mypage/wmgl/categorygoods/categoryEditForm.html?superId="+superId+"&nodeLevel="+nodeLevel+"&code=" + nodes[0].code + "&isFirst=0&oper=NEW&resId="+resId;
            var title = "新增门类";
            layer.open({
                type: 2,
                shadeClose: true,
                content: url,
                area: ['770px', '295px'],
                title: [title, 'font-size:16px;font-weight:bold;']
            })
        }
    }

    //修改栏目
    function editCategory(){
        // 判断是否已经选择了某个节点
        var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
        if (nodes.length == 0) {
            layer.msg('请选择门类', {icon: 0});
        } else {
            var id = nodes[0].id;
            var url = "/modules/mypage/wmgl/categorygoods/categoryEditForm.html?id="+id+"&open=EDIT&resId="+resId;
            layer.open({
                type: 2,
                shadeClose: true,
                content: url,
                area: ['770px', '295px'],
                title: ['修改门类', 'font-size:16px;font-weight:bold;']
            })
        }
    }

    //删除栏目
    function deleCategory(){
    	  // 判断是否已经选择了某个节点
        var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
         //删除栏目的ids
        var categoryIds = "";
        if (nodes.length == 0) {
            layer.msg('请选择门类', {icon: 0});
        } else {
            var nodeChildren = nodes[0].children;
            var isFirst = nodes[0].isFirst;
      		
            if(nodeChildren && nodeChildren.length>0){
                layer.msg("该门类下有子门类，不可删除！",{icon:2});
                return false;
            }
            if(nodes.length>1){
            	for(var i=0;i<nodes.length;i++){
            		categoryIds+=nodes[i].id+','
            	}
            	categoryIds=categoryIds.substr(0,categoryIds.length-1);
            }else{
            	categoryIds=nodes[0].id;
            }
            layer.confirm("确定要删除该门类吗？",function(){
                $.ajax({
                    type: "POST",
                    url:"/mypage/wmgl/basicSet/category/delete",
                    data:{ids:categoryIds},
                    dataType:"json",
                    success:function(data){
                            layer.msg("删除成功！", {icon: 1,time:1000}, function (index) {
                            	for(var i=0;i<nodes.length;i++){
                            		typeTree.delNode(nodes[i].id);
                            		$("#superId").val("")
                            		TableInit.refTable('right_table')
                            	}
                            	
								 if(isFirst=='1'){
									 $.fn.zTree.getZTreeObj("treeDemo").refresh();
									
								 }
								 
                            });
                    },
                    error:function(data){
                    }
                });
            });
        }
    }

    //查询栏目
    function searchType(){
        typeTree.searchNodes($("#typeName").val());
    }

    // 查询窗口
    function showSearchFrame() {
        var search = $("#searchDiv");
        if (search.is(":hidden")) {
            search.show();
            $("#typeName").focus();
        } else {
            search.hide();
        }
    }

    // 刷新列表
    function refresh() {
        $("#right_table").bootstrapTable("refresh");
        
    }

    //清空查询条件
    function clearAll() {
        $("#categoryName").val("");	//字典名称
        $("input[name=isUse]").each(function(index){
        	if(index==0){
        		$(this).prop("checked", true);
        	}else{
        		$(this).prop("checked", false);
        	}
        })
       
        
    }

   
  
	
    var right_table_col = [{
        title: '序号'
        , width: '5%'
        , order: "desc"
        , align: "center"
        , formatter: function (value, row, index) {
        	 //计算序号，并存放业务ID，及已办事项ID
            var pageSize=$('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
            var pageNumber=$('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
            var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
            return "<span data-id='"+row.id+"'>"+orderNum+"</span>";    
        }
    }, {
        field: 'goodsName'
        , title: '商品名称'
        , width: '10%'
        , align: "center"
    },  {
        field: 'danjia'
        , title: '单价'
        , width: '9%'
        , align: "center"
        , formatter: function (value, row, index) {
                return "<span >" + row.price + "元/"+ row.valuationUnit + "</span>";
         }
    },   {
        field: 'isUse'
            , title: '是否可用'
            , width: '8%'
            , align: "center"
            ,formatter:function (value,row,index) {
            	
                if(value=='0'){
                    return "否";
                }
                if(value=='1'){
                    return "是";
                }
            }
       },
       {
           field: 'amountLimit'
               , title: '数量限制'
               , width: '9%'
               , align: "center"
               ,formatter:function (value,row,index) {
               		
                   if(value=='0'){
                       return "无";
                   }else{
                       return "有";
                   }
               }
          },
       
       {
        field: 'imageId'
            , title: '是否上传图片'
            , width: '8%'
            , align: "center"
            ,formatter:function (value,row,index) {
                if(value){
                    return "是";
                }else{
                	 return "否";
                }
                
            }
        },{
            field: 'status'
                , title: '状态'
                , width: '8%'
                , align: "center"
                ,formatter:function (value,row,index) {
                    if(value=='0'){
                        return "草稿";
                    }
                    if(value=='1'){
                        return "发布";
                    }
                }
           },        
        {
            field: 'isSp'
                , title: '操作'
                , width: '8%'
                , align: "center"
                ,formatter:function (value,row,index) {
                	
					var html = "";
					html += "<i style='cursor:pointer;'class='glyphicon glyphicon-edit' title='修改' onclick=\'list.editFun(\""
						+ row.id + "\")\'></i>&nbsp;&nbsp;";
					if(row.status=='0'){
						html += "<i style='cursor:pointer;' class='glyphicon glyphicon-trash' title='删除' onclick=\'list.deleteFun(\""
							+ row.id + "\")\'></i>";
					}
					
					
					return html;
                }
            }
       
       ];
  //标签页切换
    $(function () {
	
    	
    });
    //刷新方法，流程中需要回调
    function refreshPage(){
        TableInit.refTable("right_table");
    }
    $(document).ready(function (e) {
        //搜索按钮
        $(document).keyup(function(e) {
            var key = e.which;
            if (key == 13) {
                searchType();
            }
        });
        typeTree.init();
        var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
        var nodesLength = $.fn.zTree.getZTreeObj("treeDemo").getNodes().length;
       
        var superId = "";
        
        if (nodes.length > 0) {
            $("#superId").val(nodes[0].id);
        }
        
        var columnId = $("#superId").val();
        var isFirst;
        if(nodesLength==0){
        	
        	isFirst='1';
        }else{
        	
        	isFirst=nodes[0].isFirst;
        }
        showCz(columnId,isFirst,nodesLength);
        //初始化表格
        TableInit.init({
            domId: "right_table",
            url: "/mypage/wmgl/basicSet/goods/getlistBootHql",
            columns: right_table_col,
            //pagination:false,
            queryParams: function (params) {
                //这里将各个查询项添加到要传递的参数中
                //可以做一些校验
                params.resId = resId;
                params.categoryId = $("#superId").val();
                params.GoodsName = $("#categoryName").val();
                params.isUse = $("input[name='isUse']:checked").val();
                return params;
            },
            readOnlyFn: function () {
                $('tr.readOnly').find('td:not(:last)').attr("title", "点击查看详情");
                $('tr.readOnly').find('td:last').css("cursor", "default");
                $('tr.readOnly').find('td:not(:last)').unbind('click').bind('click', function (e) {
                    //取消事件冒泡
                    var id = $(this).parent().find("span[data-id]").attr("data-id");
            		MyLayer.layerOpenUrl({url:'/modules/mypage/wmgl/categorygoods/goodsReadOnlyForm.html?id=' + id + '&resId=' + resId,title:'查看商品信息',width:'90%',height:'90%'})

                });
            },
        });
        
  
    });

    //表格数据项的操作
    var list = {
        editFun: function (id) {
    		MyLayer.layerOpenUrl({url:'/modules/mypage/wmgl/categorygoods/goodsEditForm.html?id=' + id + '&resId=' + resId,title:'修改商品信息',width:'90%',height:'90%'})

        },
        deleteFun: function (id) {
            MyLayer.deleteOpt({
                url: '/mypage/wmgl/basicSet/goods/delete?id='+id+'&resId='+resId,
                tableId: 'right_table'
            });
           
        }
    }
    
    //判断当前人权限控制按钮是否显示
    function showCz(columnId,nodeLevel,nodesLength){
    	
        var datas={"columnId":columnId};
        var isGly = "";
        if(nodeLevel=='1' ) {//选中的是根节点
     	   $("#addCategory").show();
        	$(".list_button_area").hide()
     	  //$("#updateCategory").show();
     	  //$("#deleteCategory").show();
        }else{
     	   $("#addCategory").hide();
     	  $(".list_button_area").show()
     	  //$("#deleteCategory").show();
        }
    }
    
    //新建商品
    function draft(){
    	 var nodes = $.fn.zTree.getZTreeObj("treeDemo").getSelectedNodes();
    	 var categoryId = nodes[0].id;
    	 var typeName = nodes[0].name;
		MyLayer.layerOpenUrl({url:'/modules/mypage/wmgl/categorygoods/goodsEditForm.html?categoryId=' + categoryId+"&typeName=" + encodeURI(typeName),title:'新增商品信息',width:'90%',height:'90%'})

    }
</script>