
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>专用权限申请</title>
    <link href="/static/css/common/style.css" rel="stylesheet"/>
    <link href="/static/css/common/form-public.css" rel="stylesheet"/>

    <link rel="stylesheet" type="text/css" href="/static/core/bootstrap/css/bootstrap.min.css">




    <script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
    <script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
    <script src="/static/core/layer/layer.js"></script>
    <script src="/static/js/common/mylayer.js"></script>
    <script type="text/javascript" src="/static/js/common/assistUtil.js"></script>

    <script src="/static/core/laydate/laydate.js"></script>
    <!-- 流程相关 -->
    <script type="text/javascript" src="/modules/system/component/tree/js/deptUserTree.js"></script>
    <script type="text/javascript" src="/modules/system/component/groupTree/js/groupUserTree.js"></script>
    <script type="text/javascript" src="/common/js/config.js"></script>
    <script type="text/javascript" src="/product/workflow/js/storages.js"></script>
    <script type="text/javascript" src="/common/js/commonFunction.js"></script>
    <!-- 获取cookie值 -->
    <script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
    <!-- 页面获取参数 -->
    <script type="text/javascript" src="/common/js/getrequest.js"></script>
    <!-- 自定义意见(最后进行加载) -->
    <script type="text/javascript" src="/common/html/notion/notion.js"></script>
    <!-- 数据校验 -->
    <script type="text/javascript" src="/modules/llg/js/taskPlanValidator.js"></script>
    <!-- 数据回显 -->
    <script type="text/javascript" src="/static/js/common/displayData.js"></script>
    <!--点击折叠展开-->
    <script type="text/javascript" src="/static/js/common/toggle.js"></script>
    <!--文件上传js-->
    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
    <script src="/static/core/jquery-fileupload/js/vendor/jquery.ui.widget.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="/static/core/jquery-fileupload/js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="/static/core/jquery-fileupload/js/jquery.fileupload.js"></script>
    <script src="/static/js/common/myfilupload.js"></script>
    <!--文件上传js end-->
    <!--自定义js-->
    <script src="/manage/hp/js/help.js"></script>
    <script src="/manage/export/js/FileSaver/FileSaver.min.js"></script>
    <script src="/manage/export/js/js-xlsx/xlsx.core.min.js"></script>
    <script src="/manage/export/js/tableExport.js"></script>


    <!--让IE8/9支持媒体查询，兼容栅格布局-->
    <script src="/static/core/html5/html5shiv.min.js"></script>
    <script src="/static/core/html5/respond.js"></script>
    <!--树状图-->
    <link rel="stylesheet" href="/static/core/zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">
    <script src="/static/core/zTree_v3/js/jquery.ztree.all.min.js"></script>
    <!--全局工具js-->
    <script src="/manage/hp/js/help.js"></script>

    <style>
        /*自定义树图标*/
        .ztree li span.button.diyicon_ico_open{
            /*若此不设置会用自动的图片,所以需要加点样式*/
            margin-right: 2px;
            background-position: -110px -16px;
            background-position-x: -110px;
            background-position-y: -16px;
            vertical-align: top;
        }
        .ztree li span.button.diyicon_ico_close{
            /*若此不设置会用自动的图片,所以需要加点样式*/
            margin-right: 2px;
            background-position: -110px 0;
            vertical-align: top;
        }
        .ztree li span.button.diyicon_ico_docu{
            background: url(/static/images/user.png)
        }
        /**自定义样式*/
        .applyPerm_table th{
            text-align: center;
        }
    </style>
  </head>
<body>
<form class="form-horizontal" id="form">
    <!-- resId -->
    <input name="resId" id="resId" type="hidden" value="">
    <!-- 流程字段-->
    <input name="id" id="id" type="hidden" value=""/><!-- 工作项ID -->
    <input name="ideaName" id="ideaName" type="hidden" value=""/><!-- 当前用户意见域名称-->
    <input name="subflag" id="subflag" type="hidden" value=""/><!-- 流程状态 -->
    <input name="filetypeid" id="filetypeid" type="hidden" value=""/><!-- 流程ID -->
    <input name="workFlowId" id="workflowid" type="hidden" value=""/><!-- 流程唯一ID -->
    <input name="workitemid" id="workitemid" type="hidden" value=""/><!-- 待办工作项ID -->
    <input name="opertation" id="opertation" type="hidden" value=""/><!-- 操作方法 -->
    <input type="hidden" id="deptId" name="deptId" value="" /><!-- 部门id隐藏域 -->
    <input type="hidden" id="fillmode" name="fillmode"value="2">
    <input type="hidden" id="roleNo" name="roleNo"/>
    <!-- 流程字段结束 -->
    <div class="container-fluid formpage_idea">
        <div class="gw_form_block">
            <div class="gw_form_block_title">流程信息</div>
            <div class="gw_form_block_main">
                <table width="90%" border="0" cellspacing="0" cellpadding="0" class="gw_form_block_table">
                    <tbody>
                    <tr>
                        <td width="15%" class="text-right">节点操作提示：</td>
                        <td width="85%" id="flowMemo"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="gw_form_block">
            <div class="gw_form_block_title" onclick="showTable('yjxxTable','showOrHideImg');">
                意见信息
                <img align="right" style="margin-top: 10px" src="/static/images/icon7_down.gif" hspace="0" id="showOrHideImg" />
            </div>
            <div class="gw_form_block_main" id="yjxxTable">
                <div class="table_body-wrapper">
                    <table class="table table-hover table-reset js-disk-row" style="border: 0px">
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid formpage_area" style="margin-bottom: 140px">
        <div id="applyPerm_head" class="col-md-12 col-xs-12">
            <div class="page-header">
                <h4>基本信息</h4>
            </div>
            <div  class="col-md-12 col-xs-12">
                <div  class="col-md-12 col-xs-12">

                    <div class="col-md-12 col-xs-12" style=" margin-bottom: 10px;">
                        <label class="pull-left" style="width:5em">申请人:</label>
                        <div class="col-md-3 col-xs-6">
                            <input id="applyPerm_proposer" type="text"class="form-control" readonly="readonly">
                        </div>
                        <label class="pull-left" style="width:5em;margin-left: 50px;">申请单位:</label>
                        <div class="col-md-2 col-xs-6">
                            <input id="applyPerm_office" type="text"class="form-control" readonly="readonly">
                        </div>
                    </div>

                    <div class="col-md-12 col-xs-12" style=" margin-bottom: 5px;">
                        <label class="pull-left" style="width:5em">申请权限:</label>
                        <div class="col-md-3 col-xs-6">
                            <span style="line-height: 1.42857143;" id="applyPerm_sqqx"  class="">
                            </span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        <div id="applyPerm_body" class="col-md-12 col-xs-12">
            <div class="page-header">
                <h4>申请权限</h4>
            </div>

            <div  class="col-md-12 col-xs-12">
                <button id="applyPerm_managerial_roles" class="btn btn-default">管理业务角色</button>
            </div>
            <div  id="applyPerm_table" class="col-md-12 col-xs-12" style="margin-top: 5px;">
                <table data-chushi="处室id" class="table table-condensed table-hover table-bordered applyPerm_table">
                    <thead>
                    <tr  style="background: #d2d2d2;">
                        <th  colspan="2" style="width: 5em;">职能处室</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <th>审核人</th>
                        <td>
                            <label style="line-height: 1.42857143; margin-left: 15px;"  class="radio-inline">
                                <input type="radio" name="auditor_处室id"+处室id value="审核人1ID" checked="checked" >审核人1
                            </label>
                            <label style="line-height: 1.42857143; margin-left: 15px;"  class="radio-inline">
                                <input type="radio" name="auditor_处室id" value="审核人2ID">审核人2
                            </label>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <th style="width: 8em;">职能1</th>
                        <td>
                            <span class="col-md-2 col-xs-3 applyPerm_role" data-role-id="业务角色111">业务角色1名称</span>
                            <span class="col-md-2 col-xs-3 applyPerm_role" data-role-id="业务角色113">业务角色2名称</span>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 8em;">职能2</th>
                        <td><!--data-role-id 业务角色ID-->
                            <span class="col-md-2 col-xs-3 applyPerm_role" data-role-id="业务角色211">业务角色21名称</span>
                            <span class="col-md-2 col-xs-3 applyPerm_role" data-role-id="业务角色212">业务角色22名称</span>
                            <span class="col-md-2 col-xs-3 applyPerm_role" data-role-id="业务角色213">业务角色21名称</span>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</form>
<!--意见信息start-->
<div class="container-fluid gw_form_bottom_yijian" id ="ideaArea" style="display: none;margin-bottom: 50px;" >
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="gw_form_bottom_table  mt_10">
        <tr>
            <td width="15%" class="title">我的意见：</td>
            <td width="85%">
                <table>
                    <tr>
                        <td rowspan="2" width="90%">
                                <textarea name="textarea" id="idea" cols="45" rows="3" placeholder="意见最多填写200字"
                                          class="form_textarea" style="width: 100%;" onkeyup="this.value = this.value.substring(0,200)"></textarea>
                            <span id="idea-count" name="idea-count" value="">0</span>/200
                        </td>
                        <td  width="10%">
                            <select class="btn btn-default" name="CuOpinion" id="CuOpinion" onchange="onSelect(this.value,'idea')"></select>
                        </td>
                    </tr>
                    <tr>
                        <td >
                            <a class="white" href="#" onclick="add('idea')">+添加常用意见</a></td>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>
<!--意见信息end-->
<div class="gw_form_right_btn_area" style=" right: 20px; top: 20px; position: fixed;">
    <ul>
        <li><a href="#" onclick="openLayer('1')"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> 流程记录</a></li>
        <li><a href="#" onclick="openLayer('2')"><span class="glyphicon glyphicon-random" aria-hidden="true"></span> 流程图</a></li>
        <li><a href="#" onclick="openLayer('3')"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> 意见信息</a></li>
    </ul>
</div>

<div class="form_btn_area" style="text-align: center;">
    <button class="btn btn-primary form_btn_area_btn2" onclick="MyLayer.closeOpen()"><span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span> 关闭</button>
    <button id="print" class="btn btn-primary form_btn_area_btn2" style="display: none"  onclick="print()"><span class="glyphicon glyphicon-print" aria-hidden="true"></span> 打印</button>
    <button id="save" class="btn btn-primary form_btn_area_btn2"style="display: none" onclick="commitForm();" ><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> 保存</button>
    <button id="subflow" class="btn btn-primary form_btn_area_btn2"style="display: none" onclick="commitFlow();" ><span class="glyphicon glyphicon-send" aria-hidden="true"></span> 发送</button>
    <button id="approval" class="btn btn-primary form_btn_area_btn2" style="display: none" onclick="completeFlow('',Config.approvalflag)" ><span class="glyphicon glyphicon-ok" aria-hidden="true"></span> 通过</button>
    <button id="noApproval" class="btn btn-primary form_btn_area_btn2" style="display: none" onclick="completeFlow('',Config.noApprovalflag);" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 不通过</button>
    <button id="remove" class="btn btn-primary form_btn_area_btn2" style="display: none" onclick="removeFlow()"  ><span class="glyphicon glyphicon-ban-circle" aria-hidden="true"></span> 撤办</button>
    <button id="resumeFlow" class="btn btn-primary form_btn_area_btn2" style="display: none" onclick="resumeFlow()" ><span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> 重新启用</button>
    <button id="takeBack" class="btn btn-primary form_btn_area_btn2" style="display: none" onclick="takeBack()" ><span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> 收回重办</button>
</div>




</body>

<script>
    //解绑事件-防止事件叠加
    $(".applyPermEvent").off();
    $(document).off(".applyPerm");

    //流程相关数据
    var fileTypeId = "a72698d4b3ae47f4a3591252c843c36c";
    var workFlowId = "a72698d4b3ae47f4a3591252c843c36c";
    var theRequest ={};
    theRequest=hp.analyticParam(location.search);
    $("#resId").val(theRequest.resId);//资源id;无removeFlow对应方法?
    $("#id").val(hp.falseToe(theRequest.id));
    $("#workitemid").val(theRequest.workItemId);//无此值表是草稿状态,即流程状态为0!!!
    $("#opertation").val(theRequest.oper);
    //流程相关数据
    $("#filetypeid").val(fileTypeId);
    $("#workflowid").val(workFlowId);
    //业务数据
    var sqqx={//申请权限;0:职能部门审核;1:自行审核
        key:0,
        value:"职能部门审核"
    };

    /**
     * 提交表单
     * @returns
     */
    function commitForm() {
        var flag = saveForm();
        if (flag && flag == "1") {
            layer.msg("保存成功！", { icon: 1 });
            //刷新列表
            parent.TableInit.refTable('right_table');
        } else {
            layer.msg("保存失败！", { icon: 2 });
        }
    }
    /**
     * 保存
     */
    function saveForm() {
        var res = "";
        if (!$("#id").val()) {
            $("#subflag").val(Config.startflag);//赋值为0,即流程状态:草稿状态
        }
        var entity={}
        entity.id= $("#id").val();
        entity[subflagI]= $("#subflag").val();
        //其它数据保存
        /*$("").each(function(index,element){
            entity[key]=value;
        });*/
        $.ajax({
            type: "POST",
            url: "/testPageController/returnEmpty",
            data: entity,
            async: false,
            success: function (json) {
                if (json.flag == '1') {
                    res = json.flag;
                    $("#id").val(json.data.id);//数据在业务表的id
                    $("#subflag").val(json.data[subflagI]);//当前流程值

                }
            },
            error: function () {
            }
        });
        //保存临时意见
        var tempIdea = $("#idea").val();
        saveIdeaTemp($("#workitemid").val(), tempIdea);
        return res;
    }
    /**
     * 提交流程
     */
    function commitFlow() {
        var flag = saveForm();
        if (flag&& flag == "1") {
            var oper = "";
            if (!$("#workitemid").val()) {
                oper = "NEW";
            } else {
                oper = "EDIT";
            }
            //获取意见
            var idea = $("#idea").val();
            var IsNotionShow = document.getElementById("ideaArea").style.display;
            if (IsNotionShow == "block") {
                if ("2" == document.getElementById("fillmode").value) {
                    if (!idea) {
                        layer.msg("请填写意见！", { icon: 0 })
                        return false;
                    }
                }
            }
            submitToFlow(oper, this, getcookie("usernm")+"发起的"+zzsYear+"年度职责书", idea, $("#id").val(), "attr", "attr1", $("#workitemid").val(), $("#workflowid").val());
        } else {
            layer.msg("数据保存失败！", { icon: 2 });
        }
    }
    /**
     *  工作流回调该方法，用于改变业务数据状态,要为全局方法
     * @param subflag 状态位
     * @returns
     */
    function updateBusiData(subflag) {
        var logo="2"
        if(subflagI=="subflag"){
            logo="1";
        }
        $.ajax({
            type: "POST",
            url: "/djglPostManagementController/updateBySubflag",
            data: {
                id: $("#id").val(),
                value: subflag,
                logo:logo
            },
            async: false,
            success: function (data) {
                //刷新列表
                parent.TableInit.refTable('right_table');
            },
            error: function () {
            }
        });
    }


    (function(){
        //领导审批时,页面加载全部数据
        function editALL() {
            $("#applyPerm_sqqx").text(sqqx.value);

        }
        //二级处审批,页面只加载对应处的
        function editChu(){
            $("#applyPerm_sqqx").text(sqqx.value);
        }
        //起草,页面加载时处理
        function editDraft(){
            $("#applyPerm_sqqx").text(sqqx.value);
            initData();
        }
        function init() {
            //初始化页面，数据加载、渲染
            if ($("#id").val()){//非新建数据进行起草
                //业务的表数据渲染加载
                //edit('/djglPostManagementController/edit');
                //流程相关（按钮、控件等）的渲染
                if ($("#workitemid").val()) {
                    if(true){//如果是二级审核
                        editChu();
                    }else{//如果是领导审核
                        editALL();
                    }


                    if ($("#opertation").val() == "EDIT") {//流程的修改页面
                        var datas = {
                            workflowid: $("#workflowid").val(),
                            filetypeid: $("#filetypeid").val(),
                            workitemid: $("#workitemid").val(),
                            pkValue: $("#id").val(),
                            userid: getcookie("userid"),
                            deptid: getcookie("deptid"),
                            oper: $("#opertation").val(),
                            ideaArea: $("ideaArea").val()
                        };
                        DisplayData.playWorkFlow("/flowService/getFlowData", datas, $("#opertation").val(), callback);
                        $("#save,#remove,#resumeFlow,#takeBack").hide();
                    } else {//oper='VIEW'   //流程的只读页面
                        var datas = {
                            type: "1",
                            oper: $("#opertation").val(),
                            workitemid: $("#workitemid").val()
                        };
                        DisplayData.playWorkFlow("/workflow/getYiBanData", datas, $("#opertation").val());
                        $(".formpage_idea").hide();
                    }
                } else {//非流程，可修改草稿状态数据(数据库是有这条数据的状态为0)，加载启动节点按钮及启动节点提示信息
                    editALL();
                    if ($("#opertation").val() == "EDIT") {//修改页面
                        getStartWf();
                        //起点流程默认开启流程图里的按钮,有保存和发送
                        $("#approval,#noApproval,#remove,#resumeFlow,#takeBack").remove();
                    }else {//oper='VIEW'   //只读页面
                        $(".formpage_idea").hide();
                    }
                }
            }else{//是'起草'即数据库新建数据
                getStartWf();//id为空时，表示新建草稿状态，加载启动节点按钮及启动节点提示信息
                editDraft();
                //起点流程默认开启流程图里的按钮,有保存和发送
                $("#approval,#noApproval,#remove,#resumeFlow,#takeBack").remove();
            }
        }
        if(!$("#id").val()){
            layer.open({
                type: 1
                ,title: false //不显示标题栏
                ,closeBtn: false
                ,area: '300px;'
                ,shade: 0.8
                ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                ,btn: ['关闭']
                ,btnAlign: 'c'
                ,moveType: 1 //拖拽模式，0或者1
                ,content:"<div style=\"padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight:400;\">" +
                "                            <label style=\"line-height: 1.42857143;\"  class=\"radio-inline\">\n" +
                "                                <input checked=\"checked\" type=\"radio\" name=\"sqqx\" value=\"0\" onclick=\"var valll=$(this).attr('value');sqqx.key=valll;sqqx.value=$.trim($(this).parent().text());\">职能部门审核\n" +
                "                            </label>\n" +
                "                            <label style=\"line-height: 1.42857143;\"  class=\"radio-inline\">\n" +
                "                                <input type=\"radio\" name=\"sqqx\" onclick=\"var valll=$(this).attr('value');sqqx.key=valll;sqqx.value=$.trim($(this).parent().text());\" value=\"1\">自行审核\n" +
                "                            </label>\n" +
                "</div>"
                ,success: function(layero){
                }
            });
            //关闭点击
            $(document).on('click.applyPerm', '.layui-layer-btn0', function() {
                setTimeout(function(){init();},300);
            });
        }else{
            init();
        }


        //-------------------下都是起草代码----------------------------

        function initData(){//起草时初始数据
            var proposer=getcookie("usernm"); //当前用户名称
            var office=getcookie("chuShiName");//所在处
            $("#applyPerm_proposer").val(proposer);
            $("#applyPerm_office").val(office);

        }

        //所弹出框树选择后,点确定按钮的回调
        function yes(){
            var treeObj = $.fn.zTree.getZTreeObj("tree-obj");
            var nodes = treeObj.getCheckedNodes(true);
            //console.log(JSON.stringify(nodes));
            var dataStructure=[];
            for (var i = 0; i < nodes.length; i++){
                var nodeMap=nodes[i];
                var level=nodeMap.level;
                if(level==0){
                    var officeMap={};
                    officeMap.officeid=nodeMap.data_office_id;//处室id
                    officeMap.officename=nodeMap.name;//处室中文名称
                    var auditorList=nodeMap.data_secondary_auditor;//审核人集合
                    officeMap.verifier=[];//审核人
                    if(!auditorList){
                        auditorList=[];
                    }
                    for (var ii = 0; ii < auditorList.length; ii++){
                        var auditormap=auditorList[ii];
                        $.each(auditormap,function(mapkey,mapvalue){
                            var audmap={};
                            audmap.auditorid=mapkey;
                            audmap.auditorname=mapvalue;
                            officeMap.verifier.push(audmap)
                        });
                    }
                    officeMap.functional=[];//职能
                    dataStructure.push(officeMap);
                    //debugger;
                }else if(level==1){
                    var functionalname=nodeMap.name;
                    var functionalmap={};
                    functionalmap.functionalname=functionalname;
                    functionalmap.roles=[];
                    dataStructure[dataStructure.length-1].functional.push(functionalmap);
                    //debugger;
                }else if(level==2){
                    var rolesmap={};
                    rolesmap.rolesid=nodeMap.value;
                    rolesmap.rolesname=nodeMap.name;
                    var functional=dataStructure[dataStructure.length-1].functional;
                    functional[functional.length-1].roles.push(rolesmap);
                    //debugger;
                }
            }
            //console.log(dataStructure);
            var strhtml="";
            for (var i = 0; i < dataStructure.length; i++){
                var officeMap=dataStructure[i];
                //console.log(officeMap);
                strhtml+=" <table data-chushi=\""+officeMap.officeid+"\" class=\"table table-condensed table-hover table-bordered applyPerm_table\">\n" +
                            "\t<thead>\n" +
                            "\t\t<tr  style=\"background: #d2d2d2;\">\n" +
                            "\t\t\t<th  colspan=\"2\" style=\"width: 5em;\">"+officeMap.officename+"</th>\n" +
                            "\t\t</tr>\n" +
                            "\t</thead>";

                strhtml+="<tbody>\n" +
                        "\t\t<tr>\n" +
                        "\t\t\t<th>审核人</th>\n" +
                        "\t\t\t<td>\n"  ;

                var verifierlist=officeMap.verifier;
                for (var ii = 0; ii < verifierlist.length; ii++){//审核人
                    var verifiersmap=verifierlist[ii];
                    strhtml+="<label style=\"line-height: 1.42857143; margin-left: 15px;\"  class=\"radio-inline\">\n" +
                        "\t\t\t\t\t<input type=\"radio\" name=\""+officeMap.officeid+"\" value=\""+verifiersmap.auditorid+"\">"+verifiersmap.auditorname+"\n" +
                        "\t\t\t\t</label>";
                }
                strhtml+="\t\t\t</td>\n" +
                        "\t\t</tr>\n" +
                        "\t</tbody>";
                var functionallist=officeMap.functional;//职能
                strhtml+="<tfoot>";
                for (var ii = 0; ii < functionallist.length; ii++){
                    var functionalmap=functionallist[ii];
                    strhtml+="\t\t<tr>\n" +
                            "\t\t\t<th style=\"width: 8em;\">"+functionalmap.functionalname+"</th>\n" +
                            "\t\t\t<td>\n" ;
                    var roleslist=functionalmap.roles;
                    for (var iii = 0; iii < roleslist.length; iii++){
                        var rolesmap=roleslist[iii];
                        strhtml+="<span class=\"col-md-2 col-xs-3 applyPerm_role\" data-role-id=\""+rolesmap.rolesid+"\">"+rolesmap.rolesname+"</span>";
                    }
                    strhtml+="\t\t\t</td>\n" +
                            "\t\t</tr>\n";
                }
                strhtml+="</tfoot>";
            }
            $("#applyPerm_table").html(strhtml);
        }

        //起草页面管理业务角色按钮点击 //或为$(document).on('click.dyReg', '#applyPerm_managerial_roles', function() {
        $("#applyPerm_managerial_roles").on("click",function() {
            layer.open({
                type: 1	//非iframe;2是iframe,content要为地址
                ,title: false //不显示标题栏
                ,closeBtn: false	//右上角是否需要叉
                ,area: '300px;'//设宽;高度-auto
                ,shade: 0.8
                ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                ,btn: ['确定', '取消']
                ,yes: function(index,layero){
                    yes();
                    layer.close(index);
                }
                ,btnAlign: 'c'
                ,moveType: 1 //拖拽模式，0或者1(我是没看出区别)
                ,content: '' +
                '   <div style="padding: 50px; line-height: 22px; background-color: #efefef; color: #fff; font-weight:400;">'+
                '      <ul id="tree-obj" class="ztree"></ul>' +
                '' +
                '   </div>'
                ,success: function(layero){//加载完成后执行的js
                    createTree();
                }
            });
        });
        //起草页面管理业务角色按钮点击后,树生成的js
        function createTree(){
            var roleIDs=[];
            $("#applyPerm_table .applyPerm_role ").each(function(index,element){
                roleIDs.push($(element).attr("data-role-id"));
            });
            initTree(roleIDs);
        }
        function initTree(roleIDs) {//初始化树
            debugger;
            $.ajax({
                'url' : '/testPageController/returnEmpty',//最好带/,表是绝对路径
                'type':'POST',
                'dataType':'json',
                'data' : {
                    //条件
                }
            }).done(function( data, textStatus, jqXHR ) {
                if(!data){data=[];}

                var zTreeNodes =[
                    { name:"处1",data_office_id:"处id",data_secondary_auditor: [{"二级审核人id":"二级审核人1的姓名"}],
                        children: [
                            { name:"职能1 ",
                                children: [
                                    { name:"业务角色1",value:"业务角色111"},//若子节点
                                    { name:"业务角色2",value:"业务角色112"},
                                    { name:"业务角色3",value:"业务角色113"},
                                    { name:"业务角色4",value:"业务角色114"}
                                ]},
                            { name:"职能2",
                                children: [
                                    { name:"业务角色121",value:"业务角色121"},
                                    { name:"业务角色122",value:"业务角色122"},
                                    { name:"业务角色123",value:"业务角色123"},
                                    { name:"业务角色124",value:"业务角色124"}
                                ]
                            }
                        ]},
                    { name:"处2",data_office_id:"处2id",data_secondary_auditor: [{"二级审核人2id":"二级审核人2的姓名"}],
                        children: [
                            { name:"职能21",
                                children: [
                                    { name:"业务角色211",value:"业务角色211"},
                                    { name:"业务角色212",value:"业务角色212"},
                                    { name:"业务角色213",value:"业务角色213"},
                                    { name:"业务角色214",value:"业务角色214"}
                                ]
                            }
                        ]
                    }

                ];
                $(zTreeNodes).each(function(index,item){//设自定义图标
                    item.iconSkin="diyicon";
                });
                var setting = {
                    callback:{//回调
                        //onClick:onclick_tree //  function onclick_tree(event, treeId, treeNode) {}
                    }
                    ,check: {
                        enable: true //true / false(默认) 分别表示 显示 / 不显示 复选框或单选框
                    }
                }
                var treeObj =$.fn.zTree.init($("#tree-obj"), setting, zTreeNodes);//或 var treeObj =$.fn.zTree.getZTreeObj("tree-obj");
                for (var i=0, l=roleIDs.length; i < l; i++) {
                    var node = treeObj.getNodeByParam("value", roleIDs[i]);
                    treeObj.checkNode(node, true, true);
                }


            }).fail(function( jqXHR, textStatus, errorThrown ) {
                console.log("错误异常:"+errorThrown);
            }).always(function( dataJqXHR, textStatus, jqXHRErrorThrown ) {//参数名可任意
                //console.log("总是执行");
            });


        }








    })();
</script>

</html>