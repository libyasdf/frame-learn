<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">

    <title></title>
        <link rel="stylesheet" type="text/css" href="/static/css/common/Loading.css">
    <link rel="stylesheet" href="/static/core/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/static/core/bootstrapvalidator/dist/css/bootstrapValidator.min.css"/>
    <link rel="stylesheet" href="/static/core/jquery-fileupload/css/jquery.fileupload.css">
     <link href="/static/core/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="/static/core/bootstrap-table/bootstrap-table.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/static/font/iconfont.css">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link href="/static/core/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/core/layer/theme/default/layer.css">
    <link rel="stylesheet" href="/static/css/gateway/reset.css">
    <link rel="stylesheet" href="/static/font/iconfont-gateway/iconfont.css">

    <!-- style.css -->
    <link href="/static/css/common/style.css" rel="stylesheet">
    <link href="/static/css/common/form-public.css" rel="stylesheet">
    <link href="/static/css/common/index.css" rel="stylesheet">

    <!-- 滚动条 -->
    <link rel="stylesheet" href="/static/core/mCustomScrollbar/jquery.mCustomScrollbar.css">

    <!-- 获取url -->
    <script src="/static/js/common/url.js" type="text/javascript"></script>

    <!-- 开关配置 -->
    <link rel="stylesheet" type="text/css" href="/modules/system/config/toggle/css/toggleStyle.css">
    <link href="/static/core/font-awesome-4.7.0/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <link href="/static/core/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
		#table_list tr {
		 	text-align:center
		}
    	.control-span {
    		padding-top: 7px;
    		margin-bottom: 0;
    		float: left;
    	}
    	.line-span{ white-space:pre-wrap;word-wrap : break-word ;overflow: hidden ;text-align:left}
	</style>
</head>

<body class="formpage_bj">
    <form class="form-horizontal" id="form">
        <!-- resId -->
        <input name="resId" id="resId" type="hidden" value="">
        <!-- 流程字段-->
        <input name="id" id="id" type="hidden" value="" /><!-- 工作项ID -->
        <input name="status" id="status" type="hidden" value="" />
        <input name="title" id="title1" type="hidden" value="" />
        <input name="classId" id="classId"  value="" type="hidden"/>
        <!-- 套餐激活状态的门类id -->
        <input name="classId1" id="classId1"  value="" type="hidden"/>
        <!-- 流程字段结束 -->
        <div class="container-fluid formpage_area" style="margin-bottom: 140px">
            <!-- 基本信息 -->
            <div class="row">
                <div class="col-md-12 ">
                    <div class="block_title">
                        <span class="name">基本信息</span>
                    </div>
                </div>
            </div>
            <div class="row m-t-15">
                <div class="col-md-12">
                    <div class="form-group">
                        <div class="rowGroup">
                            <label for="" class="col-md-2 control-label"> 主题：</label>
                            <div class="col-md-10 form-view">
                                <span id="title" ></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                    	<div class="rowGroup">
                            <label for="" class="col-md-2 control-label"> 最晚下单时间：</label>
                            <div class="col-md-4 form-view" >
                               <span name="deadlineTime" ></span>
                            </div>
                        </div>
                        <div class="rowGroup">
                            <label for="" class="col-md-2 control-label"> 取餐时间：</label>
                            <div class="col-md-4 form-view" >
                                 <span name="takeFoodTime" ></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="rowGroup">
                            <label for="" class="col-md-2 control-label">注意事项：</label>
                            <div class="col-md-10 form-view" >
                                 <span name="attentionItem" class="line-span"></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="rowGroup">
                            <label for="" class="col-md-2 control-label">备注：</label>
                            <div class="col-md-10 form-view">
                                  <span name="mark" class="line-span"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 基本信息结束 -->
            <!-- 商品信息开始 -->
            <div class="row">
				<div class="col-md-12 ">
					<div class="block_title">
                        <span class="name">商品信息</span>
                    </div>
				</div>
			</div>
			<div class="modal-body selectjs">
			<div class="selectjs_block" style="height: auto;">
				<div class="title_tab">
                	<ul class="nav nav-tabs" id="category">
					</ul>
				</div>
				<div class="main" style="height: auto;">
					<!--tab的主体部分-->
					<div id="formpage1" class="active">
						<div class="row m-t-15">
							<div class="col-md-12">
								<table id="right_table" data-use-row-attr-func="true" data-reorderable-rows="true" ></table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 商品信息结束 -->
		
		<!-- 套餐信息开始 -->
	     <div class="row">
               <div class="col-md-12 ">
                   <div class="block_title">
                       <span class="name">套餐组合</span>
                   </div>
               </div>
           </div>
           <div class="modal-body selectjs">
			<div class="selectjs_block" style="height: auto;">
				<div class="title_tab">
					<ul class="nav nav-tabs" id="category1">
					</ul>
				</div>
				<div class="main" style="height: auto;">
					<div id="formpage2" class="active">
						<div class="row m-t-15">
							<div class="col-md-12">
								<table id="right_table2" data-use-row-attr-func="true" data-reorderable-rows="true" ></table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 套餐信息结束 -->
        </div>
    </form>
    
    <!-- 按钮区开始 -->
    <div class="form_btn_area" style="text-align: center;">
    <button id="preserveBtn" class="btn btn-primary form_btn_area_btn2" onclick="MyLayer.closeOpen();" ><span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>关闭</button>
    </div>
    <!-- 按钮区结束 -->

<script src="/static/core/jquery/jquery-1.11.2.min.js"></script>
<script src="/static/core/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/core/bootstrap-table/bootstrap-table.min.js"></script>
<script src="/static/core/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="/static/core/bootstrapvalidator/dist/js/bootstrapValidator.min.js"></script>
<script src="/static/core/layer/layer.js"></script>
<script src="/static/js/common/mylayer.js"></script>
<script type="text/javascript" src="/static/js/common/assistUtil.js"></script>
<script src="/static/core/bootstrap-table/extensions/editable/bootstrap-table-editable.js"></script>
<script src="/static/core/bootstrap3-editable/js/bootstrap-editable.js"></script>
<script src="/static/core/bootstrap-table/extensions/reorder-rows/bootstrap-table-reorder-rows.js"></script>
<script src="/static/js/common/jquery.tablednd.js"></script>
<script src="/static/core/laydate/laydate.js"></script>
<!-- 流程相关 -->
<script type="text/javascript" src="/common/js/config.js"></script>

<script type="text/javascript" src="/common/js/commonFunction.js"></script>
<script type="text/javascript" src="/common/html/notion/notion.js"></script>
<!-- 获取cookie值 -->
<script type="text/javascript" src="/product/workflow/js/common/getCook.js"></script>
<!-- 页面获取参数 -->
<script type="text/javascript" src="/common/js/getrequest.js"></script>
<!-- 引入自己模块功能的js -->
<!-- 数据渲染 -->
<script src="/static/js/common/displayData.js"></script>

<!--文件上传js-->
<script src="/static/core/jquery-fileupload/js/vendor/jquery.ui.widget.js"></script>
<script src="/static/core/jquery-fileupload/js/jquery.iframe-transport.js"></script>
<script src="/static/js/common/tablelist.js"></script>
<script src="/modules/mypage/wmgl/categorygoods/js/goodsChooseTree.js"></script>
<script type="text/javascript" src="/modules/mypage/wmgl/takeout/js/takeOutValidator.js"></script>
	<script type="text/javascript" src="/modules/mypage/wmgl/takeout/js/takeOutEditForm.js"></script>
    <!--文件上传js end-->
    <script type="text/javascript">
    var curDate = getCurrentDate("yyyy-MM-dd  HH:mm:ss")
    laydate.render({
  	  elem: '#takeFoodTime'
  	  ,type: 'datetime'
  	  ,min: curDate
  	  ,range: true
  	  ,done: function(value, date, endDate){
        	$('#takeFoodTime').val(value).change()
        }
    }
    )
    var minDate = getBeforeDate(curDate,-1);

    laydate.render({
        elem: '#deadlineTime' //指定元素
        ,btns: ['clear', 'confirm']
        ,type: 'datetime'
        ,min: minDate
        ,done: function(value, date, endDate){
        	$('#deadlineTime').val(value).change()
        	
        }
		
    });
    var right_table_col = [
    	
    	{
        field: 'id'
        , title: '序号'
        , width: '5%'
        , align:"center"
        , formatter: function (value, row, index) {
            //计算序号，并存放业务ID，及已办事项ID
            var pageSize=$('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
            var pageNumber=$('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
            var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
            return "<span data-id='"+row.id+"' data-workitemid='"+row.yibanid+"'>"+orderNum+"</span>";    //返回每条的序号： 每页条数 * （当前页 - 1 ）+ 序号
        }
    },{
        field: 'goodsName'
        , title: '商品名称'
        , width: '18%'
        , align:"center"
    },
        {
            field: 'danjia' 
           , title: '商品单价'
           , width: '16%'
           , align:"center"
        	, formatter: function (value, row, index) {
                   return "<span >" + row.goodsPrice + "元/"+ row.valuationUnit + "</span>";
            }
        },
        {
            field: 'goodsNum' 
           , title: '库存量'
           , width: '16%'
           , align:"center"
        	, formatter: function (value, row, index) {
                    if(row.amountLimit && row.amountLimit=='1'){
                    	return "<span >" + value + " "+ row.buyUnit + "</span>";             		
                    }else{
            			return '无限制'
            		}
            }
        }
];
  
    var right_table_col2 = [
       	{
           field: 'id'
           , title: '序号'
           , width: '5%'
           , align:"center"
           , formatter: function (value, row, index) {
               //计算序号，并存放业务ID，及已办事项ID
               var pageSize=$('#right_table').bootstrapTable('getOptions').pageSize;//通过表的#id 可以得到每页多少条
               var pageNumber=$('#right_table').bootstrapTable('getOptions').pageNumber;//通过表的#id 可以得到当前第几页
               var orderNum = pageSize * (pageNumber - 1) + index + 1;//计算序号
               return "<span data-id='"+row.id+"' data-workitemid='"+row.yibanid+"'>"+orderNum+"</span>";    //返回每条的序号： 每页条数 * （当前页 - 1 ）+ 序号
           }
       },{
           field: 'goodsNames'
           , title: '套餐组合'
           , width: '35%'
           , align:"center"
           ,formatter:function(value,row,index){
        	   if(value!=null){
           		var length = value.length
   	  	   	      var val = '';
   	  	   	      if(length>30){
   	  	   	    	  val = value.substring(0,30)+"...";
   	  	   	      }else{
   	  	   	    	  val = value;
   	  	   	      }
     	   	   		return  "<span style='cursor:default' title='"+value+"'>"+val+"</span>";
           		}else{
           			return "-";
           		}
           }
       },{
               field: 'optNum' 
              , title: '购买规则'
              , width: '16%'
              , align:"center"
           	, formatter: function (value, row, index) {
           		var num = row.goodsIds.split(",").length;
           		return  num+ "选" +value;
               }
       }];
       
    var list = {
			deleteFun : function(id) {
				var resId = $('#left_ul').find('a.active').attr("id");
				flag='0'
	            MyLayer.deleteOpt({
	            	url: '/mypage/wmgl/takeout/takeoutDetil/delete?id=' + id + "&resId=" + resId,
	                tableId:'right_table'
	            })
	           
	            
	            
			}
		} 
	
    var selectDate;//日期控件中被选中的日期值
    var hourCnt;//当前时间的小时值
    var dayCnt;//当前时间的天值
     function getBeforeDate(date,n) {
    	        var n = n;
    	        var d = new Date(date.replace(/-/g, '/'));
    	        var year = d.getFullYear();
    	        var mon = d.getMonth() + 1;
    	        var day = d.getDate();
    	        var hours = d.getHours();
    	        hourCnt=parseInt(hours)
    	        dayCnt = parseInt(day)
    	        if(day <= n) {
    	            if(mon > 1) {
    	                mon = mon - 1;
    	            } else {
    	                year = year - 1;
    	                mon = 12;
    	            }
    	        }
    	        d.setDate(d.getDate() - n);
    	        year = d.getFullYear();
    	        mon = d.getMonth() + 1;
    	        day = d.getDate()-1;
    	        s = year + "-" + (mon < 10 ? ('0' + mon) : mon) + "-" + (day < 10 ? ('0' + day) : day)+" " + (hours+1) + ":00:00";
    	        return s;
    	    }
     // 禁用分钟和秒选项
 	function disableTimeSelection(){
 	    // console.log('禁用分钟和秒')
         $('.laydate-time-list').children('li').each(function(index,itemList){
             if(index<=0) {
                 $(this).children('ol').children('li').removeClass('laydate-disabled')
             }
             if(index>0){
                $(this).children('ol').children('li').addClass('laydate-disabled')
             }
         })
 	}
     
   var flag = "0";//用于判断是否重新加载标签页
	 //初始化表格
     TableInit.init({
         domId:"right_table",
         url:"/mypage/wmgl/takeout/takeoutDetil/getDetilByInfoId",
         columns:right_table_col,
         pagination:false,
         queryParams:function(params){
         	params.infoId = $("#id").val();
         	params.classId=$("#classId").val();
             return params;
         },
         rowStyle: function (row, index) {	
             return {
                 classes: 'readOnly'
                 ,css: {"text-align":"center","cursor":"default"}
             };
         },
         readOnlyFn: function (data) {
        	 
        	 if(data.total==0 && flag=='0'){
        		 flag = "1";
        		 loadCategory()
        		 
        	 }
        	 
        	
        },
         onReorderRowsDrag: function (table, row) {
        	
             //当选中行，拖拽时的哪行数据，并且可以获取这行数据的上一行数据和下一行数据
             return false;
         },
         onReorderRowsDrop: function (table, row) {
        	 
             if(row.childNodes.length<=1) return
             //拖拽完成后的这条数据，并且可以获取这行数据的上一行数据和下一行数据
             var tableBs = $(table);
             //选中行的index
             var selectedIndex = row.id.split("_")[1];
             //拖曳结束后，相同位置行的index
             var afterIndex = table.tBodies[0].rows[selectedIndex].id.split("_")[1];
             //alert("排序后相同位置行的index == "+afterIndex);
             //alert("选中行的index == "+selectedIndex);
             /**
              *	选中行的index != 拖曳后相同位置行的index，则说明改变了行顺序，则进行重新排序
              *	例如选中第三行selectedIndex=2，将第三行向上拖动一行，则拖曳后第三行afterIndex将变为原第二行的index=1
              */
             if (selectedIndex != afterIndex) {
                 var ids = [];
                 for (var i = 0; i < table.tBodies[0].rows.length; i++) {
                     var cruRow = $(table.tBodies[0].rows[i]);
                     var recordId = $(cruRow).find("span[data-id]").attr("data-id");
                     ids.push(recordId);
                 }
                 var idStr = ids.join("&id=");
                 $.ajax({
                     type: "post",
                     url: "/mypage/wmgl/takeout/takeoutDetil/sort?id=" + idStr,
                     dataType: "json",
                     success: function (res) {
                         if (res.flag == "1") {
                             layer.msg("排序成功！", { icon: 1 });
                         } else {
                             layer.msg("排序失败！", { icon: 2 });
                         }
                         //刷新列表
                         $(table).bootstrapTable('refresh');
                     },
                     error: function () {
                         layer.msg("排序异常，请刷新重试！", { icon: 2 });
                     }
                 })
             }
             return false;
         },
         onReorderRow: function (newData) {
        	
             //当拖拽结束后，整个表格的数据
             return false;
         }
     });
	 
     function getInitTable2(){
	     TableInit.init({
	         domId:"right_table2",
	         url:"/mypage/wmgl/takeout/setmeal/list",
	         columns:right_table_col2,
	         pagination:true,
	         //height:200,
	         //sortable:false,
	         queryParams:function(params){
	         	params.infoId = $("#id").val();
	         	params.classId=$("#classId1").val();
	            return params;
	         },
	         rowStyle: function (row, index) {	//默认样式：居中，鼠标为手
	                return {
	                    classes: 'readOnly'
	                    ,css: {"text-align":"center","cursor":"default"}
	                };
            },
	         readOnlyFn: function (data) {
	        }
	        
	     });
		 
	 }
	
    </script>
</body>

</html>